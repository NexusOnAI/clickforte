<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gastos por Categoria • Google Sheets</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
        extend: {
          colors: {
            surface: '#ffffff',
            primary: { // Paleta de Azul
              50: '#e7f5ff',
              100: '#d0ebff',
              200: '#a5d8ff',
              300: '#74c0fc',
              400: '#4dabf7', // Usado como cor de destaque principal
              500: '#339af0',
              600: '#228be6',
              700: '#1c7ed6',
              800: '#1971c2',
              900: '#1864ab'
            },
            slate: {
              50: '#f8f9fa',  100: '#f1f3f5', 200: '#e9ecef',
              300: '#dee2e6', 400: '#ced4da', 500: '#adb5bd',
              600: '#868e96', 700: '#495057', 800: '#343a40', 900: '#212529'
            },
            gray: { 50: '#f8f9fa', 100: '#f1f3f5', 200: '#e9ecef' } // Renomeado de slate para gray para consistência com Tailwind
          },
          boxShadow: { glow: '0 0 10px rgba(77, 171, 247, 0.3)' }, // Usando o primary-400 para o glow
          backdropBlur: { xs: '2px' }
        }
      }
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.46.0"></script>

  <style>
    @keyframes spin { to { transform: rotate(360deg) } }
    .animate-spin { animation: spin 1s linear infinite }
    html, body { height: 100%; }
    body { background: #f8f9fa; /* gray-50 */ display: flex; flex-direction: column; }
    main { flex-grow: 1; display: flex; flex-direction: column; }
    ::-webkit-scrollbar { width: 6px; height: 6px }
    ::-webkit-scrollbar-thumb { background: #adb5bd; /* slate-500 */ border-radius: 3px }
    ::-webkit-scrollbar-track { background: #e9ecef; /* slate-200 */ }
    .chart-card { transition: background-color 0.3s ease; }
    /* Foco com azul primário (primary-400) */
    button:focus-visible, select:focus-visible { outline: 2px solid #4dabf7; outline-offset: 2px; }
    .refresh-icon { display: inline-block; }
    .apexcharts-legend-text { color: #495057 !important; /* slate-700 */ }
    .apexcharts-tooltip-title, .apexcharts-tooltip-text { color: #212529 !important; /* slate-900 */ }
  </style>
</head>
<body class="text-slate-700 min-h-screen flex flex-col antialiased">

  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="icon-refresh" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 011-1zm10 10a1 1 0 01-1-1V9.899a7.002 7.002 0 01-11.601-2.566 1 1 0 111.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 01-1 1z" clip-rule="evenodd" />
    </symbol>
  </svg>

  <header class="w-full backdrop-blur-sm bg-surface/95 border-b border-primary-400/30 sticky top-0 z-40 flex-shrink-0 shadow-sm">
    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-2.5 flex flex-col">
        <div class="flex justify-between items-center w-full">
            <h1 class="text-base sm:text-lg font-semibold text-primary-600 truncate pr-2">Gastos por Categoria</h1>
            <button id="manual-refresh"
                    class="inline-flex items-center gap-2 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg border border-primary-500 bg-primary-500/10 hover:bg-primary-500/20
                           text-primary-600 text-xs sm:text-sm font-medium shadow-glow flex-shrink-0 disabled:opacity-70 disabled:cursor-not-allowed">
                <svg class="refresh-icon w-4 h-4" aria-hidden="true"><use xlink:href="#icon-refresh"></use></svg>
                <span>Atualizar</span>
            </button>
        </div>
        <div class="flex justify-between items-center w-full mt-1.5">
            <span id="total-expenses-header" class="text-primary-500 font-medium text-xs sm:text-sm truncate pr-2">Carregando total...</span>
            <span id="last-update" class="text-slate-500 text-xs flex-shrink-0">Carregando...</span>
        </div>
    </div>
  </header>

  <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-50/80 backdrop-blur-sm">
    <div class="h-10 w-10 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="text-primary-600 text-base font-medium">Carregando dados...</p>
  </div>

  <main id="main-content" class="w-full max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex flex-col gap-6 flex-grow items-center">
    <div id="error-message"
         class="hidden w-full max-w-2xl p-4 text-center text-red-700 bg-red-100 border border-red-300 rounded-lg text-sm flex-shrink-0"></div>

    <section id="category-chart-section" class="w-full max-w-2xl flex-grow flex flex-col items-center">
      <div class="chart-card bg-surface rounded-xl shadow-lg ring-1 ring-primary-400/20 p-4 sm:p-6 w-full">
        <h2 class="text-lg font-semibold mb-4 text-primary-600 text-center">Distribuição de Gastos por Categoria</h2>
        <div id="chart-categories" class="min-h-[300px] sm:min-h-[400px]"></div>
      </div>
    </section>
  </main>

  <script>
    const sheetId = '1du2FRGYbmY1mQ_mbNN1HuvQc8QhY3Bqq'; // Mantenha o ID da sua planilha
    const gid     = '0'; // Mantenha o GID da sua aba
    const baseURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
    const REFRESH_INTERVAL = 60000; // 1 minuto
    const CURRENCY_FORMAT_CONFIG = { style: 'currency', currency: 'BRL', maximumFractionDigits: 2 };
    // Paleta de cores para o gráfico de categorias (pode expandir se tiver muitas categorias)
    const CATEGORY_CHART_COLORS = ['#339af0', '#20c997', '#ff922b', '#f06595', '#845ef7', '#5c940d', '#0ca678', '#e67700', '#c2255c', '#5f3dc4'];

    let headersFull = [], sheetRows = [];
    let categoryChart;
    let isLoaded = false, isFetching = false;
    let prevCategoryData = null;

    const $loader = document.getElementById('loader');
    const $errorMsg = document.getElementById('error-message');
    const $categoryChartDiv = document.getElementById('chart-categories');
    const $lastUpdate = document.getElementById('last-update');
    const $totalExpensesHeader = document.getElementById('total-expenses-header');
    const $manualRefreshBtn = document.getElementById('manual-refresh');
    const $refreshIcon = $manualRefreshBtn?.querySelector('.refresh-icon');
    const $refreshBtnText = $manualRefreshBtn?.querySelector('span');

    if ($manualRefreshBtn) $manualRefreshBtn.onclick = loadData;

    async function fetchSheetData() {
      const response = await fetch(`${baseURL}&_=${Date.now()}`);
      if (!response.ok) throw new Error(`Erro HTTP ${response.status} ao buscar dados.`);
      const text = await response.text();
      if (!text.startsWith('/*O_o*/\ngoogle.visualization.Query.setResponse(')) {
        console.error("Resposta inválida do Google Sheets:", text.substring(0, 500));
        throw new Error('Formato de resposta inválido da API do Google Sheets.');
      }
      try {
        return JSON.parse(text.substring(47, text.length - 2));
      } catch (e) {
        console.error("Falha ao analisar JSON:", e, "Texto recebido:", text.substring(0, 1000));
        throw new Error('Falha ao processar os dados recebidos da planilha.');
      }
    }

    const formatCurrency = value => (typeof value === 'number' && !isNaN(value)) ? value.toLocaleString('pt-BR', CURRENCY_FORMAT_CONFIG) : '–';

    async function loadData() {
      if (isFetching) return;
      isFetching = true;
      $errorMsg.classList.add('hidden');
      if ($manualRefreshBtn) $manualRefreshBtn.disabled = true;
      if ($refreshIcon) $refreshIcon.classList.add('animate-spin');
      if ($refreshBtnText) $refreshBtnText.textContent = 'Atualizando...';
      if (!isLoaded) $loader.classList.remove('hidden');

      try {
        const jsonData = await fetchSheetData();
        if (!jsonData?.table?.cols || !jsonData?.table?.rows) {
          throw new Error("Estrutura de dados da planilha é inválida ou vazia.");
        }
        headersFull = jsonData.table.cols.map(col => col.label?.trim() || `Col${col.id}`);
        sheetRows = jsonData.table.rows.map(row => {
          const cells = Array(headersFull.length).fill(null);
          row?.c?.forEach((cell, i) => {
            if (i < headersFull.length) cells[i] = cell?.v ?? null;
          });
          return cells;
        });

        if (!isLoaded) {
          buildInitialUI();
          isLoaded = true;
        } else {
          updateUI();
        }
        $lastUpdate.textContent = `Atualizado: ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
      } catch (error) {
        console.error("Erro detalhado ao carregar dados:", error);
        $errorMsg.textContent = `Erro: ${error.message}`;
        $errorMsg.classList.remove('hidden');
        if (!isLoaded) $categoryChartDiv.innerHTML = '<p class="text-center text-slate-500 py-10">Não foi possível carregar o gráfico.</p>';
      } finally {
        isFetching = false;
        $loader.classList.add('hidden');
        if ($manualRefreshBtn) $manualRefreshBtn.disabled = false;
        if ($refreshIcon) $refreshIcon.classList.remove('animate-spin');
        if ($refreshBtnText) $refreshBtnText.textContent = 'Atualizar';
      }
    }
    loadData();
    setInterval(loadData, REFRESH_INTERVAL);

    function hasDataChanged(newData, prevData) {
        if (!prevData) return true;
        return JSON.stringify(newData.labels) !== JSON.stringify(prevData.labels) || JSON.stringify(newData.totals) !== JSON.stringify(prevData.totals);
    }

    function aggregateByCategory() {
      const categoryIdx = headersFull.findIndex(h => h && /categoria/i.test(h.toLowerCase()));
      const valueIdx = headersFull.findIndex(h => h && /valor/i.test(h.toLowerCase()) && !/nf/i.test(h.toLowerCase()));

      if (categoryIdx === -1) {
        console.warn("Coluna 'Categoria' não encontrada.");
        throw new Error("A coluna 'Categoria' é necessária e não foi encontrada na planilha.");
      }
      if (valueIdx === -1) {
        console.warn("Coluna 'Valor' não encontrada.");
        throw new Error("A coluna 'Valor' é necessária e não foi encontrada na planilha.");
      }

      const categoryMap = new Map();
      sheetRows.forEach(row => {
        const category = row[categoryIdx] ? String(row[categoryIdx]).trim() : "Sem Categoria";
        let rawValue = row[valueIdx];
        let value = NaN;

        if (rawValue == null) return;
        if (typeof rawValue === 'number') {
          value = rawValue;
        } else if (typeof rawValue === 'string') {
          const cleaned = rawValue.replace(/[R$\s.]/g, '').replace(',', '.');
          value = parseFloat(cleaned);
        }

        if (!isNaN(value)) {
          categoryMap.set(category, (categoryMap.get(category) || 0) + value);
        }
      });

      const sortedEntries = [...categoryMap.entries()].sort((a, b) => b[1] - a[1]); // Sort by value descending

      return {
        labels: sortedEntries.map(entry => entry[0]),
        totals: sortedEntries.map(entry => parseFloat(entry[1].toFixed(2)))
      };
    }
    
    const baseChartOptions = {
        chart: {
            foreColor: '#495057', // slate-700
            toolbar: { show: true, tools: { download: true, selection: false, zoom: false, zoomin: false, zoomout: false, pan: false, reset: false } },
            animations: { enabled: true, easing: 'easeinout', speed: 600 },
            background: 'transparent'
        },
        tooltip: {
            theme: 'light',
            style: { fontSize: '12px', fontFamily: 'Inter, sans-serif' },
            y: { formatter: (val) => formatCurrency(val) }
        },
        dataLabels: { enabled: true, style: { fontSize: '10px', fontFamily: 'Inter, sans-serif', colors: ['#fff']}, formatter: function (val, opts) { return opts.w.globals.seriesNames[opts.seriesIndex] + ": " + val.toFixed(1) + "%" } },
        legend: {
            show: true,
            position: 'bottom',
            horizontalAlign: 'center',
            fontSize: '12px',
            fontFamily: 'Inter, sans-serif',
            fontWeight: 500,
            itemMargin: { horizontal: 8, vertical: 4 },
            labels: { colors: '#495057' }, // slate-700
            formatter: function(seriesName, opts) {
                const value = opts.w.globals.series[opts.seriesIndex];
                return `${seriesName}: ${formatCurrency(value)}`;
            }
        },
        noData: {
            text: 'Sem dados para exibir no gráfico.',
            align: 'center',
            verticalAlign: 'middle',
            style: { color: '#868e96', fontSize: '14px', fontFamily: 'Inter, sans-serif' } // slate-600
        }
    };

    const categoryDonutOptions = {
        ...baseChartOptions,
        chart: {
            ...baseChartOptions.chart,
            type: 'donut',
            height: 400,
        },
        colors: CATEGORY_CHART_COLORS,
        plotOptions: {
            pie: {
                donut: {
                    size: '65%',
                    labels: {
                        show: true,
                        name: { show: false },
                        value: {
                            show: true,
                            fontSize: '18px',
                            fontFamily: 'Inter, sans-serif',
                            fontWeight: 600,
                            color: '#343a40', // slate-800
                            offsetY: 8,
                            formatter: (val) => formatCurrency(parseFloat(val))
                        },
                        total: {
                            show: true,
                            showAlways: true,
                            label: 'Total Gasto',
                            fontSize: '14px',
                            fontFamily: 'Inter, sans-serif',
                            fontWeight: 500,
                            color: '#495057', // slate-700
                            formatter: (w) => {
                                const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                return formatCurrency(total);
                            }
                        }
                    }
                },
                 dataLabels: {
                    offset: -15, // move percentage inside slices
                }
            }
        },
        tooltip: {
            ...baseChartOptions.tooltip,
            y: {
                formatter: function(value, { seriesIndex, dataPointIndex, w }) {
                    const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                    const percentage = total === 0 ? 0 : (value / total * 100);
                    return `${formatCurrency(value)} (${percentage.toFixed(1)}%)`;
                },
                title: { formatter: (seriesName) => seriesName }
            }
        },
        responsive: [{
            breakpoint: 640, // sm
            options: {
                chart: { height: 320 },
                legend: { fontSize: '11px', itemMargin: { horizontal: 5, vertical: 2 } },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '70%',
                            labels: { total: { fontSize: '13px' }, value: { fontSize: '16px' } }
                        }
                    }
                }
            }
        }, {
            breakpoint: 480,
            options: {
                chart: { height: 300 },
                legend: { show: false }, // Hide legend on very small screens
                 dataLabels: { enabled: false }, // Hide data labels on very small screens to avoid clutter
                 plotOptions: {
                    pie: {
                        donut: {
                            labels: {
                                show: true, // Keep total visible
                                total: { offsetY: 0, fontSize: '14px'},
                                value: { show: false } // Hide individual value in center for small screens
                            }
                        }
                    }
                 }
            }
        }]
    };
    
    function destroyChart(chartInstance) {
        if (chartInstance && typeof chartInstance.destroy === 'function') {
            chartInstance.destroy();
        }
        return null;
    }

    function renderCategoryChart(isUpdate = false, data) {
        if (isUpdate && !hasDataChanged(data, prevCategoryData) && categoryChart) {
             // console.log("Category data hasn't changed significantly, skipping full re-render.");
             // Potentially just update series if only values changed but not labels structure
             categoryChart.updateSeries(data.totals, true);
             categoryChart.updateOptions({ labels: data.labels }, false, false);
             return;
        }
        if (!data || data.labels.length === 0) {
            $categoryChartDiv.innerHTML = '<p class="text-center text-slate-500 py-10">Nenhuma categoria encontrada ou sem valores para exibir.</p>';
            categoryChart = destroyChart(categoryChart);
            prevCategoryData = data;
            return;
        }

        const chartOptions = {
            ...categoryDonutOptions,
            series: data.totals,
            labels: data.labels,
        };
        
        if (isUpdate && categoryChart) {
            // console.log("Updating existing category chart.");
            categoryChart.updateOptions(chartOptions, true, true, true);
        } else {
            // console.log("Rendering new category chart.");
            categoryChart = destroyChart(categoryChart);
            $categoryChartDiv.innerHTML = ''; // Clear previous message if any
            categoryChart = new ApexCharts($categoryChartDiv, chartOptions);
            categoryChart.render();
        }
        prevCategoryData = data;
    }

    function updateTotalExpensesHeader(categoryData) {
        const grandTotal = categoryData.totals.reduce((sum, total) => sum + total, 0);
        $totalExpensesHeader.textContent = `Total Geral: ${formatCurrency(grandTotal)}`;
    }

    function buildInitialUI() {
        try {
            const categoryData = aggregateByCategory();
            renderCategoryChart(false, categoryData);
            updateTotalExpensesHeader(categoryData);
        } catch (e) {
            console.error("Erro ao construir UI inicial:", e);
            $errorMsg.textContent = `Erro ao processar dados para gráfico: ${e.message}`;
            $errorMsg.classList.remove('hidden');
            $categoryChartDiv.innerHTML = '<p class="text-center text-slate-500 py-10">Erro ao exibir gráfico de categorias.</p>';
        }
    }

    function updateUI() {
         try {
            const categoryData = aggregateByCategory();
            renderCategoryChart(true, categoryData);
            updateTotalExpensesHeader(categoryData);
        } catch (e) {
            console.error("Erro ao atualizar UI:", e);
            $errorMsg.textContent = `Erro ao atualizar dados do gráfico: ${e.message}`;
            $errorMsg.classList.remove('hidden');
        }
    }

  </script>
</body>
</html>