<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Demonstrativo Financeiro Completo • Google Sheets</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
        extend: {
          colors: {
            surface: '#ffffff',
            'surface-soft': '#f8f9fa', // Um cinza muito claro para fundos sutis
            'surface-medium': '#f1f3f5',

            primary: { // Azul para UI geral e acentos neutros
              50: '#e7f5ff', 100: '#d0ebff', 200: '#a5d8ff', 300: '#74c0fc',
              400: '#4dabf7', 500: '#339af0', 600: '#228be6', 700: '#1c7ed6',
              800: '#1971c2', 900: '#1864ab'
            },
            success: { // Verde para Receitas e indicadores positivos
              50: '#e6fcf5', 100: '#c3fae8', 200: '#96f2d7', 300: '#63e6be',
              400: '#38d9a9', 500: '#20c997', 600: '#12b886', 700: '#0ca678',
              800: '#099268', 900: '#087f52'
            },
            danger: { // Vermelho/Laranja para Despesas e indicadores negativos
              50: '#fff5f5', 100: '#ffe3e3', 200: '#ffc9c9', 300: '#ffa8a8',
              400: '#ff8787', 500: '#ff6b6b', 600: '#fa5252', 700: '#f03e3e',
              800: '#e03131', 900: '#c92a2a'
            },
            warning: { // Amarelo para alertas ou informações neutras
              50: '#fff9db', 100: '#fff3bf', 200: '#ffec99', 300: '#ffe066',
              400: '#ffd43b', 500: '#fcc419', 600: '#fab005', 700: '#f59f00',
              800: '#f08c00', 900: '#e67700'
            },
            slate: { // Tons de cinza para texto e bordas
              50: '#f8f9fa', 100: '#f1f3f5', 200: '#e9ecef', 300: '#dee2e6',
              400: '#ced4da', 500: '#adb5bd', 600: '#868e96', 700: '#495057',
              800: '#343a40', 900: '#212529'
            }
          },
          boxShadow: {
            'md-subtle': '0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03)',
            'lg-subtle': '0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.025)',
            'glow-primary': '0 0 12px rgba(77, 171, 247, 0.35)',
            'glow-success': '0 0 12px rgba(32, 201, 151, 0.35)',
            'glow-danger': '0 0 12px rgba(255, 107, 107, 0.35)',
          },
          backdropBlur: { xs: '2px', sm: '4px' }
        }
      }
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.46.0"></script>

  <style>
    @keyframes spin { to { transform: rotate(360deg) } }
    .animate-spin { animation: spin 1s linear infinite }
    html, body { height: 100%; scroll-behavior: smooth; }
    body { background-color: var(--tw-color-surface-soft); display: flex; flex-direction: column; }
    main { flex-grow: 1; display: flex; flex-direction: column; }
    ::-webkit-scrollbar { width: 8px; height: 8px }
    ::-webkit-scrollbar-thumb { background: var(--tw-color-slate-400); border-radius: 4px }
    ::-webkit-scrollbar-thumb:hover { background: var(--tw-color-slate-500); }
    ::-webkit-scrollbar-track { background: var(--tw-color-slate-200); }
    .chart-card { background-color: var(--tw-color-surface); border-radius: 0.75rem; /* rounded-xl */ box-shadow: var(--tw-shadow-lg-subtle); border: 1px solid var(--tw-color-slate-200); }
    .kpi-card { background-color: var(--tw-color-surface); border-radius: 0.75rem; box-shadow: var(--tw-shadow-md-subtle); border: 1px solid var(--tw-color-slate-200); padding: 1rem; text-align: center; }
    .kpi-value { font-size: 1.5rem; /* text-2xl */ font-weight: 700; /* font-bold */ }
    .kpi-label { font-size: 0.875rem; /* text-sm */ color: var(--tw-color-slate-600); margin-top: 0.25rem; }
    .refresh-icon { display: inline-block; }
    /* Estilos para tooltips e legendas do ApexCharts para garantir consistência */
    .apexcharts-tooltip-title, .apexcharts-tooltip-text, .apexcharts-legend-text { font-family: 'Inter', sans-serif !important; }
    .apexcharts-tooltip.apexcharts-theme-light { background: rgba(255,255,255,0.9) !important; backdrop-filter: blur(4px); border: 1px solid var(--tw-color-slate-200) !important; box-shadow: var(--tw-shadow-lg-subtle) !important; }
    .apexcharts-legend-text { color: var(--tw-color-slate-700) !important; }
    .apexcharts-xcrosshairs, .apexcharts-ycrosshairs { stroke: var(--tw-color-slate-300) !important; }
    .apexcharts-tooltip-marker { margin-right: 6px !important; }

    /* Responsividade para KPIs */
    @media (max-width: 768px) { .kpi-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 480px) { .kpi-grid { grid-template-columns: repeat(1, minmax(0, 1fr)); } .kpi-value {font-size: 1.25rem;} .kpi-label {font-size:0.75rem;} }
  </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col antialiased">

  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="icon-refresh" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 011-1zm10 10a1 1 0 01-1-1V9.899a7.002 7.002 0 01-11.601-2.566 1 1 0 111.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 01-1 1z" clip-rule="evenodd" /></symbol>
    <symbol id="icon-dollar" viewBox="0 0 20 20" fill="currentColor"><path d="M8.433 7.418c.158-.103.358-.168.567-.168h1.346c.596 0 1.061.251 1.367.753.305.502.305 1.209 0 1.711-.306.502-.771.753-1.367.753h-.823v1.745a.75.75 0 01-1.5 0V10H8c-.596 0-1.06-.251-1.367-.753-.305-.502-.305-1.209 0-1.711a2.091 2.091 0 01.202-.118zM10 2a8 8 0 100 16 8 8 0 000-16zm0 1.5a6.5 6.5 0 110 13 6.5 6.5 0 010-13z" /></symbol>
    <symbol id="icon-arrow-up" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 17a.75.75 0 01-.75-.75V5.56l-2.47 2.47a.75.75 0 01-1.06-1.06l3.75-3.75a.75.75 0 011.06 0l3.75 3.75a.75.75 0 11-1.06 1.06L10.75 5.56v10.69a.75.75 0 01-.75.75z" clip-rule="evenodd" /></symbol>
    <symbol id="icon-arrow-down" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v10.69l2.47-2.47a.75.75 0 111.06 1.06l-3.75 3.75a.75.75 0 01-1.06 0L6.72 12.97a.75.75 0 111.06-1.06l2.47 2.47V3.75A.75.75 0 0110 3z" clip-rule="evenodd" /></symbol>
    <symbol id="icon-scale" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.5 2.75A.75.75 0 014.25 2H9a.75.75 0 010 1.5H4.25A.75.75 0 013.5 2.75zm0 4A.75.75 0 014.25 6H6a.75.75 0 010 1.5H4.25A.75.75 0 013.5 6.75zm0 4A.75.75 0 014.25 10H9a.75.75 0 010 1.5H4.25a.75.75 0 01-.75-.75zm12.5-1.5A.75.75 0 0015.25 10H11a.75.75 0 000 1.5h4.25a.75.75 0 00.75-.75zm0-4a.75.75 0 00-.75-.75H14a.75.75 0 000 1.5h1.25a.75.75 0 00.75-.75zm0-4A.75.75 0 0015.25 2H11a.75.75 0 000 1.5h4.25a.75.75 0 00.75-.75zM10 17a1 1 0 01-1-1V4a1 1 0 112 0v12a1 1 0 01-1 1z" clip-rule="evenodd" /></symbol>
  </svg>

  <header class="w-full bg-surface/90 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-40 flex-shrink-0 shadow-sm">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <div class="flex flex-col sm:flex-row justify-between items-center w-full">
            <h1 class="text-xl font-semibold text-primary-600 truncate mb-2 sm:mb-0">Demonstrativo Financeiro Completo</h1>
            <div class="flex items-center gap-3">
                <span id="last-update" class="text-slate-500 text-xs whitespace-nowrap">Carregando...</span>
                <button id="manual-refresh"
                        class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-primary-500 bg-primary-500/10 hover:bg-primary-500/20
                               text-primary-600 text-xs font-medium shadow-glow-primary flex-shrink-0 disabled:opacity-70 disabled:cursor-not-allowed">
                    <svg class="refresh-icon w-4 h-4" aria-hidden="true"><use xlink:href="#icon-refresh"></use></svg>
                    <span>Atualizar</span>
                </button>
            </div>
        </div>
    </div>
  </header>

  <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-surface-soft/80 backdrop-blur-sm">
    <div class="h-12 w-12 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="text-primary-600 text-lg font-medium">Analisando seus dados financeiros...</p>
    <p class="text-slate-500 text-sm mt-1">Isso pode levar alguns segundos.</p>
  </div>

  <main id="main-content" class="w-full max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex-grow">
    <div id="error-message" class="hidden w-full p-4 mb-6 text-center text-danger-700 bg-danger-100 border border-danger-300 rounded-lg text-sm"></div>
    <div id="warning-message" class="hidden w-full p-4 mb-6 text-center text-warning-800 bg-warning-100 border border-warning-300 rounded-lg text-sm"></div>

    <section id="kpi-section" class="mb-8">
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 kpi-grid">
        <div class="kpi-card">
          <div class="flex items-center justify-center text-success-500 mb-2">
            <svg class="w-7 h-7 mr-2" fill="currentColor" viewBox="0 0 20 20"><use xlink:href="#icon-arrow-up"></use></svg>
            <span class="kpi-label">Receita Total</span>
          </div>
          <div id="kpi-total-revenue" class="kpi-value text-success-600">R$ 0,00</div>
        </div>
        <div class="kpi-card">
          <div class="flex items-center justify-center text-danger-500 mb-2">
            <svg class="w-7 h-7 mr-2" fill="currentColor" viewBox="0 0 20 20"><use xlink:href="#icon-arrow-down"></use></svg>
            <span class="kpi-label">Despesa Total</span>
          </div>
          <div id="kpi-total-expense" class="kpi-value text-danger-600">R$ 0,00</div>
        </div>
        <div class="kpi-card">
           <div class="flex items-center justify-center text-primary-500 mb-2">
             <svg class="w-7 h-7 mr-2" fill="currentColor" viewBox="0 0 20 20"><use xlink:href="#icon-scale"></use></svg>
            <span class="kpi-label">Saldo Líquido</span>
          </div>
          <div id="kpi-net-balance" class="kpi-value text-primary-600">R$ 0,00</div>
        </div>
        <div class="kpi-card">
           <div class="flex items-center justify-center text-slate-500 mb-2">
            <svg class="w-7 h-7 mr-2" fill="currentColor" viewBox="0 0 20 20"><use xlink:href="#icon-dollar"></use></svg>
            <span class="kpi-label">Despesas / Receitas</span>
          </div>
          <div id="kpi-expense-ratio" class="kpi-value text-slate-700">0%</div>
        </div>
      </div>
    </section>

    <section id="charts-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="chart-card lg:col-span-2 p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-1 text-slate-700">Fluxo de Caixa Mensal</h2>
        <p class="text-xs text-slate-500 mb-4">Evolução de receitas e despesas ao longo dos meses.</p>
        <div id="chart-monthly-cashflow" class="min-h-[300px] sm:min-h-[350px]"></div>
      </div>

      <div class="chart-card p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-1 text-slate-700">Despesas por Categoria</h2>
        <p class="text-xs text-slate-500 mb-4">Distribuição percentual das suas despesas.</p>
        <div id="chart-expense-categories" class="min-h-[300px] sm:min-h-[350px]"></div>
      </div>

      <div class="chart-card p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-1 text-slate-700">Receitas por Categoria/Fonte</h2>
         <p class="text-xs text-slate-500 mb-4">De onde vêm suas receitas.</p>
        <div id="chart-revenue-categories" class="min-h-[300px] sm:min-h-[350px]"></div>
      </div>
      
      <div class="chart-card lg:col-span-2 p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-1 text-slate-700">Saldo Líquido Mensal</h2>
        <p class="text-xs text-slate-500 mb-4">Resultado financeiro (lucro/prejuízo) de cada mês.</p>
        <div id="chart-monthly-net-balance" class="min-h-[300px] sm:min-h-[350px]"></div>
      </div>
    </section>
    <footer class="text-center text-xs text-slate-400 mt-10 py-4 border-t border-slate-200">
      Demonstrativo Financeiro gerado em <span id="footer-date"></span>.
    </footer>
  </main>

  <script>
    // --- CONFIGURAÇÕES ---
    const SHEET_ID = '1du2FRGYbmY1mQ_mbNN1HuvQc8QhY3Bqq'; // SUBSTITUA PELO ID DA SUA PLANILHA
    const GID = '0'; // SUBSTITUA PELO GID DA ABA CORRETA (geralmente 0 para a primeira aba)
    const BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;
    const REFRESH_INTERVAL = 180000; // 3 minutos
    const CURRENCY_FORMAT_CONFIG = { style: 'currency', currency: 'BRL', maximumFractionDigits: 2 };
    const MONTH_YEAR_FORMAT_CONFIG = { month: 'short', year: 'numeric', timeZone: 'UTC' };
    const DAY_MONTH_YEAR_FORMAT_CONFIG = { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC' };

    // Paletas de cores
    const COLORS_PRIMARY = tailwind.config.theme.extend.colors.primary;
    const COLORS_SUCCESS = tailwind.config.theme.extend.colors.success;
    const COLORS_DANGER = tailwind.config.theme.extend.colors.danger;
    const COLORS_SLATE = tailwind.config.theme.extend.colors.slate;
    const CATEGORY_CHART_PALETTE = [COLORS_PRIMARY[500], COLORS_SUCCESS[500], COLORS_DANGER[500], tailwind.config.theme.extend.colors.warning[500], '#845ef7', '#17a2b8', '#fd7e14', '#6f42c1', '#20c997', '#ff6384'];


    // --- VARIÁVEIS GLOBAIS ---
    let rawSheetData = { headers: [], rows: [] };
    let processedTransactions = [];
    let charts = {};
    let isFetching = false;
    let initialLoadComplete = false;

    // --- DOM ELEMENTS ---
    const $ = (selector) => document.getElementById(selector);
    const $loader = $('loader');
    const $errorMsg = $('error-message');
    const $warningMsg = $('warning-message');
    const $lastUpdate = $('last-update');
    const $manualRefreshBtn = $('manual-refresh');
    const $refreshIcon = $manualRefreshBtn?.querySelector('.refresh-icon');
    // KPIs
    const $kpiTotalRevenue = $('kpi-total-revenue');
    const $kpiTotalExpense = $('kpi-total-expense');
    const $kpiNetBalance = $('kpi-net-balance');
    const $kpiExpenseRatio = $('kpi-expense-ratio');
    // Chart Containers
    const $chartMonthlyCashflow = $('chart-monthly-cashflow');
    const $chartExpenseCategories = $('chart-expense-categories');
    const $chartRevenueCategories = $('chart-revenue-categories');
    const $chartMonthlyNetBalance = $('chart-monthly-net-balance');


    // --- FUNÇÕES UTILITÁRIAS ---
    const formatCurrency = (value) => (typeof value === 'number' && !isNaN(value)) ? value.toLocaleString('pt-BR', CURRENCY_FORMAT_CONFIG) : 'R$ 0,00';
    const formatMonthYear = (date) => date ? new Date(date.getUTCFullYear(), date.getUTCMonth(), 1).toLocaleDateString('pt-BR', MONTH_YEAR_FORMAT_CONFIG).replace(' de','').replace('.de ','/').replace('.','') : 'N/A';
    const formatDateBR = (date) => date ? date.toLocaleDateString('pt-BR', DAY_MONTH_YEAR_FORMAT_CONFIG) : 'N/A';
    const parseSheetDate = (value) => {
        if (value instanceof Date) return value;
        if (value == null) return null;
        // Formato "Date(yyyy,MM,dd)" do Google Sheets (MM é 0-indexado)
        if (typeof value === 'string' && value.startsWith('Date(')) {
            try {
                const parts = value.substring(5, value.length - 1).split(',');
                return new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2])));
            } catch (e) { return null; }
        }
        // Número serial do Excel/Sheets (dias desde 30/12/1899)
        if (typeof value === 'number' && value > 1 && value < 60000) {
            const excelEpoch = new Date(Date.UTC(1899, 11, 30));
            const date = new Date(excelEpoch.getTime() + value * 24 * 60 * 60 * 1000);
            return new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
        }
        // Tenta parse padrão, pode funcionar para YYYY-MM-DD
        const d = new Date(value);
        if (d && !isNaN(d.getTime())) {
             return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getUTCDate())); // Normaliza para UTC
        }
        return null;
    };
    const parseValue = (rawValue) => {
        if (rawValue == null) return 0;
        if (typeof rawValue === 'number') return rawValue;
        if (typeof rawValue === 'string') {
            const cleaned = rawValue.replace(/[R$\s.]/g, '').replace(',', '.');
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        }
        return 0;
    };

    // --- LÓGICA PRINCIPAL ---
    async function fetchAndProcessData() {
        if (isFetching) return;
        isFetching = true;
        if (!initialLoadComplete) $loader.classList.remove('hidden');
        if ($manualRefreshBtn) $manualRefreshBtn.disabled = true;
        if ($refreshIcon) $refreshIcon.classList.add('animate-spin');
        $errorMsg.classList.add('hidden');
        $warningMsg.classList.add('hidden');

        try {
            const response = await fetch(`${BASE_URL}&_=${Date.now()}`);
            if (!response.ok) throw new Error(`Erro HTTP ${response.status} ao buscar dados.`);
            const text = await response.text();
            if (!text.startsWith('/*O_o*/\ngoogle.visualization.Query.setResponse(')) {
                throw new Error('Formato de resposta inválido da API do Google Sheets.');
            }
            const jsonData = JSON.parse(text.substring(47, text.length - 2));

            if (!jsonData?.table?.cols || !jsonData?.table?.rows) {
                throw new Error("Dados da planilha estão vazios ou em formato inesperado.");
            }

            const cols = jsonData.table.cols.map(col => col.label?.trim().toLowerCase() || '');
            const dateIdx = cols.findIndex(c => c.includes('data'));
            const descIdx = cols.findIndex(c => c.includes('descrição') || c.includes('descricao'));
            const catIdx = cols.findIndex(c => c.includes('categoria'));
            const valueIdx = cols.findIndex(c => c.includes('valor'));
            const typeIdx = cols.findIndex(c => c.includes('tipo'));

            let warnings = [];
            if (dateIdx === -1) warnings.push("Coluna 'Data' não encontrada.");
            if (valueIdx === -1) warnings.push("Coluna 'Valor' não encontrada.");
            if (typeIdx === -1) warnings.push("Coluna 'Tipo' (Receita/Despesa) não encontrada. Essencial para cálculos de saldo.");
            if (catIdx === -1) warnings.push("Coluna 'Categoria' não encontrada. Gráficos de categoria serão limitados.");

            if (warnings.length > 0 && dateIdx === -1 && valueIdx === -1 && typeIdx === -1) { // Erro Crítico
                throw new Error("Colunas essenciais (Data, Valor, Tipo) não encontradas. Verifique sua planilha. Detalhes: " + warnings.join(' '));
            }
            if (warnings.length > 0) {
                 $warningMsg.innerHTML = "Atenção: Algumas colunas não foram encontradas ou podem estar nomeadas incorretamente, o que pode afetar a precisão do relatório: <br>• " + warnings.join('<br>• ');
                 $warningMsg.classList.remove('hidden');
            }


            rawSheetData.headers = jsonData.table.cols.map(col => col.label?.trim() || '');
            const sheetRows = jsonData.table.rows;

            processedTransactions = sheetRows.map(row => {
                const cells = row.c;
                const date = dateIdx !== -1 ? parseSheetDate(cells[dateIdx]?.v) : null;
                const description = descIdx !== -1 ? cells[descIdx]?.v?.toString().trim() : 'N/A';
                const category = catIdx !== -1 ? cells[catIdx]?.v?.toString().trim() || 'Outros' : 'Outros';
                const value = valueIdx !== -1 ? parseValue(cells[valueIdx]?.v) : 0;
                const type = typeIdx !== -1 ? cells[typeIdx]?.v?.toString().trim().toLowerCase() : (value >= 0 ? 'receita' : 'despesa'); // Fallback simples se tipo ausente

                return { date, description, category, value: Math.abs(value), type }; // Armazena valor sempre positivo, tipo define
            }).filter(t => t.date && t.value > 0); // Filtra transações inválidas

            if (processedTransactions.length === 0) {
                throw new Error("Nenhuma transação válida encontrada após processamento. Verifique os dados da planilha.");
            }

            processedTransactions.sort((a, b) => a.date - b.date); // Ordena por data

            updateDashboard();
            $lastUpdate.textContent = `Atualizado: ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
            if (!initialLoadComplete) initialLoadComplete = true;

        } catch (error) {
            console.error("Erro ao carregar ou processar dados:", error);
            $errorMsg.textContent = `Erro: ${error.message}`;
            $errorMsg.classList.remove('hidden');
        } finally {
            isFetching = false;
            $loader.classList.add('hidden');
            if ($manualRefreshBtn) $manualRefreshBtn.disabled = false;
            if ($refreshIcon) $refreshIcon.classList.remove('animate-spin');
             $('footer-date').textContent = new Date().toLocaleDateString('pt-BR', {day:'2-digit', month:'long', year:'numeric'});
        }
    }

    // --- FUNÇÕES DE ATUALIZAÇÃO DA UI ---
    function updateDashboard() {
        updateKPIs();
        renderOrUpdateAllCharts();
    }

    function updateKPIs() {
        const totalRevenue = processedTransactions.filter(t => t.type.includes('receita')).reduce((sum, t) => sum + t.value, 0);
        const totalExpense = processedTransactions.filter(t => t.type.includes('despesa')).reduce((sum, t) => sum + t.value, 0);
        const netBalance = totalRevenue - totalExpense;
        const expenseRatio = totalRevenue > 0 ? (totalExpense / totalRevenue * 100) : 0;

        $kpiTotalRevenue.textContent = formatCurrency(totalRevenue);
        $kpiTotalExpense.textContent = formatCurrency(totalExpense);
        $kpiNetBalance.textContent = formatCurrency(netBalance);
        $kpiNetBalance.className = `kpi-value ${netBalance >= 0 ? 'text-success-600' : 'text-danger-600'}`;
        $kpiExpenseRatio.textContent = `${expenseRatio.toFixed(1)}%`;
    }

    // --- FUNÇÕES DE AGREGAÇÃO DE DADOS PARA GRÁFICOS ---
    function getMonthlyCashflowData() {
        const monthlyData = {};
        processedTransactions.forEach(t => {
            const monthYear = formatMonthYear(t.date);
            if (!monthlyData[monthYear]) {
                monthlyData[monthYear] = { revenue: 0, expense: 0, dateSort: new Date(t.date.getUTCFullYear(), t.date.getUTCMonth(), 1) };
            }
            if (t.type.includes('receita')) monthlyData[monthYear].revenue += t.value;
            else if (t.type.includes('despesa')) monthlyData[monthYear].expense += t.value;
        });
        const sortedMonths = Object.keys(monthlyData).sort((a,b) => monthlyData[a].dateSort - monthlyData[b].dateSort);
        return {
            labels: sortedMonths,
            revenues: sortedMonths.map(m => parseFloat(monthlyData[m].revenue.toFixed(2))),
            expenses: sortedMonths.map(m => parseFloat(monthlyData[m].expense.toFixed(2)))
        };
    }

    function getCategoricalData(typeFilter) { // 'receita' ou 'despesa'
        const categoryMap = new Map();
        processedTransactions
            .filter(t => t.type.includes(typeFilter))
            .forEach(t => {
                categoryMap.set(t.category, (categoryMap.get(t.category) || 0) + t.value);
            });
        const sortedEntries = [...categoryMap.entries()].sort((a, b) => b[1] - a[1]); // Sort by value desc
        return {
            labels: sortedEntries.map(e => e[0]),
            values: sortedEntries.map(e => parseFloat(e[1].toFixed(2)))
        };
    }
    
    function getMonthlyNetBalanceData() {
        const monthlyData = {};
        processedTransactions.forEach(t => {
            const monthYear = formatMonthYear(t.date);
             if (!monthlyData[monthYear]) {
                monthlyData[monthYear] = { balance: 0, dateSort: new Date(t.date.getUTCFullYear(), t.date.getUTCMonth(), 1) };
            }
            const value = t.type.includes('receita') ? t.value : -t.value;
            monthlyData[monthYear].balance += value;
        });
        const sortedMonths = Object.keys(monthlyData).sort((a,b) => monthlyData[a].dateSort - monthlyData[b].dateSort);
        return {
            labels: sortedMonths,
            balances: sortedMonths.map(m => parseFloat(monthlyData[m].balance.toFixed(2)))
        };
    }

    // --- CONFIGURAÇÕES E RENDERIZAÇÃO DE GRÁFICOS ---
    const commonChartOptions = {
        chart: { fontFamily: 'Inter, sans-serif', foreColor: COLORS_SLATE[600], toolbar: { show: true, tools: { download: true, selection: false, zoom: false, zoomin: false, zoomout: false, pan: false, reset: false } }, animations: { easing: 'easeinout', speed: 600 }, background: 'transparent' },
        stroke: { width: 2.5, curve: 'smooth' },
        markers: { size: 4, hover: { size: 6 } },
        grid: { borderColor: COLORS_SLATE[200], strokeDashArray: 4, padding: { left: 5, right: 15, top: 5, bottom: 5 } },
        xaxis: { type: 'category', labels: { style: { colors: COLORS_SLATE[600], fontSize: '11px' } }, axisBorder: { color: COLORS_SLATE[300] }, axisTicks: { color: COLORS_SLATE[300] } },
        yaxis: { labels: { style: { colors: COLORS_SLATE[600], fontSize: '11px' }, formatter: (val) => formatCurrency(val).replace('R$','').trim() }, }, // Formato compacto para eixo Y
        tooltip: { theme: 'light', style: { fontSize: '12px' }, y: { formatter: (val) => formatCurrency(val) } },
        legend: { fontSize: '12px', fontWeight: 500, itemMargin: { horizontal: 10 }, markers: { radius: 12, width: 12, height: 12, offsetY: 1 } },
        noData: { text: 'Sem dados suficientes para exibir.', style: { color: COLORS_SLATE[500], fontSize: '14px' } }
    };

    function renderOrUpdateChart(chartName, containerElement, options) {
        if (charts[chartName]) {
            charts[chartName].updateOptions(options, true, true, true);
        } else {
            if(containerElement) {
                 charts[chartName] = new ApexCharts(containerElement, options);
                 charts[chartName].render();
            } else {
                console.warn(`Container para ${chartName} não encontrado.`);
            }
        }
    }

    function renderOrUpdateAllCharts() {
        // 1. Fluxo de Caixa Mensal
        const cashflowData = getMonthlyCashflowData();
        if ($chartMonthlyCashflow) renderOrUpdateChart('monthlyCashflow', $chartMonthlyCashflow, {
            ...commonChartOptions,
            series: [
                { name: 'Receitas', data: cashflowData.revenues, color: COLORS_SUCCESS[500] },
                { name: 'Despesas', data: cashflowData.expenses, color: COLORS_DANGER[500] }
            ],
            chart: { ...commonChartOptions.chart, type: 'bar', height: 350, stacked: false },
            plotOptions: { bar: { horizontal: false, columnWidth: '60%', endingShape: 'rounded' } },
            xaxis: { ...commonChartOptions.xaxis, categories: cashflowData.labels },
            dataLabels: { enabled: false },
            legend: { ...commonChartOptions.legend, position: 'top', horizontalAlign: 'right' },
        });

        // 2. Despesas por Categoria
        const expenseCatData = getCategoricalData('despesa');
         if ($chartExpenseCategories) renderOrUpdateChart('expenseCategories', $chartExpenseCategories, {
            ...commonChartOptions,
            series: expenseCatData.values,
            labels: expenseCatData.labels,
            chart: { ...commonChartOptions.chart, type: 'donut', height: 380 },
            colors: CATEGORY_CHART_PALETTE,
            plotOptions: { pie: { donut: { size: '60%', labels: { show: true, total: { show: true, label: 'Total Despesas', formatter: (w) => formatCurrency(w.globals.seriesTotals.reduce((a,b) => a+b, 0)) }, value: {offsetY: 4} } } } },
            dataLabels: { enabled: true, formatter: (val, opts) => `${opts.w.globals.labels[opts.seriesIndex]}: ${val.toFixed(1)}%` , style: {fontSize: '10px', colors: ['#fff']}, dropShadow: {enabled: true, top:1, left:1, blur:1, opacity: 0.6}},
            legend: { ...commonChartOptions.legend, position: 'bottom', offsetY: 0, height: 60,
                formatter: (seriesName, opts) => `${seriesName} - ${formatCurrency(opts.w.globals.series[opts.seriesIndex])}`
            },
        });

        // 3. Receitas por Categoria
        const revenueCatData = getCategoricalData('receita');
         if ($chartRevenueCategories) renderOrUpdateChart('revenueCategories', $chartRevenueCategories, {
            ...commonChartOptions,
            series: revenueCatData.values,
            labels: revenueCatData.labels,
            chart: { ...commonChartOptions.chart, type: 'donut', height: 380 },
            colors: CATEGORY_CHART_PALETTE.slice().reverse(), // Use a different order or palette
            plotOptions: { pie: { donut: { size: '60%', labels: { show: true, total: { show: true, label: 'Total Receitas', formatter: (w) => formatCurrency(w.globals.seriesTotals.reduce((a,b) => a+b, 0)) }, value: {offsetY: 4} } } } },
            dataLabels: { enabled: true, formatter: (val, opts) => `${opts.w.globals.labels[opts.seriesIndex]}: ${val.toFixed(1)}%`, style: {fontSize: '10px', colors: ['#fff']}, dropShadow: {enabled: true, top:1, left:1, blur:1, opacity: 0.6}},
            legend: { ...commonChartOptions.legend, position: 'bottom', offsetY: 0, height: 60,
                formatter: (seriesName, opts) => `${seriesName} - ${formatCurrency(opts.w.globals.series[opts.seriesIndex])}`
            },
        });
        
        // 4. Saldo Líquido Mensal
        const netBalanceData = getMonthlyNetBalanceData();
        if ($chartMonthlyNetBalance) renderOrUpdateChart('monthlyNetBalance', $chartMonthlyNetBalance, {
            ...commonChartOptions,
            series: [{ name: 'Saldo Líquido', data: netBalanceData.balances }],
            chart: { ...commonChartOptions.chart, type: 'bar', height: 350 },
            colors: [COLORS_PRIMARY[500]],
             plotOptions: { bar: { horizontal: false, columnWidth: '50%', dataLabels: { position: 'top' } } },
            dataLabels: {
                enabled: true,
                formatter: (val) => formatCurrency(val),
                offsetY: -20,
                style: { fontSize: '10px', colors: [COLORS_SLATE[700]] }
            },
            xaxis: { ...commonChartOptions.xaxis, categories: netBalanceData.labels },
            yaxis: { ...commonChartOptions.yaxis, title: { text: 'Saldo (R$)', style: { color: COLORS_SLATE[500], fontSize:'11px', fontWeight: 400 } } },
            legend: { show: false },
        });
    }


    // --- INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchAndProcessData(); // Carga inicial
        if ($manualRefreshBtn) $manualRefreshBtn.onclick = fetchAndProcessData;
        // setInterval(fetchAndProcessData, REFRESH_INTERVAL); // Auto-refresh
    });
  </script>
</body>
</html>
