<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • Google Sheets (ApexCharts Realtime)</title>

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
        extend: {
          colors: {
            surface: '#1e1e24',
            primary: {
              50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',
              400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',
              800:'#3730a3',900:'#312e81'
            }
          },
          backdropBlur:{ xs:'2px' },
          boxShadow:{ glow:'0 0 8px rgba(99,102,241,.4)' }
        }
      }
    };
  </script>

  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.46.0"></script>

  <style>
    @keyframes spin{to{transform:rotate(360deg)}}
    .animate-spin{animation:spin 1s linear infinite}
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:#4b5563;border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:#9ca3af}
    html,body{height:100%} body{display:flex;flex-direction:column}
    #table-wrapper,#charts-wrapper{flex-grow:1;overflow-y:auto}
    #sheetTable{width:100%}
    #table-wrapper thead{position:sticky;top:0;z-index:10}
    /* --- abas activas --- */
    .tab-btn.active-tab{background:#4f46e5;color:#fff !important;box-shadow:0 0 5px rgba(99,102,241,.6)}
  </style>
</head>
<body class="bg-gradient-to-br from-gray-950 via-gray-900 to-gray-800 text-gray-100 selection:bg-primary-500/60 min-h-screen flex flex-col antialiased">

  <!-- Cabeçalho -->
  <header class="w-full backdrop-blur-sm bg-surface/60 border-b border-primary-700/40 sticky top-0 z-40">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-8 h-16 flex items-center justify-between gap-4">
      <h1 class="text-lg sm:text-2xl font-extrabold text-primary-400 tracking-tight select-none">Dashboard • Google Sheets API-Excel</h1>
      <div class="flex items-center gap-4 ml-auto">
        <span id="month-total" class="hidden sm:block text-primary-300 font-semibold text-sm"></span>
        <!-- Informativo de atualização no topo -->
        <span id="last-update" class="text-gray-400 text-xs sm:text-sm"></span>
        <button id="manual-refresh" class="flex items-center gap-2 px-4 py-2 rounded-md border border-primary-600 bg-primary-600/20 hover:bg-primary-600/30 transition text-primary-300 text-sm font-medium shadow-glow">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M5 19a9 9 0 0014-7h1M19 5a9 9 0 00-14 7H4"/></svg>
          Atualizar
        </button>
      </div>
    </div>
  </header>

  <!-- Loader -->
  <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900/80 backdrop-blur-md transition-opacity">
    <div class="h-12 w-12 border-[6px] border-primary-500 border-t-transparent rounded-full animate-spin mb-6"></div>
    <p class="text-primary-300 text-lg font-medium">Carregando dados...</p>
  </div>

  <!-- Conteúdo -->
  <main class="w-full max-w-screen-2xl mx-auto px-4 sm:px-8 py-6 flex flex-col gap-6">

    <!-- Abas -->
    <div class="flex justify-center space-x-4">
      <button id="tab-table"  class="tab-btn relative px-5 py-2 rounded-lg font-medium overflow-hidden text-gray-300 before:absolute before:inset-0 before:bg-primary-600 before:scale-x-0 before:origin-left before:transition-transform hover:before:scale-x-100 before:rounded-lg"><span class="relative z-10">Tabela</span></button>
      <button id="tab-charts" class="tab-btn relative px-5 py-2 rounded-lg font-medium overflow-hidden text-gray-300 before:absolute before:inset-0 before:bg-primary-600 before:scale-x-0 before:origin-left before:transition-transform hover:before:scale-x-100 before:rounded-lg"><span class="relative z-10">Gráficos</span></button>
    </div>

    <div id="error-message" class="hidden w-full p-4 text-center text-red-300 bg-red-800/40 border border-red-600 rounded-lg shadow"></div>

    <!-- Tabela -->
    <section id="table-wrapper" class="hidden w-full overflow-x-auto backdrop-blur-xs bg-surface/70 rounded-2xl shadow-lg ring-1 ring-primary-600/20">
      <table id="sheetTable" class="min-w-full text-[13px] divide-y divide-gray-700/50"></table>
    </section>

    <!-- Gráfico -->
    <section id="charts-wrapper" class="hidden w-full flex-col space-y-8">
      <div class="chart-card backdrop-blur-xs bg-surface/70 rounded-2xl shadow-lg ring-1 ring-primary-600/20 p-6">
        <h2 class="text-xl font-semibold mb-4 text-primary-300 tracking-wide">Valor Total por <code>data_vencimento</code></h2>
        <div id="chart-overview"></div>
      </div>
    </section>
  </main>

  <!-- ------------------------------------------------ JS ------------------------------------------------- -->
  <script>
    /* CONFIG */
    const sheetId  = '1gJLltq6O86QIPSj4Id-lIsxG45o7bq2QBW4WGhoXWoo';
    const gid      = '0';
    const baseURL  = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
    const REFRESH_INTERVAL_MS = 2000;
    const CURRENCY_FORMAT = { style:'currency', currency:'BRL', maximumFractionDigits:2 };
    const CHART_COLOR     = "#818cf8";

    /* Estado global */
    let headersCache=[], rowsCache=[];
    let chartOverview=null;
    let initialLoadComplete=false, refreshIntervalId=null, isFetching=false;

    /* DOM */
    const $loader       = document.getElementById('loader');
    const $errorMessage = document.getElementById('error-message');
    const $tableTab     = document.getElementById('tab-table');
    const $chartTab     = document.getElementById('tab-charts');
    const $tableWrap    = document.getElementById('table-wrapper');
    const $chartWrap    = document.getElementById('charts-wrapper');
    const $sheetTable   = document.getElementById('sheetTable');
    const $lastUpdate   = document.getElementById('last-update');
    const $manualRefresh= document.getElementById('manual-refresh');
    const $monthTotal   = document.getElementById('month-total');

    /* Tabs */
    $tableTab.onclick = () => activateTab('table');
    $chartTab.onclick = () => activateTab('charts');
    function activateTab(tab){
      [$tableTab,$chartTab].forEach(b=>b.classList.remove('text-white','text-gray-300','active-tab'));
      if(tab==='table'){
        $tableWrap.classList.remove('hidden');
        $chartWrap.classList.add('hidden');
        $tableTab.classList.add('text-white','active-tab');
        $chartTab.classList.add('text-gray-300');
      }else{
        $chartWrap.classList.remove('hidden');
        $tableWrap.classList.add('hidden');
        $chartTab.classList.add('text-white','active-tab');
        $tableTab.classList.add('text-gray-300');
        setTimeout(()=>{ chartOverview?.updateOptions({},false,false); },50);
      }
    }
    $manualRefresh.onclick = refreshData;

    /* Auxiliares */
    async function fetchSheetData(){
      const resp = await fetch(`${baseURL}&_=${Date.now()}`);
      if(!resp.ok) throw new Error(`Erro na requisição HTTP: ${resp.status}`);
      const txt = await resp.text();
      return JSON.parse(txt.substring(47,txt.length-2));
    }
    const pad2 = n=>n.toString().padStart(2,'0');
    const formatDateBR = d=>`${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    function tryParseDate(value){
      if(value instanceof Date) return value;
      if(typeof value!=='string' || !value.trim()) return null;
      let m=value.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})\)$/);
      if(m) return new Date(+m[1],+m[2],+m[3]);
      m=value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(m) return new Date(+m[1],+m[2]-1,+m[3]);
      m=value.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if(m){ let y=+m[3]; if(y<100) y+=2000; return new Date(y,+m[2]-1,+m[1]); }
      return null;
    }

    /* Refresh principal */
    async function refreshData(){
      if(isFetching) return;
      isFetching=true;
      if(!initialLoadComplete) $loader.classList.remove('hidden');
      $errorMessage.classList.add('hidden');
      try{
        const json = await fetchSheetData();
        if(!json?.table) throw new Error('Estrutura de dados inválida recebida da API.');
        const headers = json.table.cols.map(c=>c.label || `Col${c.id}`);
        const rows    = json.table.rows.map(r=>r.c.map(cell=>cell?.v ?? null));
        const changed = JSON.stringify(rows) !== JSON.stringify(rowsCache);
        headersCache=headers; rowsCache=rows;

        if(!initialLoadComplete){
          renderTable(headers,rows);
          buildOverviewChart(headers,rows);
          initialLoadComplete=true;
          $loader.classList.add('hidden');
          activateTab('table');
        }else if(changed){
          renderTable(headers,rows);
          updateOverviewChart(headers,rows);
        }
        updateMonthlyTotal(headers,rows);
        $lastUpdate.textContent = `Última atualização: ${new Date().toLocaleTimeString('pt-BR')}`;

      }catch(err){
        console.error("Erro ao buscar ou processar dados:", err);
        $errorMessage.textContent = `Erro ao carregar dados: ${err.message}`;
        $errorMessage.classList.remove('hidden');
        $loader.classList.add('hidden');
        stopAutoRefresh();
        $lastUpdate.textContent = `Falha na atualização: ${new Date().toLocaleTimeString('pt-BR')}`;
      }finally{
        isFetching=false;
      }
    }
    function startAutoRefresh(){ stopAutoRefresh(); if(REFRESH_INTERVAL_MS>0) refreshIntervalId=setInterval(refreshData,REFRESH_INTERVAL_MS);}    
    function stopAutoRefresh(){ if(refreshIntervalId) clearInterval(refreshIntervalId); refreshIntervalId=null;}

    /* ---------- Tabela ---------- */
    function renderTable(h,r){ $sheetTable.innerHTML=''; $sheetTable.appendChild(genHead(h)); $sheetTable.appendChild(genBody(r,h)); }
    function genHead(headers){
      const thead=document.createElement('thead'); thead.className='bg-gray-800/90 backdrop-blur-xs';
      const tr=document.createElement('tr'); tr.className='divide-x divide-primary-700/40';
      headers.forEach(h=>{
        const th=document.createElement('th');
        th.scope='col';
        th.className='px-6 py-3 text-left text-xs font-semibold text-primary-300 uppercase tracking-wider';
        th.textContent=h;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
      return thead;
    }
    function genBody(rows, headers){
      const tbody=document.createElement('tbody');
      tbody.className='divide-y divide-gray-700/60';
      rows.forEach((row,rowIndex)=>{
        const tr=document.createElement('tr');
        tr.className=`${rowIndex%2===0?'bg-surface/50':'bg-surface/70'} hover:bg-primary-600/10 transition`;
        row.forEach((cell,colIndex)=>{
          const td=document.createElement('td');
          td.className='px-6 py-3 whitespace-nowrap';
          let content=cell??'–';
          const headerLabel=headers[colIndex].trim().toLowerCase();
          if(headerLabel==='nf'){
            td.textContent=content;
          }else{
            const d=tryParseDate(cell);
            if(d){
              content=formatDateBR(d);
            }else{
              if(typeof cell==='number'){
                content=cell.toLocaleString('pt-BR',CURRENCY_FORMAT);
              }else if(typeof cell==='string' && cell.match(/^[\d\.\,]+$/)){
                const num=parseFloat(cell.replace(/\./g,'').replace(',','.'));
                if(!isNaN(num)) content=num.toLocaleString('pt-BR',CURRENCY_FORMAT);
              }
            }
            td.textContent=content;
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      return tbody;
    }

    /* ---------- GRÁFICO ---------- */
    function getTotalsByVenc(headers,rows){
      /* identifica col. de data_vencimento ---------------------------- */
      let dateIdx = headers.findIndex(h=>/venc/i.test(h));      // ← aqui
      if(dateIdx===-1) dateIdx = headers.findIndex(h=>/date/i.test(h));
      if(dateIdx===-1) dateIdx = 0;

      /* colunas numéricas (exceto NF) -------------------------------- */
      const numericIdx = headers.map((h,i)=>({h,i})).filter(c=>
        c.i!==dateIdx && c.h.trim().toLowerCase()!=='nf'
      ).map(c=>c.i);

      const map = new Map();
      rows.forEach(r=>{
        const d = tryParseDate(r[dateIdx]);
        if(!d) return;
        const key = d.toISOString().split('T')[0];
        let sum  = map.get(key) || 0;
        numericIdx.forEach(i=>{
          let v=r[i];
          if(v==null) return;
          if(typeof v==='number'){ sum+=v; }
          else if(typeof v==='string'){
            const n=parseFloat(v.replace(/\./g,'').replace(',','.'));
            if(!isNaN(n)) sum+=n;
          }
        });
        map.set(key,sum);
      });

      const ordered=[...map.entries()].sort((a,b)=>new Date(a[0])-new Date(b[0]));
      return {
        labels : ordered.map(([k])=>formatDateBR(new Date(k))),
        totals : ordered.map(([_,v])=>v)
      };
    }

    const tooltipFmt=v=>typeof v==='number'?v.toLocaleString('pt-BR',CURRENCY_FORMAT):'N/A';
    const commonOpts={
      chart:{toolbar:{show:true,tools:{download:true}},zoom:{enabled:false},foreColor:'#cbd5e1'},
      tooltip:{theme:'dark',y:{formatter:tooltipFmt}},
      dataLabels:{enabled:false},
      grid:{borderColor:'#475569',strokeDashArray:4},
      legend:{show:false}
    };

    function buildOverviewChart(headers,rows){
      const {labels,totals}=getTotalsByVenc(headers,rows);
      chartOverview?.destroy();
      chartOverview=new ApexCharts(document.getElementById('chart-overview'),{
        ...commonOpts,
        chart:{...commonOpts.chart,type:'area',height:300},
        series:[{name:'Total do Dia',data:totals}],
        colors:[CHART_COLOR],
        xaxis:{categories:labels,tooltip:{enabled:false}},
        yaxis:{labels:{formatter:v=>typeof v==='number'?v.toLocaleString('pt-BR',{notation:'compact',maximumFractionDigits:1}):''}},
        stroke:{curve:'smooth',width:2},
        fill:{type:'gradient',gradient:{shadeIntensity:1,opacityFrom:0.5,opacityTo:0.1,stops:[0,90,100]}},
        markers:{size:0,hover:{size:5}}
      });
      chartOverview.render();
    }
    function updateOverviewChart(headers,rows){
      const {labels,totals}=getTotalsByVenc(headers,rows);
      chartOverview?.updateOptions({
        xaxis:{categories:labels},
        series:[{data:totals}]
      });
    }

    /* Total do mês (usando data de vencimento) */
    function updateMonthlyTotal(headers,rows){
      let valueColIdx=headers.findIndex(h=>/valor/i.test(h));
      if(valueColIdx===-1){
        for(let i=1;i<headers.length;i++){
          if(rows.some(r=>typeof r[i]==='number')){valueColIdx=i;break;}
        }
      }
      let dateColIdx=headers.findIndex(h=>/venc/i.test(h));
      if(dateColIdx===-1) dateColIdx=headers.findIndex(h=>/date/i.test(h));
      if(dateColIdx===-1) dateColIdx=0;
      if(valueColIdx===-1){ $monthTotal.textContent=''; return; }

      const now=new Date(), m=now.getMonth(), y=now.getFullYear();
      const sum=rows.reduce((acc,r)=>{
        let v=r[valueColIdx]; if(v==null) return acc;
        let n=typeof v==='number'?v:parseFloat(String(v).replace(/\./g,'').replace(',','.'));
        if(isNaN(n)) return acc;
        const d=tryParseDate(r[dateColIdx]);
        if(d && d.getMonth()===m && d.getFullYear()===y) acc+=n;
        return acc;
      },0);
      $monthTotal.textContent=`Mês: ${sum.toLocaleString('pt-BR',CURRENCY_FORMAT)}`;
      $monthTotal.closest('span').classList.remove('hidden');
    }

    /* Init */
    refreshData();
    startAutoRefresh();
  </script>
</body>
</html>
