<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • Google Sheets</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
        extend: {
          colors: {
            surface: '#212529',
            primary: { 500: '#4dabf7' },
            slate: { 300: '#cbd5e1', 400: '#94a3b8', 600: '#475569' }
          },
          boxShadow: { glow: '0 0 8px rgba(77,171,247,.35)' },
          backdropBlur: { xs: '2px' }
        }
      }
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.46.0"></script>

  <style>
    @keyframes spin { to { transform: rotate(360deg) } }
    .animate-spin { animation: spin 1s linear infinite }
    html, body { height: 100%; } /* Ensure html and body take full height */
    body { background: #1a1d21; display: flex; flex-direction: column; } /* Make body a flex column */

    /* Ensure main content area can grow */
    main { flex-grow: 1; display: flex; flex-direction: column; }

    #table-wrapper {
        flex-grow: 1; /* Allow table wrapper to grow vertically */
        overflow: auto; /* Allow both vertical and horizontal scrolling */
        max-width: 100%;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    #charts-wrapper {
        flex-grow: 1; /* Allow charts wrapper to grow vertically */
        overflow-y: auto;
    }
    #sheetTable {
        width: 100%;
        /* Removed font-size transition from here, applying to thead/tbody */
     }
     /* Apply zoom transition to thead and tbody */
     #sheetTable thead,
     #sheetTable tbody {
        transition: font-size 0.2s ease-in-out;
     }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 8px; height: 8px }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px }

    /* Table Header Filter Select Styling */
    th select {
      background: #212529; border: 1px solid #4dabf7; border-radius: 4px;
      /* Font size for select should remain constant, not zoom */
      font-size: 11px !important;
      padding: 4px 6px; width: 100%; margin-top: 4px;
      color: #cbd5e1;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234dabf7%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 0.65em auto;
      padding-right: 2rem;
    }
    th select:focus { outline: none; border-color: #4dabf7; box-shadow: 0 0 0 2px rgba(77, 171, 247, 0.3); }

    /* Active Tab Styling */
    .tab-btn.active-tab {
      background: #4dabf7; color: #fff !important;
      box-shadow: 0 0 5px rgba(77, 171, 247, .55)
    }
    .chart-card { transition: background-color 0.3s ease; }

    /* Focus Visible Styling */
    button:focus-visible, select:focus-visible {
      outline: 2px solid #4dabf7; outline-offset: 2px;
    }

    /* --- Styles for Full-Screen TABLE VIEW (CSS Class on <main>) --- */
    main.table-full-screen {
        max-width: none;
        padding-left: 0; padding-right: 0; padding-top: 0; padding-bottom: 0;
        gap: 0;
    }
     main.table-full-screen > div:first-of-type { /* Tab buttons container */
         padding: 0.75rem 1rem; flex-shrink: 0;
         border-bottom: 1px solid #475569; background-color: #212529;
     }
     main.table-full-screen > #filters-bar {
         padding: 0.75rem 1rem; flex-shrink: 0;
         border-bottom: 1px solid #475569; background-color: #212529;
     }
    main.table-full-screen > #table-wrapper {
        border-radius: 0; border-top: none; ring-width: 0; box-shadow: none;
        background: transparent;
    }
    /* Sticky Header Style when table view is active */
    main.table-full-screen #sheetTable thead th {
        position: sticky; top: 0; z-index: 10;
        background-color: #2a2e32; /* Slightly darker bg for sticky contrast */
    }
    /* --- End Full-Screen Table Styles --- */

    /* Standard Button Style (like Refresh) */
    .std-btn {
        padding: 0.375rem 0.75rem; /* py-1.5 px-3 */
        border-radius: 0.375rem; /* rounded-md */
        border: 1px solid #4dabf7;
        background-color: rgba(77, 171, 247, 0.1);
        color: #a3cef9;
        font-size: 0.75rem; /* text-xs */
        font-weight: 500; /* font-medium */
        box-shadow: 0 0 8px rgba(77,171,247,.35); /* shadow-glow */
        transition: background-color 0.2s;
        white-space: nowrap;
    }
     .std-btn:hover { background-color: rgba(77, 171, 247, 0.2); }
     .std-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none;}

    /* Zoom Button Styles */
    .zoom-btn {
        padding: 0.25rem 0.5rem; /* Smaller padding */
        border-radius: 0.375rem; border: 1px solid #4dabf7;
        background-color: rgba(77, 171, 247, 0.1); color: #a3cef9;
        font-size: 0.875rem; /* text-sm */ font-weight: 500;
        box-shadow: 0 0 8px rgba(77,171,247,.35);
        transition: background-color 0.2s;
    }
    .zoom-btn:hover { background-color: rgba(77, 171, 247, 0.2); }
    .zoom-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

    /* Ensure SVG icons inside buttons scale */
     .std-btn svg {
        width: 1em; height: 1em; display: inline-block; vertical-align: middle;
     }

  </style>
</head>
<body class="text-slate-300 min-h-screen flex flex-col antialiased">

  <header class="w-full backdrop-blur-sm bg-surface/80 border-b border-primary-500/40 sticky top-0 z-40 flex-shrink-0">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 h-auto min-h-[4rem] py-2 sm:py-0 sm:h-16 flex flex-wrap items-center justify-between gap-x-4 gap-y-2">
      <h1 class="text-lg sm:text-xl lg:text-2xl font-extrabold text-primary-500 order-1 sm:order-1">Dashboard • Google Sheets</h1>

      <div class="flex items-center gap-3 sm:gap-4 order-3 sm:order-2 w-full sm:w-auto justify-center sm:justify-end flex-wrap">
          <span id="month-total" class="text-primary-500 font-semibold text-xs sm:text-sm text-center"></span>
          <span id="last-update" class="text-slate-400 text-xs sm:text-sm text-center"></span>
      </div>

      <div class="flex items-center gap-2 sm:gap-3 order-2 sm:order-3 ml-auto sm:ml-0">
         <div id="table-zoom-controls" class="items-center gap-1 hidden">
             <span class="text-xs text-slate-400 mr-1">Zoom:</span>
            <button id="zoom-out" class="zoom-btn" title="Diminuir Zoom (Tabela)">-</button>
            <button id="zoom-in" class="zoom-btn" title="Aumentar Zoom (Tabela)">+</button>
         </div>

         <button id="toggle-fullscreen" class="std-btn text-xs sm:text-sm" title="Entrar/Sair Tela Cheia">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg>
             <span class="button-text">Tela Cheia</span>
         </button>

         <button id="manual-refresh" class="std-btn text-xs sm:text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block mr-1"> <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
           Atualizar
         </button>
      </div>
      </div>
  </header>

  <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900/80 backdrop-blur-md">
    <div class="h-12 w-12 border-[6px] border-primary-500 border-t-transparent rounded-full animate-spin mb-6"></div>
    <p class="text-primary-300 text-lg font-medium">Carregando…</p>
  </div>

  <main id="main-content" class="w-full max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex flex-col gap-6 flex-grow">
    <div class="flex justify-center space-x-3 sm:space-x-4 flex-shrink-0">
      <button id="tab-table" class="tab-btn px-4 py-2 sm:px-5 rounded-lg font-medium text-slate-300 hover:bg-primary-500/10 transition-colors duration-200">Tabela</button>
      <button id="tab-charts" class="tab-btn px-4 py-2 sm:px-5 rounded-lg font-medium text-slate-300 hover:bg-primary-500/10 transition-colors duration-200">Gráficos</button>
    </div>

    <div id="filters-bar" class="flex flex-wrap items-center justify-center gap-3 flex-shrink-0">
      <span id="filters-active" class="text-primary-500 text-sm text-center">Nenhum filtro ativo</span>
      <button id="clear-filters"
              class="px-3 py-1 rounded-md border border-primary-500 bg-primary-500/10 hover:bg-primary-500/20
                     text-primary-300 text-xs font-medium shadow-glow" style="display: none;">
        Limpar Filtros
      </button>
    </div>

    <div id="error-message"
         class="hidden w-full p-4 text-center text-red-300 bg-red-800/40 border border-red-600 rounded-lg flex-shrink-0"></div>

    <section id="table-wrapper"
             class="hidden w-full backdrop-blur-xs bg-surface/70 rounded-2xl
                    shadow-lg ring-1 ring-primary-500/20 p-0">
      <table id="sheetTable" class="min-w-full divide-y divide-slate-600/60">
          </table>
    </section>

    <section id="charts-wrapper"
             class="hidden w-full grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
      <div class="chart-card bg-surface/80 rounded-2xl shadow-lg ring-1 ring-primary-500/20 p-4 sm:p-6 md:col-span-2">
        <h2 class="text-base sm:text-lg font-semibold mb-4 text-primary-500">Total por Data de Vencimento</h2>
        <div id="chart-overview"></div>
      </div>

      <div class="chart-card bg-surface/80 rounded-2xl shadow-lg ring-1 ring-primary-500/20 p-4 sm:p-6">
        <h2 class="text-base sm:text-lg font-semibold mb-4 text-primary-500">Total por Data de Pagamento</h2>
        <div id="chart-payment"></div>
      </div>

      <div class="chart-card bg-surface/80 rounded-2xl shadow-lg ring-1 ring-primary-500/20 p-4 sm:p-6">
        <h2 class="text-base sm:text-lg font-semibold mb-4 text-primary-500">Total por Mês (Vencimento)</h2>
        <div id="chart-monthly"></div>
      </div>
    </section>
  </main>

  <script>
    // --- Configuration ---
    const sheetId = '1du2FRGYbmY1mQ_mbNN1HuvQc8QhY3Bqq'; // Replace with your Sheet ID
    const gid     = '0'; // Replace with your GID if not the first sheet
    const baseURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
    const REFRESH_INTERVAL = 60000; // 1 minute
    const CURRENCY_FORMAT = { style: 'currency', currency: 'BRL', maximumFractionDigits: 2 };
    const CHART_COLORS = ['#4dabf7', '#4ade80', '#fb7185', '#facc15', '#a78bfa', '#2dd4bf'];

    // --- Table Zoom Configuration ---
    const MIN_ZOOM_PX = 10;
    const MAX_ZOOM_PX = 20;
    const ZOOM_STEP_PX = 1;
    const DEFAULT_ZOOM_PX = 13;
    let currentZoomLevel = DEFAULT_ZOOM_PX;

    // --- Global Variables ---
    let headersFull = [], sheetRows = [];
    let headersDisplay = [];
    let chartOverview, chartPayment, chartMonthly;
    let isLoaded = false, isFetching = false;
    const activeFilters = {};
    let prevOverviewData = null, prevPaymentData = null, prevMonthlyData = null;

    // --- DOM Element References ---
    const $loader = document.getElementById('loader');
    const $errorMsg = document.getElementById('error-message');
    const $tableTab = document.getElementById('tab-table');
    const $chartTab = document.getElementById('tab-charts');
    const $tableWrapper = document.getElementById('table-wrapper');
    const $chartWrapper = document.getElementById('charts-wrapper');
    const $sheetTable = document.getElementById('sheetTable');
    const $lastUpdate = document.getElementById('last-update');
    const $monthTotal = document.getElementById('month-total');
    const $filtersActive = document.getElementById('filters-active');
    const $clearFiltersBtn = document.getElementById('clear-filters');
    const $mainContent = document.getElementById('main-content');
    const $manualRefreshBtn = document.getElementById('manual-refresh');
    const $zoomInBtn = document.getElementById('zoom-in');
    const $zoomOutBtn = document.getElementById('zoom-out');
    const $tableZoomControls = document.getElementById('table-zoom-controls');
    const $toggleFullscreenBtn = document.getElementById('toggle-fullscreen'); // Fullscreen Button

    // --- Event Listeners ---
    $manualRefreshBtn.onclick = loadData;
    $tableTab.onclick = () => switchTab('table');
    $chartTab.onclick = () => switchTab('charts');
    $clearFiltersBtn.onclick = clearFilters;
    $zoomInBtn.onclick = zoomInTable;
    $zoomOutBtn.onclick = zoomOutTable;
    $toggleFullscreenBtn.onclick = toggleFullScreen; // Listener for Fullscreen button

    // --- Core Functions ---

    function switchTab(tabId) {
      [$tableTab, $chartTab].forEach(btn => btn.classList.remove('active-tab'));

      if (tabId === 'table') {
        $tableWrapper.classList.remove('hidden');
        $chartWrapper.classList.add('hidden');
        $tableTab.classList.add('active-tab');
        $mainContent.classList.add('table-full-screen');
        $tableZoomControls.classList.remove('hidden');
        $tableZoomControls.classList.add('flex');
      } else { // Switching to charts
        $chartWrapper.classList.remove('hidden');
        $tableWrapper.classList.add('hidden');
        $chartTab.classList.add('active-tab');
        $mainContent.classList.remove('table-full-screen');
        $tableZoomControls.classList.add('hidden');
        $tableZoomControls.classList.remove('flex');

        // Redraw charts for correct sizing after potential layout changes
        setTimeout(() => [chartOverview, chartPayment, chartMonthly].forEach(chart => {
            if (chart && typeof chart.updateOptions === 'function') {
                chart.updateOptions({}, false, false, false);
            }
        }), 50);
      }
      updateZoomButtons(); // Update zoom button state
    }

    async function fetchSheetData() {
      // (Same as previous version - handles fetching and JSONP parsing)
      const response = await fetch(`${baseURL}&_=${Date.now()}`);
      if (!response.ok) throw new Error(`HTTP error ${response.status}`);
      const text = await response.text();
      if (!text.startsWith('/*O_o*/\ngoogle.visualization.Query.setResponse(')) {
        const jsonStartIndex = text.indexOf('{');
        if (jsonStartIndex === -1) throw new Error('Invalid response format (JSONP wrapper not found).');
        const jsonEndIndex = text.lastIndexOf('}');
        if (jsonEndIndex === -1 || jsonEndIndex < jsonStartIndex) throw new Error('Invalid response format (JSON structure incomplete).');
        const potentialJson = text.substring(jsonStartIndex, jsonEndIndex + 1);
         try { return JSON.parse(potentialJson); } catch (e) {
            console.error("Failed to parse potential JSON:", e, "\nReceived text:", text);
            throw new Error('Failed to parse JSON data from response.'); }
      }
      try { return JSON.parse(text.substring(47, text.length - 2)); } catch (e) {
        console.error("Failed to parse JSONP:", e, "\nReceived text:", text);
        throw new Error('Failed to parse JSON data from JSONP.'); }
    }

    // --- Formatting Helpers ---
    const padZero = num => num.toString().padStart(2, '0');
    const formatDateBR = date => {
        if (!date || isNaN(date.getTime())) return '–';
        return `${padZero(date.getUTCDate())}/${padZero(date.getUTCMonth() + 1)}/${date.getUTCFullYear()}`;
    };
    const formatMonthYear = date => {
        if (!date || isNaN(date.getTime())) return '–';
        const month = date.toLocaleDateString('pt-BR', { month: 'short', timeZone: 'UTC' });
        const year = date.getUTCFullYear();
        return `${month}/${year}`;
    };
    function parseDateValue(value) {
        // (Same robust date parsing as previous version)
        if (value instanceof Date) return value;
        if (value == null || value === '') return null;
        if (typeof value === 'number' && value > 1 && value < 60000) {
             const utcDays = Math.floor(value - 25569); const date = new Date(0);
             date.setUTCDate(date.getUTCDate() + utcDays); return date; }
        if (typeof value === 'string') {
            let match = value.match(/^Date\((\d{4}),\s*(\d{1,2}),\s*(\d{1,2})/);
            if (match) return new Date(Date.UTC(+match[1], +match[2], +match[3]));
            match = value.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (match) return new Date(Date.UTC(+match[1], +match[2] - 1, +match[3]));
             match = value.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);
            if (match) { let year = +match[3]; if (year < 100) year += 2000;
                return new Date(Date.UTC(year, +match[2] - 1, +match[1])); } }
         const parsed = new Date(value);
         if (!isNaN(parsed.getTime())) return new Date(Date.UTC(parsed.getFullYear(), parsed.getMonth(), parsed.getDate()));
        return null;
    }
    const formatCurrency = value => typeof value === 'number' && !isNaN(value) ? value.toLocaleString('pt-BR', CURRENCY_FORMAT) : '–';
    const formatCompact = value => typeof value === 'number' && !isNaN(value) ? value.toLocaleString('pt-BR', { notation: 'compact', maximumFractionDigits: 1 }) : 'N/A';
    const formatTooltip = value => typeof value === 'number' ? formatCurrency(value) : 'N/A';

    // --- Data Loading and UI Building ---
    async function loadData() {
      // (Same as previous version - handles loading state, fetch, processing, UI updates)
      if (isFetching) return; isFetching = true;
      $errorMsg.classList.add('hidden'); if (!isLoaded) $loader.classList.remove('hidden');
      try {
        const jsonData = await fetchSheetData();
        if (!jsonData || !jsonData.table || !jsonData.table.cols) throw new Error("Dados da planilha incompletos/mal formatados.");
        headersFull = jsonData.table.cols.map(col => col.label || `Col${col.id}`);
        const obsIndex = headersFull.findIndex(h => h && h.toLowerCase().trim() === 'observação');
        headersDisplay = obsIndex === -1 ? [...headersFull] : headersFull.slice(0, obsIndex + 1);
        sheetRows = jsonData.table.rows.map(row => {
          const cells = Array(headersFull.length).fill(null);
          if (row?.c) { row.c.forEach((cell, i) => { if (i < headersFull.length) cells[i] = cell?.v ?? null; }); }
          return cells; });
        if (!isLoaded) { buildInitialUI(); isLoaded = true; switchTab('table'); }
        else { updateUI(); }
        updateGrandTotalHeader();
        $lastUpdate.textContent = `Atualizado: ${new Date().toLocaleTimeString('pt-BR')}`;
      } catch (error) {
        console.error("Erro ao carregar dados:", error);
        $errorMsg.textContent = `Erro: ${error.message}. Verifique ID/GID e permissões da Planilha.`;
        $errorMsg.classList.remove('hidden'); $tableWrapper.classList.add('hidden'); $chartWrapper.classList.add('hidden');
      } finally { isFetching = false; $loader.classList.add('hidden'); }
    }
    loadData(); setInterval(loadData, REFRESH_INTERVAL);

    function buildTable() {
      $sheetTable.innerHTML = '';
      const thead = createTableHead(); const tbody = createTableBody();
      if (thead) $sheetTable.appendChild(thead); if (tbody) $sheetTable.appendChild(tbody);
      applyCurrentZoom(); // Apply zoom after building structure
      applyFilters();
    }

    function createTableHead() {
      // (Mostly same as previous version - creates thead, tr, th with filters)
        const thead = document.createElement('thead');
        const tr = document.createElement('tr');
        tr.className = 'divide-x divide-primary-500/30';
        headersDisplay.forEach((header, index) => {
            const th = document.createElement('th');
            th.className = 'px-2 py-2 sm:px-4 sm:py-3 text-left text-xs font-semibold text-primary-500 uppercase whitespace-nowrap';
            const headerText = document.createElement('span'); headerText.textContent = header;
            th.appendChild(headerText);
            const select = document.createElement('select'); select.dataset.colIndex = index;
            select.className = 'mt-1 block w-full'; // Style via CSS
            select.innerHTML = '<option value="">Todos</option>';
            const uniqueValues = [...new Set(sheetRows.map(row => formatCellValue(row[index], header)))]
                .filter(value => value !== '–' && value !== null && value !== '')
                .sort((a, b) => String(a).localeCompare(String(b), 'pt-BR', { numeric: true }));
            uniqueValues.forEach(value => { const opt = document.createElement('option'); opt.value = value; opt.textContent = value; select.appendChild(opt); });
            if (activeFilters[index]) { select.value = activeFilters[index]; }
            select.onchange = handleFilterChange; th.appendChild(select); tr.appendChild(th); });
        thead.appendChild(tr); return thead;
    }

    function handleFilterChange(event) {
      // (Same as previous version)
        const colIndex = event.target.dataset.colIndex; const value = event.target.value;
        if (value) { activeFilters[colIndex] = value; } else { delete activeFilters[colIndex]; }
        applyFilters();
    }

    function createTableBody() {
      // (Mostly same as previous version - creates tbody and rows)
      const tbody = document.createElement('tbody');
      tbody.className = 'divide-y divide-slate-600/60';
      if (sheetRows.length === 0) { /* ... handle no data ... */ return tbody; }
      const noDataFilteredRow = document.createElement('tr'); noDataFilteredRow.style.display = 'none'; noDataFilteredRow.id = 'no-data-filtered-row';
      const noDataFilteredCell = document.createElement('td'); noDataFilteredCell.colSpan = headersDisplay.length || 1; noDataFilteredCell.textContent = 'Nenhum dado corresponde aos filtros.'; noDataFilteredCell.className = 'px-4 py-10 text-center text-slate-400';
      noDataFilteredRow.appendChild(noDataFilteredCell); tbody.appendChild(noDataFilteredRow);
      sheetRows.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        tr.className = `${rowIndex % 2 ? 'bg-surface/70' : 'bg-surface/60'} hover:bg-primary-500/10 transition-colors duration-150`;
        tr.dataset.rowIndex = rowIndex;
        headersDisplay.forEach((header, colIndex) => {
          const td = document.createElement('td'); td.className = 'px-2 py-2 sm:px-4 sm:py-3 whitespace-nowrap';
          td.textContent = formatCellValue(row[colIndex], header); tr.appendChild(td); });
        tbody.appendChild(tr); });
      return tbody;
    }

    function formatCellValue(cellValue, headerLabel) {
      // (Same robust formatting as previous version)
        if (cellValue == null || cellValue === '') return '–';
        const headerLower = headerLabel.toLowerCase().trim();
        if (headerLower === 'nf') return String(cellValue);
        if (/valor|total|preço/i.test(headerLower) && !/nf/i.test(headerLower)) {
            let numVal = NaN; if (typeof cellValue === 'number') numVal = cellValue;
            else if (typeof cellValue === 'string') { const cleaned = cellValue.replace(/[R$.]/g, '').replace(',', '.'); numVal = parseFloat(cleaned); }
            return !isNaN(numVal) ? formatCurrency(numVal) : String(cellValue); }
        const dateValue = parseDateValue(cellValue);
        if (dateValue && !isNaN(dateValue.getTime())) { if (/data|venc|pag|emissao/i.test(headerLower)) return formatDateBR(dateValue); }
        if (typeof cellValue === 'number') return cellValue.toLocaleString('pt-BR');
        if (typeof cellValue === 'string' && /^-?\d+(\.\d+)?$/.test(cellValue)) { const num = parseFloat(cellValue); if (!isNaN(num)) return num.toLocaleString('pt-BR'); }
        return String(cellValue);
    }

    // --- Filtering Logic ---
    function applyFilters() {
      // (Mostly same as previous version - applies filters, updates display, charts, total)
        const tbody = $sheetTable.querySelector('tbody'); if (!tbody) return;
        let visibleRowCount = 0; const filterEntries = Object.entries(activeFilters); const hasFilters = filterEntries.length > 0;
        Array.from(tbody.rows).forEach(tableRow => { if (tableRow.id === 'no-data-filtered-row') return; let showRow = true;
            if (hasFilters) { for (const [colIndexStr, filterValue] of filterEntries) { const colIndex = parseInt(colIndexStr, 10);
                if (filterValue && (!tableRow.cells[colIndex] || tableRow.cells[colIndex].textContent.trim() !== filterValue)) { showRow = false; break; }}}
            tableRow.style.display = showRow ? '' : 'none'; if (showRow) visibleRowCount++; });
        const noDataRow = tbody.querySelector('#no-data-filtered-row');
        if (noDataRow) noDataRow.style.display = (visibleRowCount === 0 && hasFilters) ? '' : 'none';
        updateFilterDisplay(); updateCharts(); updateGrandTotalHeader();
    }
    function updateFilterDisplay() {
      // (Same as previous version)
        const keys = Object.keys(activeFilters); if (keys.length === 0) { $filtersActive.textContent = 'Nenhum filtro ativo'; $clearFiltersBtn.style.display = 'none'; }
        else { const parts = keys.map(idx => `${headersDisplay[idx] || `Col ${idx + 1}`}: ${activeFilters[idx]}`);
            $filtersActive.textContent = 'Filtros: ' + parts.join(' | '); $clearFiltersBtn.style.display = 'inline-block'; }
    }
    function clearFilters() {
      // (Same as previous version)
        Object.keys(activeFilters).forEach(key => delete activeFilters[key]);
        $sheetTable.querySelectorAll('thead select').forEach(select => select.value = ''); applyFilters();
    }

    // --- Chart Data Aggregation ---
    function hasDataChanged(newData, prevData) { /* (Same) */ return !prevData || JSON.stringify(newData.labels) !== JSON.stringify(prevData.labels) || JSON.stringify(newData.totals) !== JSON.stringify(prevData.totals); }
    function aggregateData(dateColumnRegex, valueColumnRegex, aggregationType) { /* (Same generic aggregation) */
        const dateColIdx = headersFull.findIndex(h => h && dateColumnRegex.test(h.toLowerCase())); const valColIdx = headersFull.findIndex(h => h && valueColumnRegex.test(h.toLowerCase()));
        if (dateColIdx === -1 || valColIdx === -1) { console.warn("Coluna não encontrada para agregação"); return { labels: [], totals: [] }; }
        const aggMap = new Map(); getFilteredRows().forEach(row => { const date = parseDateValue(row[dateColIdx]); if (!date || isNaN(date.getTime())) return; let val = row[valColIdx]; if (val == null) return;
            val = typeof val === 'number' ? val : parseFloat(String(val).replace(/[R$\s.]/g, '').replace(',', '.')); if (isNaN(val)) return; let key;
            if (aggregationType === 'day') key = date.toISOString().split('T')[0]; else if (aggregationType === 'month') key = `${date.getUTCFullYear()}-${padZero(date.getUTCMonth())}`; else return;
            aggMap.set(key, (aggMap.get(key) || 0) + val); });
        const ordered = [...aggMap.entries()].sort((a, b) => a[0].localeCompare(b[0]));
        const labels = ordered.map(([k]) => aggregationType === 'day' ? formatDateBR(new Date(k + 'T00:00:00Z')) : formatMonthYear(new Date(Date.UTC(+k.split('-')[0], +k.split('-')[1], 1))));
        const totals = ordered.map(([_, v]) => v); return { labels, totals }; }
    function aggregateByDate(dateColumnRegex) { return aggregateData(dateColumnRegex, /valor/i, 'day'); }
    function aggregateByMonth(dateColumnRegex) { return aggregateData(dateColumnRegex, /valor/i, 'month'); }
    function getFilteredRows() { /* (Same logic using formatCellValue) */
        if (Object.keys(activeFilters).length === 0) return sheetRows;
        return sheetRows.filter(row => { for (const [colIdxStr, filterVal] of Object.entries(activeFilters)) { const colIdx = parseInt(colIdxStr, 10);
            const cellFmtVal = formatCellValue(row[colIdx], headersDisplay[colIdx]); if (filterVal && cellFmtVal.trim() !== filterVal) return false; } return true; }); }

    // --- Chart Rendering ---
    const baseChartOptions = { /* (Same base options) */
        chart: { foreColor: '#cbd5e1', toolbar: { show: true, tools: { download: true, selection: false, zoom: false, zoomin: false, zoomout: false, pan: false, reset: false } }, zoom: { enabled: false }, animations: { enabled: true, easing: 'easeinout', speed: 500, animateGradually: { enabled: false }, dynamicAnimation: { enabled: true, speed: 350 } }, background: 'transparent' },
        tooltip: { theme: 'dark', y: { formatter: formatTooltip } }, dataLabels: { enabled: false }, grid: { borderColor: '#475569', strokeDashArray: 4 }, legend: { show: false }, markers: { size: 4, hover: { size: 6 } },
        noData: { text: 'Sem dados para exibir', align: 'center', verticalAlign: 'middle', style: { color: '#cbd5e1', fontSize: '14px' } } };
    function buildCharts() { /* (Same build logic) */
        prevOverviewData = aggregateByDate(/venc/i); prevPaymentData = aggregateByDate(/pag/i); prevMonthlyData = aggregateByMonth(/venc/i);
        renderOverviewChart(false, prevOverviewData); renderPaymentChart(false, prevPaymentData); renderMonthlyChart(false, prevMonthlyData); }
    function updateCharts() { /* (Same update logic) */
        const newOverview = aggregateByDate(/venc/i); const newPayment = aggregateByDate(/pag/i); const newMonthly = aggregateByMonth(/venc/i);
        renderOverviewChart(true, newOverview); renderPaymentChart(true, newPayment); renderMonthlyChart(true, newMonthly); }
    function renderOverviewChart(isUpdate = false, data) { /* (Same render logic) */
        if (isUpdate && !hasDataChanged(data, prevOverviewData)) return;
        const opts = { series: [{ name: 'Total Venc.', data: data.totals }], xaxis: { categories: data.labels, labels: { rotate: -45, rotateAlways: false, hideOverlappingLabels: true, style: { fontSize: '10px' } }, tooltip: { enabled: false }, type: 'category' }, yaxis: { labels: { formatter: formatCompact } }, colors: [CHART_COLORS[0]], stroke: { curve: 'smooth', width: 2 }, fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1, stops: [0, 90, 100] } } };
        if (isUpdate && chartOverview) { chartOverview.updateOptions(opts, true, true); } else { chartOverview?.destroy(); chartOverview = new ApexCharts(document.querySelector('#chart-overview'), { ...baseChartOptions, chart: { ...baseChartOptions.chart, type: 'area', height: 280 }, ...opts }); chartOverview.render(); } prevOverviewData = data; }
    function renderPaymentChart(isUpdate = false, data) { /* (Same render logic) */
        if (isUpdate && !hasDataChanged(data, prevPaymentData)) return;
        const opts = { series: [{ name: 'Total Pago', data: data.totals }], xaxis: { categories: data.labels, labels: { rotate: -45, rotateAlways: false, hideOverlappingLabels: true, style: { fontSize: '10px' } }, tooltip: { enabled: false }, type: 'category' }, yaxis: { labels: { formatter: formatCompact } }, colors: [CHART_COLORS[1]], stroke: { curve: 'smooth', width: 2 }, fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1, stops: [0, 90, 100] } } };
        if (isUpdate && chartPayment) { chartPayment.updateOptions(opts, true, true); } else { chartPayment?.destroy(); chartPayment = new ApexCharts(document.querySelector('#chart-payment'), { ...baseChartOptions, chart: { ...baseChartOptions.chart, type: 'area', height: 280 }, ...opts }); chartPayment.render(); } prevPaymentData = data; }
    function renderMonthlyChart(isUpdate = false, data) { /* (Same render logic) */
        if (isUpdate && !hasDataChanged(data, prevMonthlyData)) return;
        const total = data.totals.reduce((s, t) => s + t, 0);
        const opts = { series: data.totals, labels: data.labels, colors: CHART_COLORS.slice(0, data.labels.length || CHART_COLORS.length), legend: { show: true, position: 'bottom', fontSize: '11px', horizontalAlign: 'center', itemMargin: { horizontal: 5, vertical: 2 } }, plotOptions: { pie: { donut: { size: '65%', labels: { show: true, total: { show: true, label: 'Total Geral', fontSize: '14px', fontWeight: 600, color: '#cbd5e1', formatter: () => formatCurrency(total) }, value: { show: true, fontSize: '16px', fontWeight: 500, color: '#cbd5e1', formatter: (v) => formatCurrency(parseFloat(v)) } } } } }, responsive: [{ breakpoint: 480, options: { chart: { height: 300 }, legend: { position: 'bottom', fontSize: '10px' }, plotOptions: { pie: { donut: { labels: { total: { fontSize: '12px'}, value: { fontSize: '14px'} } } } } } }] };
        if (isUpdate && chartMonthly) { chartMonthly.updateOptions(opts, true, true); } else { chartMonthly?.destroy(); chartMonthly = new ApexCharts(document.querySelector('#chart-monthly'), { ...baseChartOptions, chart: { ...baseChartOptions.chart, type: 'donut', height: 280 }, ...opts }); chartMonthly.render(); } prevMonthlyData = data; }

    // --- Header Update ---
    function updateGrandTotalHeader() { /* (Same logic) */
        const { totals } = aggregateByMonth(/venc/i); const grandTotal = totals.reduce((s, t) => s + t, 0);
        const suffix = Object.keys(activeFilters).length > 0 ? ' (Filtrado)' : '';
        $monthTotal.textContent = `Total Geral (Venc.)${suffix}: ${formatCurrency(grandTotal)}`; }

    // --- Table Zoom Functions ---
    function applyCurrentZoom() {
        // Apply font size to thead and tbody for better control
        const thead = $sheetTable?.querySelector('thead');
        const tbody = $sheetTable?.querySelector('tbody');
        if (thead) thead.style.fontSize = `${currentZoomLevel}px`;
        if (tbody) tbody.style.fontSize = `${currentZoomLevel}px`;
        updateZoomButtons();
    }
    function zoomInTable() {
        if (currentZoomLevel < MAX_ZOOM_PX) {
            currentZoomLevel = Math.min(currentZoomLevel + ZOOM_STEP_PX, MAX_ZOOM_PX);
            applyCurrentZoom(); }
    }
    function zoomOutTable() {
        if (currentZoomLevel > MIN_ZOOM_PX) {
            currentZoomLevel = Math.max(currentZoomLevel - ZOOM_STEP_PX, MIN_ZOOM_PX);
            applyCurrentZoom(); }
    }
    function updateZoomButtons() {
        if (!$zoomInBtn || !$zoomOutBtn) return;
        $zoomInBtn.disabled = currentZoomLevel >= MAX_ZOOM_PX;
        $zoomOutBtn.disabled = currentZoomLevel <= MIN_ZOOM_PX;
    }

    // --- Browser FullScreen Functions ---
    function isFullScreen() {
        return !!(document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
    }

    function toggleFullScreen() {
        if (!isFullScreen()) {
            const element = document.documentElement; // Request fullscreen for the whole page
            if (element.requestFullscreen) { element.requestFullscreen(); }
            else if (element.mozRequestFullScreen) { element.mozRequestFullScreen(); } // Firefox
            else if (element.webkitRequestFullscreen) { element.webkitRequestFullscreen(); } // Chrome, Safari, Opera
            else if (element.msRequestFullscreen) { element.msRequestFullscreen(); } // IE/Edge
        } else {
            if (document.exitFullscreen) { document.exitFullscreen(); }
            else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); }
            else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
            else if (document.msExitFullscreen) { document.msExitFullscreen(); }
        }
    }

    function updateFullscreenButton() {
        if (!$toggleFullscreenBtn) return;
        const buttonTextSpan = $toggleFullscreenBtn.querySelector('.button-text');
        const buttonIcon = $toggleFullscreenBtn.querySelector('svg');

        if (isFullScreen()) {
            if (buttonTextSpan) buttonTextSpan.textContent = 'Sair Tela Cheia';
            // Change icon to "compress"
            if (buttonIcon) buttonIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9 3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5 5.25 5.25" />';
            $toggleFullscreenBtn.title = 'Sair Tela Cheia';
        } else {
            if (buttonTextSpan) buttonTextSpan.textContent = 'Tela Cheia';
            // Change icon back to "expand"
             if (buttonIcon) buttonIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />';
             $toggleFullscreenBtn.title = 'Entrar Tela Cheia';
        }
    }

    // Listen for fullscreen changes (e.g., user pressing ESC)
    document.addEventListener('fullscreenchange', updateFullscreenButton);
    document.addEventListener('mozfullscreenchange', updateFullscreenButton);
    document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
    document.addEventListener('msfullscreenchange', updateFullscreenButton);

    // --- Initial Setup & Updates ---
    function buildInitialUI() {
        buildTable(); buildCharts();
        updateFullscreenButton(); // Set initial button state
    }
    function updateUI() {
        buildTable(); // Rebuilds table, applies zoom, applies filters (which updates charts)
    }

  </script>
</body>
</html>
