<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • Google Sheets</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
        extend: {
          colors: {
            surface: '#212529',
            primary: { 300: '#99d2fa', 500: '#4dabf7' },
            slate: { 300: '#cbd5e1', 400: '#94a3b8', 600: '#475569' }
          },
          boxShadow: { glow: '0 0 8px rgba(77,171,247,.35)' },
          backdropBlur: { xs: '2px' }
        }
      }
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.46.0"></script>

  <style>
    @keyframes spin { to { transform: rotate(360deg) } }
    .animate-spin { animation: spin 1s linear infinite }
    html, body { height: 100%; }
    body { background: #1a1d21; display: flex; flex-direction: column; }

    main { flex-grow: 1; display: flex; flex-direction: column; }

    #table-wrapper {
        flex-grow: 1;
        overflow: auto;
        max-width: 100%;
        -webkit-overflow-scrolling: touch;
    }
    #charts-wrapper {
        flex-grow: 1;
        overflow-y: auto;
    }
    #sheetTable { width: 100%; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px }

    /* Table Header Filter */
    th select {
      background: #212529; border: 1px solid #4dabf7; border-radius: 4px;
      font-size: 12px; padding: 6px 8px; width: 100%; margin-top: 4px;
      color: #cbd5e1;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234dabf7%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 0.65em auto;
      padding-right: 2rem;
    }
    th select:focus { outline: none; border-color: #4dabf7; box-shadow: 0 0 0 2px rgba(77, 171, 247, 0.3); }

    /* Active Tab */
    .tab-btn.active-tab {
      background: #4dabf7; color: #fff !important;
      box-shadow: 0 0 5px rgba(77, 171, 247, .55)
    }
    .chart-card { transition: background-color 0.3s ease; }

    button:focus-visible, select:focus-visible {
      outline: 2px solid #4dabf7; outline-offset: 2px;
    }

    /* --- Full-Screen Table Styles --- */
    main.table-full-screen {
        max-width: none; padding: 0; gap: 0;
    }
     main.table-full-screen > div:nth-of-type(1) { /* Tab buttons container */
         padding: 0.5rem 0.75rem; flex-shrink: 0;
         border-bottom: 1px solid #475569; background-color: #1a1d21;
     }
     main.table-full-screen > #filters-bar {
         padding: 0.5rem 0.75rem; flex-shrink: 0;
         border-bottom: 1px solid #475569; background-color: #1a1d21;
     }
    main.table-full-screen > #table-wrapper { border-radius: 0; }
     main.table-full-screen #sheetTable thead th {
         position: sticky; top: 0; z-index: 10;
     }
     /* --- End Full-Screen Table Styles --- */

     /* Mobile specific table cell padding */
     #sheetTable th, #sheetTable td { padding: 0.5rem 0.5rem; }
     @media (min-width: 640px) { /* sm breakpoint */
         #sheetTable th, #sheetTable td { padding: 0.75rem 1rem; }
     }

  </style>
</head>
<body class="text-slate-300 min-h-screen flex flex-col antialiased">

  <header class="w-full backdrop-blur-sm bg-surface/80 border-b border-primary-500/40 sticky top-0 z-40 flex-shrink-0">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex flex-col">
        <div class="flex justify-between items-center w-full">
            <h1 class="text-base sm:text-lg font-bold text-primary-500 truncate pr-2">Dashboard Sheets</h1>
            <button id="manual-refresh"
                    class="px-2.5 py-1 sm:px-3 sm:py-1.5 rounded-md border border-primary-500 bg-primary-500/10 hover:bg-primary-500/20
                           text-primary-300 text-xs font-medium shadow-glow flex-shrink-0">
              Atualizar
            </button>
        </div>
        <div class="flex justify-between items-center w-full mt-1">
            <span id="month-total" class="text-primary-300 font-medium text-xs truncate pr-2">Carregando total...</span>
            <span id="last-update" class="text-slate-400 text-xs flex-shrink-0">Carregando...</span>
        </div>
    </div>
  </header>
  <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900/80 backdrop-blur-md">
    <div class="h-10 w-10 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="text-primary-300 text-base font-medium">Carregando…</p>
  </div>

  <main id="main-content" class="w-full max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col gap-4 sm:gap-6 flex-grow">
    <div class="flex justify-center space-x-2 sm:space-x-4 flex-shrink-0">
      <button id="tab-table" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:bg-primary-500/10 transition-colors duration-200">Tabela</button>
      <button id="tab-charts" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:bg-primary-500/10 transition-colors duration-200">Gráficos</button>
    </div>

    <div id="filters-bar" class="flex flex-wrap items-center justify-center gap-2 sm:gap-3 flex-shrink-0">
      <span id="filters-active" class="text-primary-300 text-xs text-center w-full sm:w-auto">Nenhum filtro ativo</span>
      <button id="clear-filters"
              class="px-3 py-1 rounded-md border border-primary-500 bg-primary-500/10 hover:bg-primary-500/20
                     text-primary-300 text-xs font-medium shadow-glow" style="display: none;">
        Limpar Filtros
      </button>
    </div>

    <div id="error-message"
         class="hidden w-full p-3 text-center text-red-300 bg-red-800/40 border border-red-600 rounded-lg text-sm flex-shrink-0"></div>

    <section id="table-wrapper"
             class="hidden w-full backdrop-blur-xs bg-surface/70 rounded-lg sm:rounded-2xl
                    shadow-lg ring-1 ring-primary-500/20 p-0">
      <table id="sheetTable" class="min-w-full text-sm divide-y divide-slate-600/60">
         </table>
    </section>

    <section id="charts-wrapper"
             class="hidden w-full grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
      <div class="chart-card bg-surface/80 rounded-lg sm:rounded-2xl shadow-lg ring-1 ring-primary-500/20 p-4 md:col-span-2">
        <h2 class="text-base font-semibold mb-3 text-primary-500">Total por Data de Vencimento</h2>
        <div id="chart-overview"></div>
      </div>

      <div class="chart-card bg-surface/80 rounded-lg sm:rounded-2xl shadow-lg ring-1 ring-primary-500/20 p-4">
        <h2 class="text-base font-semibold mb-3 text-primary-500">Total por Data de Pagamento</h2>
        <div id="chart-payment"></div>
      </div>

      <div class="chart-card bg-surface/80 rounded-lg sm:rounded-2xl shadow-lg ring-1 ring-primary-500/20 p-4">
        <h2 class="text-base font-semibold mb-3 text-primary-500">Total por Mês (Vencimento)</h2>
        <div id="chart-monthly"></div>
      </div>
    </section>
  </main>

  <script>
    // --- CONSTANTS AND VARIABLES ---
    const sheetId = '1du2FRGYbmY1mQ_mbNN1HuvQc8QhY3Bqq';
    const gid     = '0';
    const baseURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
    const REFRESH_INTERVAL = 60000;
    const CURRENCY_FORMAT = { style: 'currency', currency: 'BRL', maximumFractionDigits: 2 };
    const CHART_COLORS = ['#4dabf7', '#4ade80', '#fb7185', '#facc15', '#a78bfa', '#2dd4bf'];

    let headersFull = [], sheetRows = [];
    let headersDisplay = [];
    let chartOverview, chartPayment, chartMonthly;
    let isLoaded = false, isFetching = false;
    const activeFilters = {};

    let prevOverviewData = null, prevPaymentData = null, prevMonthlyData = null;

    // --- DOM ELEMENTS ---
    const $loader = document.getElementById('loader');
    const $errorMsg = document.getElementById('error-message');
    const $tableTab = document.getElementById('tab-table');
    const $chartTab = document.getElementById('tab-charts');
    const $tableWrapper = document.getElementById('table-wrapper');
    const $chartWrapper = document.getElementById('charts-wrapper');
    const $sheetTable = document.getElementById('sheetTable');
    const $lastUpdate = document.getElementById('last-update');
    const $monthTotal = document.getElementById('month-total');
    const $filtersActive = document.getElementById('filters-active');
    const $clearFiltersBtn = document.getElementById('clear-filters');
    const $mainContent = document.getElementById('main-content');
    const $manualRefreshBtn = document.getElementById('manual-refresh'); // Get refresh button

    // --- EVENT LISTENERS ---
    $manualRefreshBtn.onclick = loadData;
    $tableTab.onclick = () => switchTab('table');
    $chartTab.onclick = () => switchTab('charts');
    $clearFiltersBtn.onclick = clearFilters;

    // --- CORE FUNCTIONS ---
    function switchTab(tabId) {
      [$tableTab, $chartTab].forEach(btn => btn.classList.remove('active-tab'));
      if (tabId === 'table') {
        $tableWrapper.classList.remove('hidden');
        $chartWrapper.classList.add('hidden');
        $tableTab.classList.add('active-tab');
        $mainContent.classList.add('table-full-screen');
      } else {
        $chartWrapper.classList.remove('hidden');
        $tableWrapper.classList.add('hidden');
        $chartTab.classList.add('active-tab');
        $mainContent.classList.remove('table-full-screen');
        setTimeout(() => [chartOverview, chartPayment, chartMonthly].forEach(chart => {
            if (chart && typeof chart.updateOptions === 'function') chart.updateOptions({}, false, false, false);
        }), 50);
      }
    }

    async function fetchSheetData() {
      const response = await fetch(`${baseURL}&_=${Date.now()}`);
      if (!response.ok) throw new Error(`HTTP error ${response.status}`);
      const text = await response.text();
      if (!text.startsWith('/*O_o*/\ngoogle.visualization.Query.setResponse(')) {
        throw new Error('Invalid response format');
      }
      try {
        return JSON.parse(text.substring(47, text.length - 2));
      } catch (e) {
        console.error("JSON parse failed:", e, text);
        throw new Error('Failed to parse JSON');
      }
    }

    // --- FORMATTING HELPERS ---
    const padZero = num => num.toString().padStart(2, '0');
    const formatDateBR = date => !date || isNaN(date.getTime()) ? '–' : `${padZero(date.getUTCDate())}/${padZero(date.getUTCMonth() + 1)}/${date.getUTCFullYear()}`;
    const formatMonthYear = date => {
        if (!date || isNaN(date.getTime())) return '–';
        const month = date.toLocaleDateString('pt-BR', { month: 'short', timeZone: 'UTC' });
        return `${month}/${date.getUTCFullYear()}`;
    };
    function parseDateValue(value) {
        if (value instanceof Date) return value; if (value == null) return null;
        if (typeof value === 'number' && value > 1 && value < 60000) { const d = new Date(0); d.setUTCDate(d.getUTCDate() + Math.floor(value - 25569)); return d; }
        if (typeof value !== 'string') return null; let m;
        m = value.match(/^Date\((\d{4}),\s*(\d{1,2}),\s*(\d{1,2})/); if (m) return new Date(Date.UTC(+m[1], +m[2], +m[3]));
        m = value.match(/^(\d{4})-(\d{2})-(\d{2})/); if (m) return new Date(Date.UTC(+m[1], +m[2] - 1, +m[3]));
        m = value.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/); if (m) { let y = +m[3]; if (y < 100) y += 2000; return new Date(Date.UTC(y, +m[2] - 1, +m[1])); }
        const p = new Date(value); if (!isNaN(p.getTime())) return new Date(Date.UTC(p.getFullYear(), p.getMonth(), p.getDate())); return null;
    }
    const formatCurrency = value => typeof value === 'number' && !isNaN(value) ? value.toLocaleString('pt-BR', CURRENCY_FORMAT) : '–';
    const formatCompact = value => typeof value === 'number' && !isNaN(value) ? value.toLocaleString('pt-BR', { notation: 'compact', maximumFractionDigits: 1 }) : 'N/A';
    const formatTooltip = value => typeof value === 'number' ? formatCurrency(value) : 'N/A';

    // --- DATA LOADING & UI ---
    async function loadData() {
      if (isFetching) return;
      isFetching = true;
      $errorMsg.classList.add('hidden');
      $manualRefreshBtn.disabled = true; // Disable button during fetch
      $manualRefreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
      if (!isLoaded) $loader.classList.remove('hidden');

      try {
        const jsonData = await fetchSheetData();
        if (!jsonData?.table?.cols) throw new Error("Data format invalid");

        headersFull = jsonData.table.cols.map(col => col.label || `Col${col.id}`);
        const obsIndex = headersFull.findIndex(h => h?.toLowerCase().trim() === 'observação');
        headersDisplay = obsIndex === -1 ? [...headersFull] : headersFull.slice(0, obsIndex + 1);
        sheetRows = jsonData.table.rows.map(row => {
          const cells = Array(headersFull.length).fill(null);
          row?.c?.forEach((cell, i) => { if (i < headersFull.length) cells[i] = cell?.v ?? null });
          return cells;
        });

        if (!isLoaded) { buildInitialUI(); isLoaded = true; switchTab('table'); }
        else { updateUI(); }
        updateGrandTotalHeader();
        $lastUpdate.textContent = `Atualizado: ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`; // Shorter time format

      } catch (error) {
        console.error("Load data error:", error);
        $errorMsg.textContent = `Erro: ${error.message}.`;
        $errorMsg.classList.remove('hidden');
        if (!isLoaded) { $tableWrapper.classList.add('hidden'); $chartWrapper.classList.add('hidden'); } // Hide sections if first load failed
      } finally {
        isFetching = false;
        $loader.classList.add('hidden');
        $manualRefreshBtn.disabled = false; // Re-enable button
        $manualRefreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }
    loadData();
    setInterval(loadData, REFRESH_INTERVAL);

    function buildTable() {
      $sheetTable.innerHTML = '';
      const thead = createTableHead(); const tbody = createTableBody();
      if (thead) $sheetTable.appendChild(thead); if (tbody) $sheetTable.appendChild(tbody);
      applyFilters();
    }

    function createTableHead() {
        const thead = document.createElement('thead'); thead.className = 'bg-surface/90';
        const tr = document.createElement('tr'); tr.className = 'divide-x divide-primary-500/30';
        headersDisplay.forEach((header, index) => {
            const th = document.createElement('th');
            th.className = 'text-left text-xs font-semibold text-primary-500 uppercase bg-surface/95 whitespace-nowrap'; // Padding from global CSS
            const headerText = document.createElement('span'); headerText.textContent = header; th.appendChild(headerText);
            const select = document.createElement('select'); select.dataset.colIndex = index;
            select.className = 'mt-1 block w-full'; select.innerHTML = '<option value="">Todos</option>';
            const uniqueValues = [...new Set(sheetRows.map(row => formatCellValue(row[index], header)))]
                .sort((a, b) => { if (a === '–') return -1; if (b === '–') return 1; try { return a.localeCompare(b, 'pt-BR', { numeric: true }); } catch (e) { return a < b ? -1 : (a > b ? 1 : 0); } });
            uniqueValues.forEach(value => { if (value === '–' || value == null || value === '') return; const opt = document.createElement('option'); opt.value = value; opt.textContent = value; select.appendChild(opt); });
            if (activeFilters[index]) select.value = activeFilters[index];
            select.onchange = handleFilterChange; th.appendChild(select); tr.appendChild(th);
        });
        thead.appendChild(tr); return thead;
    }

    function handleFilterChange(event) {
        const colIndex = event.target.dataset.colIndex; const value = event.target.value;
        if (value) activeFilters[colIndex] = value; else delete activeFilters[colIndex];
        applyFilters();
    }

    function createTableBody() {
        const tbody = document.createElement('tbody'); tbody.className = 'divide-y divide-slate-600/60';
        if (sheetRows.length === 0) { const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan = headersDisplay.length || 1; td.textContent = 'Nenhum dado encontrado.'; td.className = 'px-4 py-8 text-center text-slate-400 text-sm'; tr.appendChild(td); tbody.appendChild(tr); return tbody; }
        sheetRows.forEach((row, rowIndex) => {
            const tr = document.createElement('tr'); tr.className = `${rowIndex % 2 ? 'bg-surface/70' : 'bg-surface/60'} hover:bg-primary-500/10 transition-colors duration-150`;
            headersDisplay.forEach((header, colIndex) => {
                const td = document.createElement('td'); td.className = 'whitespace-nowrap'; // Padding from global CSS
                td.textContent = formatCellValue(row[colIndex], header); tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        return tbody;
    }

    function formatCellValue(cellValue, headerLabel) {
        if (cellValue == null || cellValue === '') return '–'; const headerLower = headerLabel.toLowerCase().trim();
        if (headerLower === 'nf') return String(cellValue);
        if (/valor|total|preço/i.test(headerLower) && !/nf/i.test(headerLower)) { let n = NaN; if (typeof cellValue === 'number') n = cellValue; else if (typeof cellValue === 'string') n = parseFloat(cellValue.replace(/[R$.]/g, '').replace(',', '.')); return !isNaN(n) ? formatCurrency(n) : String(cellValue); }
        const d = parseDateValue(cellValue); if (d && !isNaN(d.getTime())) { if (/data|venc|pag|emissao/i.test(headerLower)) return formatDateBR(d); }
        if (typeof cellValue === 'number') return cellValue.toLocaleString('pt-BR'); if (typeof cellValue === 'string' && /^-?\d+(\.\d+)?$/.test(cellValue)) { const num = parseFloat(cellValue); if (!isNaN(num)) return num.toLocaleString('pt-BR'); }
        return String(cellValue);
    }

    // --- FILTERING ---
    function applyFilters() {
        const tbody = $sheetTable.querySelector('tbody'); if (!tbody) return; let visibleRowCount = 0;
        Array.from(tbody.rows).forEach(tr => {
            if (tr.cells.length === 1 && tr.cells[0].colSpan > 1) { tr.style.display = 'none'; return; } let show = true;
            for (const [idx, val] of Object.entries(activeFilters)) { if (val && tr.cells[idx]?.textContent.trim() !== val) { show = false; break; } }
            tr.style.display = show ? '' : 'none'; if (show) visibleRowCount++;
        });
        const noDataRow = tbody.querySelector('td[colspan]'); if (noDataRow) noDataRow.parentElement.style.display = visibleRowCount === 0 ? '' : 'none';
        updateFilterDisplay(); updateCharts(); updateGrandTotalHeader();
    }

    function updateFilterDisplay() {
        const keys = Object.keys(activeFilters);
        if (keys.length === 0) { $filtersActive.textContent = 'Nenhum filtro ativo'; $clearFiltersBtn.style.display = 'none'; $filtersActive.classList.add('w-full'); }
        else { const parts = keys.map(i => `${headersDisplay[i]}: ${activeFilters[i]}`); $filtersActive.textContent = 'Filtros: ' + parts.join(' | '); $clearFiltersBtn.style.display = 'inline-block'; $filtersActive.classList.remove('w-full'); }
    }

    function clearFilters() {
        Object.keys(activeFilters).forEach(key => delete activeFilters[key]);
        $sheetTable.querySelectorAll('thead select').forEach(sel => sel.value = ''); applyFilters();
    }

    // --- CHART DATA AGGREGATION ---
    function hasDataChanged(newData, prevData) { return !prevData || JSON.stringify(newData.labels) !== JSON.stringify(prevData.labels) || JSON.stringify(newData.totals) !== JSON.stringify(prevData.totals); }
    function aggregateByDate(dateColRegex) {
        const dateIdx = headersFull.findIndex(h => h && dateColRegex.test(h.toLowerCase())); const valIdx = headersFull.findIndex(h => h && /valor/i.test(h.toLowerCase()) && !/nf/i.test(h.toLowerCase())); if (dateIdx === -1 || valIdx === -1) return { labels: [], totals: [] };
        const map = new Map(); getFilteredRows().forEach(row => { const d = parseDateValue(row[dateIdx]); if (!d || isNaN(d.getTime())) return; const key = d.toISOString().split('T')[0]; let v = row[valIdx]; if (v == null) return; v = typeof v === 'number' ? v : parseFloat(String(v).replace(/[R$\s.]/g, '').replace(',', '.')); if (!isNaN(v)) map.set(key, (map.get(key) || 0) + v); });
        const entries = [...map.entries()].sort((a, b) => a[0].localeCompare(b[0])); return { labels: entries.map(([k]) => formatDateBR(new Date(k + 'T00:00:00Z'))), totals: entries.map(([_, v]) => v) };
    }
    function aggregateByMonth(dateColRegex) {
        const dateIdx = headersFull.findIndex(h => h && dateColRegex.test(h.toLowerCase())); const valIdx = headersFull.findIndex(h => h && /valor/i.test(h.toLowerCase()) && !/nf/i.test(h.toLowerCase())); if (dateIdx === -1 || valIdx === -1) return { labels: [], totals: [] };
        const map = new Map(); getFilteredRows().forEach(row => { const d = parseDateValue(row[dateIdx]); if (!d || isNaN(d.getTime())) return; const key = `${d.getUTCFullYear()}-${padZero(d.getUTCMonth())}`; let v = row[valIdx]; if (v == null) return; v = typeof v === 'number' ? v : parseFloat(String(v).replace(/[R$\s.]/g, '').replace(',', '.')); if (!isNaN(v)) map.set(key, (map.get(key) || 0) + v); });
        const entries = [...map.entries()].sort((a, b) => a[0].localeCompare(b[0])); return { labels: entries.map(([k]) => { const [y, m] = k.split('-'); return formatMonthYear(new Date(Date.UTC(+y, +m, 1))); }), totals: entries.map(([_, v]) => v) };
    }
    function getFilteredRows() { if (Object.keys(activeFilters).length === 0) return sheetRows; return sheetRows.filter(row => { for (const [idx, val] of Object.entries(activeFilters)) { const cellVal = formatCellValue(row[idx], headersDisplay[idx]); if (val && cellVal.trim() !== val) return false; } return true; }); }

    // --- CHART RENDERING ---
    const baseChartOptions = { chart: { foreColor: '#cbd5e1', toolbar: { show: false }, zoom: { enabled: false }, animations: { enabled: true, easing: 'easeinout', speed: 500 }, background: 'transparent' }, tooltip: { theme: 'dark', y: { formatter: formatTooltip } }, dataLabels: { enabled: false }, grid: { borderColor: '#475569', strokeDashArray: 3, padding: { left: 0, right: 10 } }, legend: { show: false }, markers: { size: 0 }, noData: { text: 'Sem dados', align: 'center', verticalAlign: 'middle', style: { color: '#cbd5e1', fontSize: '12px' } } };
    const overviewOptions = { chart: { type: 'area', height: 220 }, xaxis: { categories: [], labels: { show: true, rotate: -45, rotateAlways: false, hideOverlappingLabels: true, style: { fontSize: '9px' }, format: undefined }, tooltip: { enabled: false }, type: 'category', tickAmount: 6 }, yaxis: { labels: { show: true, style: { fontSize: '10px' }, formatter: formatCompact } }, colors: [CHART_COLORS[0]], stroke: { curve: 'smooth', width: 2 }, fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1, stops: [0, 90, 100] } } };
    const paymentOptions = { ...overviewOptions, colors: [CHART_COLORS[1]] };
    const monthlyOptions = { chart: { type: 'donut', height: 220 }, labels: [], colors: CHART_COLORS, legend: { show: true, position: 'bottom', fontSize: '10px', horizontalAlign: 'center', itemMargin: { horizontal: 4, vertical: 1 }, offsetY: 0 }, plotOptions: { pie: { donut: { size: '70%', labels: { show: true, total: { show: true, label: 'Total', fontSize: '12px', fontWeight: 500, color: '#cbd5e1', formatter: (w) => formatCurrency(w.globals.seriesTotals.reduce((a, b) => a + b, 0)) }, value: { show: true, fontSize: '13px', fontWeight: 500, color: '#cbd5e1', formatter: (val) => formatCurrency(parseFloat(val)) } } } } }, responsive: [{ breakpoint: 400, options: { chart: { height: 200 }, legend: { fontSize: '9px', itemMargin: { horizontal: 2 } }, plotOptions: { pie: { donut: { size: '65%', labels: { total: { fontSize: '11px'}, value: { fontSize: '12px'} } } } } } }] };

    function buildCharts() { prevOverviewData = aggregateByDate(/venc/i); prevPaymentData = aggregateByDate(/pag/i); prevMonthlyData = aggregateByMonth(/venc/i); renderOverviewChart(false, prevOverviewData); renderPaymentChart(false, prevPaymentData); renderMonthlyChart(false, prevMonthlyData); }
    function updateCharts() { const d1 = aggregateByDate(/venc/i); const d2 = aggregateByDate(/pag/i); const d3 = aggregateByMonth(/venc/i); renderOverviewChart(true, d1); renderPaymentChart(true, d2); renderMonthlyChart(true, d3); }
    function renderOverviewChart(isUpdate = false, data) { if (isUpdate && !hasDataChanged(data, prevOverviewData)) return; const opts = { ...overviewOptions, series: [{ name: 'Total Venc.', data: data.totals }], xaxis: { ...overviewOptions.xaxis, categories: data.labels } }; if (isUpdate && chartOverview) chartOverview.updateOptions(opts, true, true); else { chartOverview?.destroy(); chartOverview = new ApexCharts(document.querySelector('#chart-overview'), { ...baseChartOptions, ...opts }); chartOverview.render(); } prevOverviewData = data; }
    function renderPaymentChart(isUpdate = false, data) { if (isUpdate && !hasDataChanged(data, prevPaymentData)) return; const opts = { ...paymentOptions, series: [{ name: 'Total Pago', data: data.totals }], xaxis: { ...paymentOptions.xaxis, categories: data.labels } }; if (isUpdate && chartPayment) chartPayment.updateOptions(opts, true, true); else { chartPayment?.destroy(); chartPayment = new ApexCharts(document.querySelector('#chart-payment'), { ...baseChartOptions, ...opts }); chartPayment.render(); } prevPaymentData = data; }
    function renderMonthlyChart(isUpdate = false, data) { const changed = !prevMonthlyData || JSON.stringify(data.totals) !== JSON.stringify(prevMonthlyData.totals); if (isUpdate && !changed) return; const total = data.totals.reduce((s, t) => s + t, 0); const opts = { ...monthlyOptions, series: data.totals, labels: data.labels, plotOptions: { pie: { donut: { ...monthlyOptions.plotOptions.pie.donut, labels: { ...monthlyOptions.plotOptions.pie.donut.labels, total: { ...monthlyOptions.plotOptions.pie.donut.labels.total, formatter: () => formatCurrency(total) } } } } } }; if (isUpdate && chartMonthly) chartMonthly.updateOptions(opts, true, true); else { chartMonthly?.destroy(); chartMonthly = new ApexCharts(document.querySelector('#chart-monthly'), { ...baseChartOptions, ...opts }); chartMonthly.render(); } prevMonthlyData = data; }

    // --- HEADER UPDATE ---
    function updateGrandTotalHeader() {
      const { totals } = aggregateByMonth(/venc/i);
      const grandTotal = totals.reduce((sum, monthTotal) => sum + monthTotal, 0);
      const filterSuffix = Object.keys(activeFilters).length > 0 ? ' (Filtrado)' : '';
      // Updated selector to match new header structure
      document.getElementById('month-total').textContent = `Total (Venc.)${filterSuffix}: ${formatCurrency(grandTotal)}`;
    }

    // --- INIT & UPDATES ---
    function buildInitialUI() { buildTable(); buildCharts(); }
    function updateUI() { buildTable(); /* updateCharts called within applyFilters */ }

  </script>
</body>
</html>
