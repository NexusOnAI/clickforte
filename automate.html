<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard â€¢ Google Sheets</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
        extend: {
          colors: {
            surface: '#212529',
            primary: { 500: '#4dabf7' },
            slate: { 300: '#cbd5e1', 400: '#94a3b8', 600: '#475569' }
          },
          boxShadow: { glow: '0 0 8px rgba(77,171,247,.35)' },
          backdropBlur: { xs: '2px' }
        }
      }
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.46.0"></script>

  <style>
    @keyframes spin { to { transform: rotate(360deg) } }
    .animate-spin { animation: spin 1s linear infinite }
    html, body { height: 100%; } /* Ensure html and body take full height */
    body { background: #1a1d21; display: flex; flex-direction: column; } /* Make body a flex column */

    /* Ensure main content area can grow */
    main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        /* Standard padding and max-width for default view */
        max-width: 1280px; /* max-w-screen-2xl */
        margin-left: auto;
        margin-right: auto;
        padding-left: 1rem; /* px-4 */
        padding-right: 1rem; /* px-4 */
        padding-top: 1.5rem; /* py-6 */
        padding-bottom: 1.5rem; /* py-6 */
        width: 100%;
        gap: 1.5rem; /* gap-6 */
        transition: max-width 0.3s ease, padding 0.3s ease; /* Smooth transition */
    }

    #table-wrapper {
        flex-grow: 1; /* Allow table wrapper to grow vertically */
        overflow: auto; /* Use auto for both horizontal and vertical scroll as needed */
        max-width: 100%;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        position: relative; /* Needed for sticky header positioning context */
        /* Default background/shadow/ring for non-fullscreen */
        backdrop-filter: blur(2px); /* backdrop-blur-xs */
        background-color: rgba(33, 37, 41, 0.7); /* bg-surface/70 */
        border-radius: 1rem; /* rounded-2xl */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
        /* ring-1 ring-primary-500/20 */
        box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
        --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
        --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) rgba(77, 171, 247, 0.2);
        padding: 0; /* p-0 is already set but good to confirm */
    }
    #charts-wrapper {
        flex-grow: 1; /* Allow charts wrapper to grow vertically */
        overflow-y: auto;
    }
    #sheetTable { width: 100%; }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 8px; height: 8px }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px }

    /* Table Header Filter Select Styling */
    th select {
      background: #212529; border: 1px solid #4dabf7; border-radius: 4px;
      font-size: 11px; padding: 4px 6px; width: 100%; margin-top: 4px;
      color: #cbd5e1;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234dabf7%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 0.65em auto;
      padding-right: 2rem;
    }
    th select:focus { outline: none; border-color: #4dabf7; box-shadow: 0 0 0 2px rgba(77, 171, 247, 0.3); }

    /* Active Tab Styling */
    .tab-btn.active-tab {
      background: #4dabf7; color: #fff !important;
      box-shadow: 0 0 5px rgba(77, 171, 247, .55)
    }
    .chart-card { transition: background-color 0.3s ease; }

    /* Focus Visible Styling */
    button:focus-visible, select:focus-visible {
      outline: 2px solid #4dabf7; outline-offset: 2px;
    }

    /* --- Styles for FULL PAGE TABLE VIEW (Layout-based) --- */
    main.table-full-screen {
        max-width: none;      /* Remove max-width constraint */
        padding: 0;           /* Remove all padding */
        gap: 0;               /* Remove gap between direct children */
    }
    /* Adjust padding/margins for tabs/filters containers when table is full screen */
    main.table-full-screen > div:first-of-type { /* Tab buttons container */
        padding: 0.5rem 1rem; /* Reduced padding */
        flex-shrink: 0;       /* Prevent shrinking */
        background-color: #1a1d21; /* Match body background */
    }
    main.table-full-screen > #filters-bar {
        padding: 0.5rem 1rem; /* Reduced padding */
        flex-shrink: 0;       /* Prevent shrinking */
        background-color: #1a1d21; /* Match body background */
        border-bottom: 1px solid #475569; /* Add separator */
    }
    /* Ensure table wrapper takes remaining space and looks seamless */
    main.table-full-screen > #table-wrapper {
        border-radius: 0;       /* Remove rounded corners */
        box-shadow: none;         /* Remove shadow */
        --tw-ring-shadow: none; /* Remove ring */
        backdrop-filter: none;  /* Remove backdrop blur */
        background-color: transparent; /* Make background transparent or match body */
        border-top: none;       /* Remove default top border if any */
        /* flex-grow: 1; is already set */
        /* overflow: auto; is already set */
    }
     /* Ensure sticky header inside the wrapper works in full-screen layout*/
    main.table-full-screen #sheetTable thead th {
        position: sticky;
        top: 0; /* Stick to the top of the scrollable #table-wrapper */
        z-index: 10; /* Ensure it's above table body */
        background-color: #212529; /* Explicit background for sticky */
    }
    /* --- End Full Page Table Styles --- */


    /* --- Styles for Native Full-Screen --- */
    /* Style the element being fullscreened */
    #main-content:fullscreen {
        overflow: hidden; /* Prevent scrollbars on the main element itself */
        padding: 0 !important; /* Remove padding when fullscreen */
        background-color: #1a1d21; /* Ensure background */
        display: flex;
        flex-direction: column;
    }
    /* Ensure the table wrapper takes all space within the fullscreen element */
     #main-content:fullscreen > #table-wrapper {
        height: 100%; /* Take full height */
        flex-grow: 1; /* Grow to fill space */
        border-radius: 0; /* Remove rounded corners */
        border: none; /* Remove borders */
        box-shadow: none; /* Remove shadow */
        --tw-ring-shadow: none; /* Remove ring */
        backdrop-filter: none; /* Remove blur */
        background-color: #1a1d21; /* Match background */
        overflow: auto; /* Allow scrolling within the table wrapper */
        padding: 0; /* Remove padding */
    }
     /* Hide other elements when main is fullscreen */
    #main-content:fullscreen > *:not(#table-wrapper) {
        display: none !important;
    }
     /* Ensure sticky header works within fullscreen table wrapper */
    #main-content:fullscreen #sheetTable thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #212529; /* Ensure background */
    }

    /* Basic styles for zoom controls */
    .zoom-control {
        padding: 2px 8px; /* Smaller padding */
        min-width: 30px; /* Minimum width */
        line-height: 1; /* Adjust line height */
    }
    #zoom-level {
        min-width: 45px; /* Width for "100%" */
        text-align: center;
        background-color: #212529;
        padding: 4px 6px;
        border-radius: 4px;
        margin: 0 4px;
    }

  </style>
</head>
<body class="text-slate-300 min-h-screen flex flex-col antialiased">

  <header class="w-full backdrop-blur-sm bg-surface/80 border-b border-primary-500/40 sticky top-0 z-40 flex-shrink-0">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 h-auto min-h-[4rem] py-2 sm:py-0 sm:h-16 flex flex-wrap items-center justify-between gap-x-4 gap-y-2">
      <h1 class="text-lg sm:text-xl lg:text-2xl font-extrabold text-primary-500 order-1 sm:order-1 shrink-0">Dashboard</h1>
      <div class="flex items-center gap-3 sm:gap-4 order-3 sm:order-2 w-full sm:w-auto justify-center sm:justify-end flex-wrap grow">
          <span id="month-total" class="text-primary-500 font-semibold text-xs sm:text-sm text-center"></span>
          <span id="last-update" class="text-slate-400 text-xs sm:text-sm text-center"></span>
      </div>
      <div class="flex items-center gap-2 order-2 sm:order-3 ml-auto sm:ml-0 shrink-0">
           <div id="zoom-controls" class="items-center gap-1 hidden">
                <button id="zoom-out" title="Diminuir Zoom"
                        class="zoom-control rounded border border-primary-500 bg-primary-500/10 hover:bg-primary-500/20 text-primary-300 text-sm font-bold shadow-glow">-</button>
                <span id="zoom-level" class="text-xs font-medium text-slate-300">100%</span>
                <button id="zoom-in" title="Aumentar Zoom"
                        class="zoom-control rounded border border-primary-500 bg-primary-500/10 hover:bg-primary-500/20 text-primary-300 text-sm font-bold shadow-glow">+</button>
          </div>
           <button id="fullscreen-toggle" title="Tela Cheia API"
                class="px-2 py-1.5 rounded border border-primary-500 bg-primary-500/10 hover:bg-primary-500/20 text-primary-300 text-xs font-medium shadow-glow hidden">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                </svg>
           </button>
           <button id="manual-refresh"
                   class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md border border-primary-500 bg-primary-500/10 hover:bg-primary-500/20
                          text-primary-300 text-xs sm:text-sm font-medium shadow-glow">
             Atualizar
           </button>
      </div>
    </div>
  </header>

  <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900/80 backdrop-blur-md">
    <div class="h-12 w-12 border-[6px] border-primary-500 border-t-transparent rounded-full animate-spin mb-6"></div>
    <p class="text-primary-300 text-lg font-medium">Carregandoâ€¦</p>
  </div>

  <main id="main-content" class="w-full flex flex-col flex-grow">
    <div class="flex justify-center space-x-3 sm:space-x-4 flex-shrink-0">
      <button id="tab-table" class="tab-btn px-4 py-2 sm:px-5 rounded-lg font-medium text-slate-300 hover:bg-primary-500/10 transition-colors duration-200">Tabela</button>
      <button id="tab-charts" class="tab-btn px-4 py-2 sm:px-5 rounded-lg font-medium text-slate-300 hover:bg-primary-500/10 transition-colors duration-200">GrÃ¡ficos</button>
    </div>

    <div id="filters-bar" class="flex flex-wrap items-center justify-center gap-3 flex-shrink-0">
      <span id="filters-active" class="text-primary-500 text-sm text-center">Nenhum filtro ativo</span>
      <button id="clear-filters"
              class="px-3 py-1 rounded-md border border-primary-500 bg-primary-500/10 hover:bg-primary-500/20
                     text-primary-300 text-xs font-medium shadow-glow" style="display: none;">
        Limpar Filtros
      </button>
    </div>

    <div id="error-message"
         class="hidden w-full p-4 text-center text-red-300 bg-red-800/40 border border-red-600 rounded-lg flex-shrink-0"></div>

    <section id="table-wrapper" class="hidden w-full flex-grow">
        <table id="sheetTable" class="min-w-full text-xs sm:text-[13px] divide-y divide-slate-600/60">
      </table>
    </section>

    <section id="charts-wrapper"
             class="hidden w-full grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 flex-grow">
      <div class="chart-card bg-surface/80 rounded-2xl shadow-lg ring-1 ring-primary-500/20 p-4 sm:p-6 md:col-span-2">
        <h2 class="text-base sm:text-lg font-semibold mb-4 text-primary-500">Total por Data de Vencimento</h2>
        <div id="chart-overview"></div>
      </div>

      <div class="chart-card bg-surface/80 rounded-2xl shadow-lg ring-1 ring-primary-500/20 p-4 sm:p-6">
        <h2 class="text-base sm:text-lg font-semibold mb-4 text-primary-500">Total por Data de Pagamento</h2>
        <div id="chart-payment"></div>
      </div>

      <div class="chart-card bg-surface/80 rounded-2xl shadow-lg ring-1 ring-primary-500/20 p-4 sm:p-6">
        <h2 class="text-base sm:text-lg font-semibold mb-4 text-primary-500">Total por MÃªs (Vencimento)</h2>
        <div id="chart-monthly"></div>
      </div>
    </section>
  </main>
  <script>
    const sheetId = '1du2FRGYbmY1mQ_mbNN1HuvQc8QhY3Bqq';
    const gid     = '0';
    const baseURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
    const REFRESH_INTERVAL = 60000; // 1 minute
    const CURRENCY_FORMAT = { style: 'currency', currency: 'BRL', maximumFractionDigits: 2 };
    const CHART_COLORS = ['#4dabf7', '#4ade80', '#fb7185', '#facc15', '#a78bfa', '#2dd4bf'];

    // --- Zoom Constants ---
    const BASE_TABLE_FONT_SIZE = 13; // Base font size in pixels for 100% zoom
    const ZOOM_STEP = 10; // Zoom step in percentage points
    const MIN_ZOOM = 50; // Minimum zoom level (50%)
    const MAX_ZOOM = 200; // Maximum zoom level (200%)

    let headersFull = [], sheetRows = [];
    let headersDisplay = []; // Which headers (and their order) to display in the table
    let chartOverview, chartPayment, chartMonthly;
    let isLoaded = false, isFetching = false;
    const activeFilters = {}; // Stores { colIndex: filterValue }
    let currentZoomLevel = 100; // Initial zoom level percentage

    // Cache previous data to avoid unnecessary chart updates
    let prevOverviewData = null, prevPaymentData = null, prevMonthlyData = null;

    // DOM Element References
    const $loader = document.getElementById('loader');
    const $errorMsg = document.getElementById('error-message');
    const $tableTab = document.getElementById('tab-table');
    const $chartTab = document.getElementById('tab-charts');
    const $tableWrapper = document.getElementById('table-wrapper');
    const $chartWrapper = document.getElementById('charts-wrapper');
    const $sheetTable = document.getElementById('sheetTable');
    const $lastUpdate = document.getElementById('last-update');
    const $monthTotal = document.getElementById('month-total');
    const $filtersActive = document.getElementById('filters-active');
    const $clearFiltersBtn = document.getElementById('clear-filters');
    const $mainContent = document.getElementById('main-content'); // Reference to main element
    const $manualRefreshBtn = document.getElementById('manual-refresh');
    // --- New Zoom/Fullscreen DOM Elements ---
    const $zoomControls = document.getElementById('zoom-controls');
    const $zoomInBtn = document.getElementById('zoom-in');
    const $zoomOutBtn = document.getElementById('zoom-out');
    const $zoomLevelDisplay = document.getElementById('zoom-level');
    const $fullscreenToggleBtn = document.getElementById('fullscreen-toggle');
    const $fullscreenIconExpand = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg>`;
    const $fullscreenIconCollapse = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9 3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5M15 15l5.25 5.25" /></svg>`;

    // Event Listeners
    $manualRefreshBtn.onclick = loadData;
    $tableTab.onclick = () => switchTab('table');
    $chartTab.onclick = () => switchTab('charts');
    $clearFiltersBtn.onclick = clearFilters;
    // --- New Event Listeners ---
    $zoomInBtn.onclick = zoomIn;
    $zoomOutBtn.onclick = zoomOut;
    $fullscreenToggleBtn.onclick = toggleFullScreen; // Native Fullscreen API
    document.addEventListener('fullscreenchange', handleFullScreenChange);


    // --- Core Functions ---

    function switchTab(tabId) {
      [$tableTab, $chartTab].forEach(btn => btn.classList.remove('active-tab'));
      // Remove layout modification class initially
      $mainContent.classList.remove('table-full-screen');

      if (tabId === 'table') {
        $tableWrapper.classList.remove('hidden');
        $chartWrapper.classList.add('hidden');
        $tableTab.classList.add('active-tab');
        // Apply class to MAIN for layout change
        $mainContent.classList.add('table-full-screen');
        // Show table-specific controls
        $zoomControls.classList.remove('hidden');
        $zoomControls.classList.add('flex');
        $fullscreenToggleBtn.classList.remove('hidden');
        applyZoom(); // Re-apply zoom
      } else { // Switching to charts
        $chartWrapper.classList.remove('hidden');
        $tableWrapper.classList.add('hidden');
        $chartTab.classList.add('active-tab');
        // Hide table-specific controls
        $zoomControls.classList.add('hidden');
        $zoomControls.classList.remove('flex');
        $fullscreenToggleBtn.classList.add('hidden');

        // Exit native fullscreen if active when switching away from table
        if (document.fullscreenElement) {
             document.exitFullscreen().catch(err => console.error("Error exiting fullscreen:", err));
        }

        // Re-render charts slightly after tab switch for correct sizing in default layout
        setTimeout(() => [chartOverview, chartPayment, chartMonthly].forEach(chart => {
            if (chart && typeof chart.updateOptions === 'function') {
                // Use a small timeout to ensure layout is recalculated
                setTimeout(() => chart.updateOptions({}, false, false, false), 50);
            }
        }), 50);
      }
    }

    async function fetchSheetData() {
      const response = await fetch(`${baseURL}&_=${Date.now()}`); // Cache buster
      if (!response.ok) throw new Error(`HTTP error ${response.status}`);
      const text = await response.text();
      if (!text.startsWith('/*O_o*/\ngoogle.visualization.Query.setResponse(')) {
        throw new Error('Invalid response format from Google Sheets API.');
      }
      try {
        return JSON.parse(text.substring(47, text.length - 2));
      } catch (e) {
        console.error("Failed to parse JSONP:", e);
        console.error("Received text:", text);
        throw new Error('Failed to parse JSON data from Google Sheets API.');
      }
    }

    // --- Formatting Helpers ---
    const padZero = num => num.toString().padStart(2, '0');

    const formatDateBR = date => {
        if (!date || isNaN(date.getTime())) return 'â€“';
        return `${padZero(date.getUTCDate())}/${padZero(date.getUTCMonth() + 1)}/${date.getUTCFullYear()}`;
    };

    const formatMonthYear = date => {
        if (!date || isNaN(date.getTime())) return 'â€“';
        const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const month = monthNames[date.getUTCMonth()];
        const year = date.getUTCFullYear();
        return `${month}/${year}`;
    };

    function parseDateValue(value) {
        if (value instanceof Date) return value;
        if (value == null) return null;

        let match = typeof value === 'string' ? value.match(/^Date\((\d{4}),\s*(\d{1,2}),\s*(\d{1,2})/) : null;
        if (match) {
            return new Date(Date.UTC(+match[1], +match[2], +match[3]));
        }

        if (typeof value === 'number' && value > 1 && value < 60000) { // Plausible range for date serials
             const excelEpoch = Date.UTC(1899, 11, 30);
             const millisecondsPerDay = 24 * 60 * 60 * 1000;
             const date = new Date(excelEpoch + value * millisecondsPerDay);
             if (date.getUTCFullYear() > 1900) {
                 return date;
             }
        }

        if (typeof value !== 'string') return null;

        match = value.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (match) {
            return new Date(Date.UTC(+match[1], +match[2] - 1, +match[3]));
        }
        match = value.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);
        if (match) {
            let year = +match[3];
            if (year < 100) year += 2000;
            return new Date(Date.UTC(year, +match[2] - 1, +match[1]));
        }
        const parsed = new Date(value);
        if (!isNaN(parsed.getTime()) && parsed.getUTCFullYear() > 1900) {
             return new Date(Date.UTC(parsed.getFullYear(), parsed.getMonth(), parsed.getDate()));
        }
        return null;
    }


    const formatCurrency = value => typeof value === 'number' && !isNaN(value)
        ? value.toLocaleString('pt-BR', CURRENCY_FORMAT)
        : 'â€“';
    const formatCompact = value => typeof value === 'number' && !isNaN(value)
        ? value.toLocaleString('pt-BR', { notation: 'compact', maximumFractionDigits: 1 })
        : 'N/A';
    const formatTooltip = value => typeof value === 'number' ? formatCurrency(value) : 'N/A';

    // --- Data Loading and UI Building ---

    async function loadData() {
      if (isFetching) return;
      isFetching = true;
      $errorMsg.classList.add('hidden');
      if (!isLoaded) $loader.classList.remove('hidden');

      try {
        const jsonData = await fetchSheetData();
        if (!jsonData || !jsonData.table || !jsonData.table.cols) {
            throw new Error("Dados recebidos da planilha estÃ£o incompletos ou mal formatados.");
        }

        headersFull = jsonData.table.cols.map(col => col.label || `Col${col.id}`);
        const obsIndex = headersFull.findIndex(header => header && header.toLowerCase().trim() === 'observaÃ§Ã£o');
        headersDisplay = obsIndex === -1 ? [...headersFull] : headersFull.slice(0, obsIndex + 1);


        sheetRows = jsonData.table.rows.map(row => {
          const cells = Array(headersFull.length).fill(null);
          if (row && row.c) {
              row.c.forEach((cell, index) => {
                  if (index < headersFull.length) {
                      cells[index] = cell?.v ?? null;
                  }
              });
          }
          return cells;
        });

        if (!isLoaded) {
          buildInitialUI();
          isLoaded = true;
          // Start with table tab active (which applies full-screen layout)
          switchTab('table');
        } else {
          updateUI(); // Rebuilds table and updates charts via filters
        }

        updateGrandTotalHeader();
        $lastUpdate.textContent = `Atualizado: ${new Date().toLocaleTimeString('pt-BR')}`;

      } catch (error) {
        console.error("Erro ao carregar dados:", error);
        $errorMsg.textContent = `Erro ao carregar dados: ${error.message}. Verifique ID/GID da Planilha e permissÃµes de compartilhamento (qualquer pessoa com o link pode ver).`;
        $errorMsg.classList.remove('hidden');
        $tableWrapper.classList.add('hidden');
        $chartWrapper.classList.add('hidden');
        $mainContent.classList.remove('table-full-screen'); // Ensure layout class is removed on error
        // Hide table controls on error
        $zoomControls.classList.add('hidden');
        $zoomControls.classList.remove('flex');
        $fullscreenToggleBtn.classList.add('hidden');
      } finally {
        isFetching = false;
        $loader.classList.add('hidden');
      }
    }
    loadData(); // Initial load
    setInterval(loadData, REFRESH_INTERVAL); // Periodic refresh


    function buildTable() {
      $sheetTable.innerHTML = ''; // Clear existing table content
      const thead = createTableHead();
      const tbody = createTableBody(); // Create body first for filter population
      if (thead) $sheetTable.appendChild(thead);
      if (tbody) $sheetTable.appendChild(tbody);
      applyFilters(); // Apply filters (updates charts/header total)
      applyZoom(); // Apply current zoom level
    }


    function createTableHead() {
        const thead = document.createElement('thead');
        // Removed background here, handled by sticky rule
        const tr = document.createElement('tr');
        tr.className = 'divide-x divide-primary-500/30';

        headersDisplay.forEach((header, index) => {
            const th = document.createElement('th');
            // Sticky defined via CSS rule: main.table-full-screen #sheetTable thead th
            th.className = 'px-2 py-2 sm:px-4 sm:py-3 text-left text-xs font-semibold text-primary-500 uppercase whitespace-nowrap align-top';
            const headerText = document.createElement('div');
            headerText.textContent = header;
            th.appendChild(headerText);

            const select = document.createElement('select');
            select.dataset.colIndex = index;
            select.className = 'mt-1 block w-full text-xs';
            select.innerHTML = '<option value="">Todos</option>';

            const uniqueValues = [...new Set(sheetRows.map(row => formatCellValue(row[index], header)))]
                .filter(value => value !== 'â€“' && value !== null && value !== '')
                .sort((a, b) => {
                     try {
                         const numA = parseFloat(String(a).replace(/[R$.]/g, '').replace(',', '.'));
                         const numB = parseFloat(String(b).replace(/[R$.]/g, '').replace(',', '.'));
                         if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                         const dateA = String(a).match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
                         const dateB = String(b).match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
                         if (dateA && dateB) {
                             const isoA = `${dateA[3]}-${dateA[2]}-${dateA[1]}`;
                             const isoB = `${dateB[3]}-${dateB[2]}-${dateB[1]}`;
                             return isoA.localeCompare(isoB);
                         }
                     } catch (e) { /* Ignore */ }
                     return String(a).localeCompare(String(b), 'pt-BR');
                });

            uniqueValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value; option.textContent = value;
                select.appendChild(option);
            });

            if (activeFilters[index]) { select.value = activeFilters[index]; }
            select.onchange = handleFilterChange;
            th.appendChild(select);
            tr.appendChild(th);
        });

        thead.appendChild(tr);
        return thead;
    }


    function handleFilterChange(event) {
        const colIndex = event.target.dataset.colIndex;
        const value = event.target.value;
        if (value) { activeFilters[colIndex] = value; }
        else { delete activeFilters[colIndex]; }
        applyFilters(); // Re-apply filters and update UI
    }

    function createTableBody() {
        const tbody = document.createElement('tbody');
        tbody.className = 'divide-y divide-slate-600/60';

        if (sheetRows.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = headersDisplay.length || 1;
            td.textContent = 'Nenhum dado encontrado.';
            td.className = 'px-4 py-10 text-center text-slate-400';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return tbody;
        }


        sheetRows.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            tr.className = `${rowIndex % 2 ? 'bg-surface/70' : 'bg-surface/60'} hover:bg-primary-500/10 transition-colors duration-150`;
            headersDisplay.forEach((header, colIndex) => {
                const td = document.createElement('td');
                td.className = 'px-2 py-2 sm:px-4 sm:py-3 whitespace-nowrap';
                const cellValue = row[colIndex];
                td.textContent = formatCellValue(cellValue, header);
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        return tbody;
    }


    function formatCellValue(cellValue, headerLabel) {
        if (cellValue == null || cellValue === '') return 'â€“';
        const headerLower = headerLabel.toLowerCase().trim();

        if (headerLower === 'nf') { return String(cellValue); }

        if (/valor|total|preÃ§o/i.test(headerLower)) {
            let numericValue = NaN;
            if (typeof cellValue === 'number') { numericValue = cellValue; }
            else if (typeof cellValue === 'string') {
                const cleanedString = cellValue.replace(/\./g, '').replace(',', '.').replace(/[R$\s]/g, '');
                numericValue = parseFloat(cleanedString);
            }
            return !isNaN(numericValue) ? formatCurrency(numericValue) : String(cellValue);
        }

         if (/data|venc|pag|emissao|emissÃ£o/i.test(headerLower)) {
              const dateValue = parseDateValue(cellValue);
              if (dateValue && !isNaN(dateValue.getTime())) {
                  return formatDateBR(dateValue);
              }
         }

        if (typeof cellValue === 'number') { return cellValue.toLocaleString('pt-BR'); }
        if (typeof cellValue === 'string' && /^-?\d+([.,]\d+)?$/.test(cellValue)) {
            const num = parseFloat(cellValue.replace(',', '.'));
            if (!isNaN(num)) return num.toLocaleString('pt-BR');
        }
        return String(cellValue);
    }


    // --- Filtering Logic ---

    function applyFilters() {
        const tbody = $sheetTable.querySelector('tbody');
        if (!tbody) return;

        let visibleRowCount = 0;
        const hasActiveFilters = Object.keys(activeFilters).length > 0;

        Array.from(tbody.rows).forEach(tableRow => {
            if (tableRow.cells.length === 1 && tableRow.cells[0].colSpan > 1) {
                tableRow.style.display = 'none';
                return;
            }
            let showRow = true;
            if (hasActiveFilters) {
                for (const [colIndex, filterValue] of Object.entries(activeFilters)) {
                    if (filterValue && tableRow.cells[colIndex]?.textContent.trim() !== filterValue) {
                        showRow = false; break;
                    }
                }
            }
            tableRow.style.display = showRow ? '' : 'none';
            if (showRow) visibleRowCount++;
        });

        const noDataRow = tbody.querySelector('td[colspan]');
        if (noDataRow) {
             const onlyNoDataVisible = visibleRowCount === 0 && sheetRows.length > 0;
             noDataRow.parentElement.style.display = onlyNoDataVisible ? '' : 'none';
             if(onlyNoDataVisible) noDataRow.textContent = 'Nenhum dado corresponde aos filtros selecionados.';
             else if(sheetRows.length === 0) noDataRow.parentElement.style.display = '';
        }

        updateFilterDisplay();
        updateCharts(); // Update charts based on filtered data
        updateGrandTotalHeader(); // Update header total based on filtered data
    }


    function updateFilterDisplay() {
        const activeFilterKeys = Object.keys(activeFilters);
        if (activeFilterKeys.length === 0) {
            $filtersActive.textContent = 'Nenhum filtro ativo';
            $clearFiltersBtn.style.display = 'none';
        } else {
            const filterParts = activeFilterKeys.map(index =>
                `${headersDisplay[index]}: "${activeFilters[index]}"`
            );
            let filterText = 'Filtros: ' + filterParts.join(' | ');
            $filtersActive.textContent = filterText;
            $clearFiltersBtn.style.display = 'inline-block';
        }
    }

    function clearFilters() {
        Object.keys(activeFilters).forEach(key => delete activeFilters[key]);
        $sheetTable.querySelectorAll('thead select').forEach(select => select.value = '');
        applyFilters(); // Re-apply (no filters) to show all rows and update UI
    }

    // --- Chart Data Aggregation ---

    function hasDataChanged(newData, prevData) {
        if (!prevData) return true;
        return JSON.stringify(newData.labels) !== JSON.stringify(prevData.labels) ||
               JSON.stringify(newData.totals) !== JSON.stringify(prevData.totals);
    }


    function aggregateByDate(dateColumnRegex) {
        const dateColIndex = headersFull.findIndex(h => h && dateColumnRegex.test(h.toLowerCase()));
        const valueColIndex = headersFull.findIndex(h => h && /valor/i.test(h.toLowerCase()) && !/nf/i.test(h.toLowerCase()));

        if (dateColIndex === -1 || valueColIndex === -1) {
            console.warn(`Could not find required columns for date aggregation (Date Regex: ${dateColumnRegex})`);
            return { labels: [], totals: [] };
        }

        const aggregationMap = new Map();
        getFilteredRows().forEach(row => {
            const date = parseDateValue(row[dateColIndex]);
            if (!date || isNaN(date.getTime())) return;
            const dateKey = date.toISOString().split('T')[0];
            let value = row[valueColIndex];
            if (value == null) return;
            value = typeof value === 'number' ? value : parseFloat(String(value).replace(/\./g, '').replace(',', '.').replace(/[R$\s]/g, ''));
            if (!isNaN(value)) {
                aggregationMap.set(dateKey, (aggregationMap.get(dateKey) || 0) + value);
            }
        });

        const orderedEntries = [...aggregationMap.entries()].sort((a, b) => a[0].localeCompare(b[0]));
        return {
            labels: orderedEntries.map(([key]) => formatDateBR(new Date(key + 'T00:00:00Z'))),
            totals: orderedEntries.map(([_, value]) => value)
        };
    }


    function aggregateByMonth(dateColumnRegex) {
        const dateColIndex = headersFull.findIndex(h => h && dateColumnRegex.test(h.toLowerCase()));
        const valueColIndex = headersFull.findIndex(h => h && /valor/i.test(h.toLowerCase()) && !/nf/i.test(h.toLowerCase()));

        if (dateColIndex === -1 || valueColIndex === -1) {
            console.warn(`Could not find required columns for month aggregation (Date Regex: ${dateColumnRegex})`);
            return { labels: [], totals: [] };
        }

        const aggregationMap = new Map();
        getFilteredRows().forEach(row => {
            const date = parseDateValue(row[dateColIndex]);
             if (!date || isNaN(date.getTime())) return;
            const monthKey = `${date.getUTCFullYear()}-${padZero(date.getUTCMonth())}`;
            let value = row[valueColIndex];
            if (value == null) return;
            value = typeof value === 'number' ? value : parseFloat(String(value).replace(/\./g, '').replace(',', '.').replace(/[R$\s]/g, ''));
            if (!isNaN(value)) {
                aggregationMap.set(monthKey, (aggregationMap.get(monthKey) || 0) + value);
            }
        });

        const orderedEntries = [...aggregationMap.entries()].sort((a, b) => a[0].localeCompare(b[0]));
        return {
            labels: orderedEntries.map(([key]) => {
                const [year, monthIndex] = key.split('-');
                return formatMonthYear(new Date(Date.UTC(+year, +monthIndex, 1)));
            }),
            totals: orderedEntries.map(([_, value]) => value)
        };
    }


    function getFilteredRows() {
        if (Object.keys(activeFilters).length === 0) { return sheetRows; }
        return sheetRows.filter(row => {
            for (const [colIndex, filterValue] of Object.entries(activeFilters)) {
                const cellFormattedValue = formatCellValue(row[colIndex], headersDisplay[colIndex]);
                if (filterValue && cellFormattedValue.trim() !== filterValue) { return false; }
            }
            return true;
        });
    }

    // --- Chart Rendering ---

    const baseChartOptions = { /* ... (options remain the same) ... */ };

    function buildCharts() {
        prevOverviewData = aggregateByDate(/venc/i);
        prevPaymentData = aggregateByDate(/pag/i);
        prevMonthlyData = aggregateByMonth(/venc/i);
        renderOverviewChart(false, prevOverviewData);
        renderPaymentChart(false, prevPaymentData);
        renderMonthlyChart(false, prevMonthlyData);
    }

    function updateCharts() {
        // Update chart data based on filters
        const newOverviewData = aggregateByDate(/venc/i);
        const newPaymentData = aggregateByDate(/pag/i);
        const newMonthlyData = aggregateByMonth(/venc/i);
        renderOverviewChart(true, newOverviewData);
        renderPaymentChart(true, newPaymentData);
        renderMonthlyChart(true, newMonthlyData);
    }


    function renderOverviewChart(isUpdate = false, data) {
        if (isUpdate && !hasDataChanged(data, prevOverviewData)) return;
        const options = { series: [{ name: 'Total Venc.', data: data.totals }], xaxis: { categories: data.labels, labels: { rotate: -45, rotateAlways: false, hideOverlappingLabels: true, style: { fontSize: '10px' }, format: undefined }, tooltip: { enabled: false }, type: 'category' }, yaxis: { labels: { formatter: formatCompact } }, colors: [CHART_COLORS[0]], stroke: { curve: 'smooth', width: 2 }, fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1, stops: [0, 90, 100] } } };
        if (isUpdate && chartOverview) { chartOverview.updateOptions(options, true, true); }
        else { chartOverview?.destroy(); chartOverview = new ApexCharts(document.querySelector('#chart-overview'), { ...baseChartOptions, chart: { ...baseChartOptions.chart, type: 'area', height: 280 }, ...options }); chartOverview.render(); }
        prevOverviewData = data;
    }


    function renderPaymentChart(isUpdate = false, data) {
        if (isUpdate && !hasDataChanged(data, prevPaymentData)) return;
        const options = { series: [{ name: 'Total Pago', data: data.totals }], xaxis: { categories: data.labels, labels: { rotate: -45, rotateAlways: false, hideOverlappingLabels: true, style: { fontSize: '10px' }, format: undefined }, tooltip: { enabled: false }, type: 'category' }, yaxis: { labels: { formatter: formatCompact } }, colors: [CHART_COLORS[1]], stroke: { curve: 'smooth', width: 2 }, fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1, stops: [0, 90, 100] } } };
        if (isUpdate && chartPayment) { chartPayment.updateOptions(options, true, true); }
        else { chartPayment?.destroy(); chartPayment = new ApexCharts(document.querySelector('#chart-payment'), { ...baseChartOptions, chart: { ...baseChartOptions.chart, type: 'area', height: 280 }, ...options }); chartPayment.render(); }
        prevPaymentData = data;
    }


    function renderMonthlyChart(isUpdate = false, data) {
         const dataActuallyChanged = !prevMonthlyData || JSON.stringify(data.totals) !== JSON.stringify(prevMonthlyData.totals) || JSON.stringify(data.labels) !== JSON.stringify(prevMonthlyData.labels);
        if (isUpdate && !dataActuallyChanged) return;
        const grandTotal = data.totals.reduce((sum, total) => sum + total, 0);
        const options = { series: data.totals, labels: data.labels, colors: CHART_COLORS.slice(0, data.labels.length || CHART_COLORS.length), legend: { show: true, position: 'bottom', fontSize: '11px', horizontalAlign: 'center', itemMargin: { horizontal: 5, vertical: 2 } }, plotOptions: { pie: { donut: { size: '65%', labels: { show: true, total: { show: true, label: 'Total Geral', fontSize: '14px', fontWeight: 600, color: '#cbd5e1', formatter: () => formatCurrency(grandTotal) }, value: { show: true, fontSize: '16px', fontWeight: 500, color: '#cbd5e1', formatter: (val) => formatCurrency(parseFloat(val)) } } } } }, responsive: [{ breakpoint: 480, options: { chart: { height: 300 }, legend: { position: 'bottom', fontSize: '10px' }, plotOptions: { pie: { donut: { labels: { total: { fontSize: '12px'}, value: { fontSize: '14px'} } } } } } }] };
        if (isUpdate && chartMonthly) { chartMonthly.updateOptions(options, true, true); }
        else { chartMonthly?.destroy(); chartMonthly = new ApexCharts(document.querySelector('#chart-monthly'), { ...baseChartOptions, chart: { ...baseChartOptions.chart, type: 'donut', height: 280 }, ...options }); chartMonthly.render(); }
        prevMonthlyData = data;
    }


    // --- Header Update ---
    function updateGrandTotalHeader() {
        const { totals } = aggregateByMonth(/venc/i);
        const grandTotal = totals.reduce((sum, monthTotal) => sum + monthTotal, 0);
        const filterSuffix = Object.keys(activeFilters).length > 0 ? ' (Filtrado)' : '';
        $monthTotal.textContent = `Total Geral (Venc.)${filterSuffix}: ${formatCurrency(grandTotal)}`;
    }

    // --- Zoom Functions ---
    function applyZoom() {
        const newSize = BASE_TABLE_FONT_SIZE * (currentZoomLevel / 100);
        if ($sheetTable) {
             const thead = $sheetTable.querySelector('thead');
             const tbody = $sheetTable.querySelector('tbody');
             const fontSizeStyle = `${newSize.toFixed(2)}px`;
             if(thead) thead.style.fontSize = fontSizeStyle;
             if(tbody) tbody.style.fontSize = fontSizeStyle;
        }
        updateZoomDisplay();
    }


    function updateZoomDisplay() {
        $zoomLevelDisplay.textContent = `${currentZoomLevel}%`;
        $zoomOutBtn.disabled = currentZoomLevel <= MIN_ZOOM;
        $zoomInBtn.disabled = currentZoomLevel >= MAX_ZOOM;
    }

    function zoomIn() {
        if (currentZoomLevel < MAX_ZOOM) {
            currentZoomLevel = Math.min(MAX_ZOOM, currentZoomLevel + ZOOM_STEP);
            applyZoom();
        }
    }

    function zoomOut() {
        if (currentZoomLevel > MIN_ZOOM) {
            currentZoomLevel = Math.max(MIN_ZOOM, currentZoomLevel - ZOOM_STEP);
            applyZoom();
        }
    }

    // --- Fullscreen Functions (Native API) ---
    function toggleFullScreen() {
      const elementToFullscreen = $mainContent;
      if (!document.fullscreenElement) {
        elementToFullscreen.requestFullscreen()
          .then(() => updateFullscreenButton(true))
          .catch(err => { console.error(`Error entering fullscreen: ${err.message} (${err.name})`); });
      } else {
        document.exitFullscreen()
          .then(() => updateFullscreenButton(false))
          .catch(err => { console.error(`Error exiting fullscreen: ${err.message} (${err.name})`); });
      }
    }

    function handleFullScreenChange() {
        updateFullscreenButton(!!document.fullscreenElement);
        // Optional: re-apply zoom in case browser reset styles on fullscreen exit
        if (!document.fullscreenElement && $tableTab.classList.contains('active-tab')) {
            setTimeout(applyZoom, 50); // Delay slightly
        }
    }

    function updateFullscreenButton(isFullScreen) {
        if (isFullScreen) {
            $fullscreenToggleBtn.innerHTML = $fullscreenIconCollapse;
            $fullscreenToggleBtn.title = "Sair da Tela Cheia (Nativa)";
        } else {
            $fullscreenToggleBtn.innerHTML = $fullscreenIconExpand;
            $fullscreenToggleBtn.title = "Tela Cheia (Nativa)";
        }
    }


    // --- Initial Setup & Updates ---
    function buildInitialUI() {
        buildTable();
        buildCharts();
        applyZoom();
        updateFullscreenButton(false);
    }

    function updateUI() {
        buildTable(); // Rebuilds table, applies filters, triggers chart/header updates
    }

  </script>
</body>
</html>
