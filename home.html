<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Relatórios • Google Sheets</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
      // Tailwind Config (sem alterações)
      tailwind.config = { theme: { fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] }, extend: { colors: { surface: '#ffffff', primary: { 200: '#a5d8ff', 300: '#6abff9', 400: '#4dabf7', 500: '#339af0', 600: '#1b85db', 700: '#1971c2' }, slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b' }, gray: { 100: '#f8f9fa', 200: '#e9ecef', 300: '#dee2e6', 800: '#343a40' }, green: { 400: '#4ade80', 500: '#22c55e'}, yellow: { 400: '#facc15', 500: '#eab308'}, red: { 400: '#fb7185', 500: '#f43f5e'} }, boxShadow: { glow: '0 0 10px rgba(77,171,247,.4)', card: '0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.04)', 'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.05)', 'highlight-glow': '0 0 15px rgba(51, 154, 240, 0.5)' }, backdropBlur: { xs: '3px' }, borderRadius: { 'xl': '0.75rem', '2xl': '1rem' } } } };
    </script>
    <style>
      /* Estilos CSS (sem alterações da versão anterior) */
      @keyframes spin { to { transform: rotate(360deg) } } .animate-spin { animation: spin 1s linear infinite } html, body { height: 100%; } body { background: #f0f2f5; display: flex; flex-direction: column; overflow-x: hidden; } main { flex-grow: 1; display: flex; flex-direction: column; width: 100%; } #report-cards-wrapper, #chart-container, #due-list-container { width: 100%; } ::-webkit-scrollbar { width: 8px; height: 8px } ::-webkit-scrollbar-track { background: #e9ecef; } ::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 4px } ::-webkit-scrollbar-thumb:hover { background: #868e96; } button:focus-visible, select:focus-visible, input:focus-visible { outline: 2px solid theme('colors.primary.400'); outline-offset: 2px; } .report-card { background-color: #ffffff; border: 1px solid #dee2e6; border-radius: theme('borderRadius.xl'); padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; transition: all 0.3s ease-in-out; box-shadow: theme('boxShadow.card'); min-height: 120px; position: relative; overflow: hidden; } @media (min-width: 640px) { .report-card { padding: 1.25rem; } } @media (min-width: 1024px) { .report-card { padding: 1.5rem; } } .report-card:hover { border-color: theme('colors.primary.300'); box-shadow: theme('boxShadow.card-hover'), theme('boxShadow.glow'); transform: translateY(-4px); } .report-card .icon { position: absolute; top: 0.75rem; right: 0.75rem; opacity: 0.15; width: 2.25rem; height: 2.25rem; color: theme('colors.slate.400'); transition: opacity 0.3s ease; } @media (min-width: 640px) { .report-card .icon { top: 1rem; right: 1rem; width: 2.5rem; height: 2.5rem;} } .report-card:hover .icon { opacity: 0.3; } .report-card .title { font-size: 0.8rem; font-weight: 500; color: theme('colors.slate.600'); margin-bottom: 0.5rem; } @media (min-width: 640px) { .report-card .title { font-size: 0.875rem; } } .report-card .value { font-size: 1.5rem; font-weight: 700; color: theme('colors.primary.500'); margin-bottom: 0.25rem; line-height: 1.2; } @media (min-width: 640px) { .report-card .value { font-size: 1.75rem; } } .report-card .value.count { color: theme('colors.slate.700'); font-size: 1.75rem; } @media (min-width: 640px) { .report-card .value.count { font-size: 2rem; } } .report-card .detail { font-size: 0.75rem; color: theme('colors.slate.500'); margin-top: auto; } @media (min-width: 640px) { .report-card .detail { font-size: 0.8rem; } } .report-card .value.paid { color: theme('colors.green.500') !important; } .report-card .value.pending { color: theme('colors.yellow.500') !important; } .report-card .value.overdue { color: theme('colors.red.500') !important; } .report-card .icon.paid { color: theme('colors.green.500'); } .report-card .icon.pending { color: theme('colors.yellow.500'); } .report-card .icon.overdue { color: theme('colors.red.500'); } .report-card .icon.total { color: theme('colors.primary.500'); } .report-card.highlighted-card { border-color: theme('colors.primary.400'); background-color: theme('colors.slate.50'); } .report-card.highlighted-card:hover { border-color: theme('colors.primary.500'); box-shadow: theme('boxShadow.card-hover'), theme('boxShadow.highlight-glow'); transform: translateY(-6px); } .report-card .icon.due-total-highlight { color: theme('colors.primary.600'); opacity: 0.25; } .report-card.highlighted-card:hover .icon.due-total-highlight { opacity: 0.4; } .view-toggle-button { padding: 0.5rem 0.8rem; border-radius: theme('borderRadius.lg'); font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; white-space: nowrap; } @media (min-width: 640px) { .view-toggle-button { padding: 0.6rem 1.2rem; font-size: 0.875rem; } } .view-toggle-button.active { background-color: theme('colors.primary.500/20'); color: theme('colors.primary.600'); border-color: theme('colors.primary.500/40'); box-shadow: 0 1px 3px rgba(77,171,247,.1); } .view-toggle-button:not(.active) { color: theme('colors.slate.600'); background-color: transparent; } .view-toggle-button:not(.active):hover { background-color: theme('colors.primary.500/10'); color: theme('colors.primary.700'); } header { box-shadow: 0 2px 4px rgba(0,0,0,.05); background-color: #ffffff; border-bottom: 1px solid #e9ecef; width: 100%; } #manual-refresh { padding: 0.3rem 0.6rem; border-radius: theme('borderRadius.lg'); border-width: 1px; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 0.3rem; border-color: theme('colors.primary.500'); background-color: theme('colors.primary.500/15'); color: theme('colors.primary.600'); font-size: 0.75rem; font-weight: 500; } @media (min-width: 640px) { #manual-refresh { padding: 0.375rem 1rem; gap: 0.5rem; font-size: 0.875rem; } } #manual-refresh:hover { background-color: theme('colors.primary.500/25'); } #manual-refresh:disabled { opacity: 0.7; cursor: not-allowed; } .refresh-icon { width: 1em; height: 1em; display: inline-block; } .refresh-icon.spinning { animation: spin 1s linear infinite; } #chart-container, #due-list-container { background-color: #ffffff; border: 1px solid #dee2e6; border-radius: theme('borderRadius.xl'); padding: 1rem; box-shadow: theme('boxShadow.card'); width: 100%; } @media (min-width: 640px) { #chart-container, #due-list-container { padding: 1.5rem; } } #due-list-total-all { font-size: 1.1rem; font-weight: 600; color: theme('colors.slate.700'); text-align: center; margin-bottom: 0; padding: 0.75rem; background-color: theme('colors.slate.100'); border-radius: theme('borderRadius.lg'); border: 1px solid theme('colors.slate.300'); } @media (min-width: 640px) { #due-list-total-all { font-size: 1.25rem; padding: 1rem; } } #due-list-items ul { list-style: none; padding: 0; margin: 0; max-height: 350px; overflow-y: auto; } @media (min-width: 640px) { #due-list-items ul { max-height: 400px; } } #due-list-items li { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding: 0.6rem 0.25rem; border-bottom: 1px solid theme('colors.gray.200'); font-size: 0.85rem; } @media (min-width: 640px) { #due-list-items li { padding: 0.75rem 0.5rem; font-size: 0.9rem; } } #due-list-items li:last-child { border-bottom: none; } #due-list-items .item-info { flex-grow: 1; display: flex; flex-direction: column; margin-right: 0.5rem; overflow: hidden; min-width: 100px; } @media (min-width: 640px) { #due-list-items .item-info { margin-right: 1rem; } } #due-list-items .item-description { color: theme('colors.slate.700'); text-overflow: ellipsis; white-space: nowrap; overflow: hidden; } #due-list-items .item-due-date { font-size: 0.7rem; color: theme('colors.slate.500'); margin-top: 0.1rem; } @media (min-width: 640px) { #due-list-items .item-due-date { font-size: 0.75rem; } } #due-list-items .item-value { color: theme('colors.primary.700'); font-weight: 600; white-space: nowrap; margin-left: auto; padding-left: 0.5rem; } #due-list-items .no-items-message { text-align: center; color: theme('colors.slate.500'); padding: 1.5rem 1rem; font-style: italic; font-size: 0.9rem; } @media (min-width: 640px) { #due-list-items .no-items-message { padding: 2rem 1rem; } } #due-list-chart-wrapper { border: 1px solid theme('colors.gray.200'); background-color: theme('colors.gray.100/50'); width: 100%; height: 280px; } @media (min-width: 640px) { #due-list-chart-wrapper { height: 350px; } } @media (min-width: 1024px) { #due-list-chart-wrapper { height: 400px; } } #forecast-chart-div { width: 100%; height: 300px; } @media (min-width: 640px) { #forecast-chart-div { height: 450px; } } @media (min-width: 1024px) { #forecast-chart-div { height: 550px; } }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col antialiased">

    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="icon-refresh" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 011-1zm10 10a1 1 0 01-1-1V9.899a7.002 7.002 0 01-11.601-2.566 1 1 0 111.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 01-1 1z" clip-rule="evenodd" /></symbol> <symbol id="icon-chart-bar" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z" /><path fill-rule="evenodd" d="M1 14.25a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H1.75a.75.75 0 01-.75-.75zm6-10a.75.75 0 01.75-.75h8.5a.75.75 0 010 1.5h-8.5a.75.75 0 01-.75-.75zM4 6a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-4.5A.75.75 0 014 6z" clip-rule="evenodd" /></symbol> <symbol id="icon-currency-dollar" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 10.818v2.43a.75.75 0 01-1.5 0v-2.43c-1.092-.115-2.11-.6-2.818-1.215C5.62 8.98 5.002 8.106 5 7.182 5 5.64 6.17 4.448 7.682 4.08c.43-.108.878-.157 1.318-.157h.01a6.32 6.32 0 011.318.157C11.83 4.448 13 5.64 13 7.182c-.002.924-.62 1.798-1.42 2.421-.706.615-1.726 1.1-2.83 1.215z" /><path fill-rule="evenodd" d="M8.894 3.067A.75.75 0 019.75 2.25h.5a.75.75 0 01.75.75v.859a4.834 4.834 0 015.217 4.311c.002.97-.35 1.887-.986 2.606-.66.746-1.52 1.328-2.512 1.663V15a.75.75 0 01-.75.75h-.5a.75.75 0 01-.75-.75v-1.486c-.99-.335-1.85-.917-2.51-1.663C5.35 11.103 5 10.186 5 9.216a4.834 4.834 0 015.217-4.311V4.75a.75.75 0 01-.75.75h-.5a.75.75 0 01-.856-.817l.012-.116.02-.115.026-.115.033-.114.038-.115.045-.114.05-.114c.017-.038.033-.076.05-.114l.058-.13a.75.75 0 01.56-.44zM10 8.682c.545 0 1.048-.12 1.48-.322.449-.21.799-.512 1.02-.858.22-.346.3-.738.3-1.139 0-.816-.566-1.49-1.318-1.657a4.824 4.824 0 00-1.482-.206 4.843 4.843 0 00-1.482.206C7.766 4.861 7.2 5.535 7.2 6.353c0 .401.08.793.3 1.139.22.346.57.647 1.02.858.432.201.935.321 1.48.332z" clip-rule="evenodd" /></symbol> <symbol id="icon-check-circle" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></symbol> <symbol id="icon-clock" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></symbol> <symbol id="icon-exclamation-triangle" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></symbol> <symbol id="icon-list-bullet" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm0 5.25a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></symbol> </svg>

    <header class="w-full sticky top-0 z-40 flex-shrink-0"> <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 h-auto min-h-[3.5rem] py-2 sm:h-16 flex flex-wrap items-center justify-between gap-x-4 gap-y-2"> <div class="flex items-center gap-2 order-1"> <svg class="h-6 w-6 text-primary-500 sm:h-7 sm:w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2z"></path></svg> <h1 class="text-base sm:text-lg lg:text-xl font-extrabold text-primary-500">Painel</h1> </div> <div class="flex items-center gap-2 sm:gap-4 order-3 sm:order-2 w-full sm:w-auto justify-center sm:justify-end flex-wrap"> <span id="grand-total-header" class="text-primary-600 font-semibold text-xs text-center"></span> <span id="last-update" class="text-slate-500 text-xs text-center"></span> </div> <button id="manual-refresh" class="order-2 sm:order-3 ml-auto sm:ml-0 shadow-glow"> <svg class="refresh-icon" aria-hidden="true"><use xlink:href="#icon-refresh"></use></svg> <span>Atualizar</span> </button> </div> </header>

    <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm"> <div class="h-14 w-14 border-8 border-primary-500 border-t-transparent rounded-full animate-spin mb-6"></div> <p class="text-primary-600 text-xl font-semibold">Carregando dados…</p> </div>

    <main id="main-content" class="w-full max-w-screen-xl mx-auto px-3 sm:px-6 lg:px-8 py-4 sm:py-6 flex flex-col gap-4 sm:gap-6">

      <div class="flex justify-center flex-wrap gap-1 sm:gap-2 bg-white/80 p-1 rounded-xl flex-shrink-0 self-center shadow-md border border-gray-200"> <button id="view-toggle-reports" class="view-toggle-button active">Relatórios</button> <button id="view-toggle-chart" class="view-toggle-button">Previsão</button> <button id="view-toggle-due-list" class="view-toggle-button">Vencimentos</button> </div>

      <section id="report-cards-wrapper" class="w-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4 lg:gap-5"> </section>

      <section id="chart-container" class="hidden w-full flex flex-col items-center">
          <h2 class="text-lg sm:text-xl font-semibold text-primary-600 mb-4 text-center">Previsão Mês Atual (Seg-Sex)</h2>
          <div id="forecast-chart-div"> <canvas id="weeklyPaymentsChart"></canvas> </div>
          <p id="chart-error-message" class="hidden mt-4 text-yellow-600 bg-yellow-100 px-3 py-1 rounded text-sm font-medium text-center border border-yellow-300"></p>
      </section>

      <section id="due-list-container" class="hidden w-full flex flex-col gap-4 sm:gap-6"> <div class="text-center"> <h2 class="text-lg sm:text-xl font-semibold text-primary-600 mb-1">Lista de Vencimentos</h2> <span id="due-list-current-date" class="text-xs sm:text-sm text-slate-500"></span> </div> <div id="due-list-total-all" class="text-center w-full max-w-md mx-auto">Calculando Total Geral...</div> <div id="due-list-chart-wrapper" class="w-full mx-auto bg-white p-2 sm:p-4 rounded-lg shadow border border-gray-200"> <canvas id="dueListChart"></canvas> <p id="due-list-chart-error" class="hidden text-center text-red-500 pt-4 text-sm">Erro ao gerar gráfico mensal.</p> </div> <div id="due-list-items" class="mt-0 bg-white rounded-lg border border-gray-200 shadow p-2 sm:p-4"> <p id="due-list-error-message" class="hidden text-center text-red-500 text-sm font-medium p-4"></p> </div> </section>

      <div class="flex-shrink-0 h-4"></div>

    </main>

    <script>
      // --- Configuration ---
      const sheetId = '1du2FRGYbmY1mQ_mbNN1HuvQc8QhY3Bqq'; const gidReports = '0'; const gidTable = '446722751';
      const baseURLReports = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gidReports}`;
      const baseURLTable = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gidTable}`;
      const REFRESH_INTERVAL = 60000; const CURRENCY_FORMAT = { style: 'currency', currency: 'BRL', maximumFractionDigits: 2 };
      // FORECAST_WEEKS_TOTAL removed

      // --- Regex & Status ---
      const valorRegex = /valor|total/i; const vencRegex = /venc/i; const pagtoRegex = /pag/i; const statusRegex = /status|situação/i; const dueListDescRegex = /descri[cç][aã]o|item|fornecedor|nome/i;
      const statusPago = ['pago', 'liquidado', 'quitado']; const statusPendente = ['a vencer', 'pendente', 'aberto', 'em aberto']; const statusVencido = ['vencido', 'em atraso'];

      // --- State Variables ---
      let headersReports = [], sheetRowsReports = []; let headersTable = [], sheetRowsTable = [];
      let isLoaded = false, isFetching = false;
      let forecastChartInstance = null; let dueListChartInstance = null;

      // --- DOM Elements ---
      const $loader = document.getElementById('loader'); const $reportCardsWrapper = document.getElementById('report-cards-wrapper'); const $lastUpdate = document.getElementById('last-update'); const $grandTotalHeader = document.getElementById('grand-total-header'); const $manualRefreshBtn = document.getElementById('manual-refresh'); const $refreshIcon = $manualRefreshBtn.querySelector('.refresh-icon'); const $refreshBtnText = $manualRefreshBtn.querySelector('span'); const $chartContainer = document.getElementById('chart-container'); const $chartCanvas = document.getElementById('weeklyPaymentsChart'); const $chartErrorMsg = document.getElementById('chart-error-message'); const $dueListContainer = document.getElementById('due-list-container'); const $dueListTotalAll = document.getElementById('due-list-total-all'); const $dueListItems = document.getElementById('due-list-items'); const $dueListErrorMsg = document.getElementById('due-list-error-message'); const $viewToggleReportsBtn = document.getElementById('view-toggle-reports'); const $viewToggleChartBtn = document.getElementById('view-toggle-chart'); const $viewToggleDueListBtn = document.getElementById('view-toggle-due-list'); const $dueListCurrentDate = document.getElementById('due-list-current-date'); const $dueListChartWrapper = document.getElementById('due-list-chart-wrapper'); const $dueListChartCanvas = document.getElementById('dueListChart'); const $dueListChartError = document.getElementById('due-list-chart-error');

      Chart.register(ChartDataLabels);

      // --- Utility Functions ---
      const padZero = num => num.toString().padStart(2, '0');
      const formatDateBR = date => { if (!date || isNaN(date.getTime())) return '–'; return `${padZero(date.getUTCDate())}/${padZero(date.getUTCMonth() + 1)}/${date.getUTCFullYear()}`; };
      const formatDateISO = date => { if (!date || isNaN(date.getTime())) return null; return `${date.getUTCFullYear()}-${padZero(date.getUTCMonth() + 1)}-${padZero(date.getUTCDate())}`; };
      const formatMonthYearLabel = date => { if (!date || isNaN(date.getTime())) return 'Inválido'; const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"]; return `${monthNames[date.getUTCMonth()]}/${date.getUTCFullYear()}`; };
      function parseDateValue(value) { if (value instanceof Date) return value; if (value == null) return null; if (typeof value === 'number' && value > 1 && value < 60000) { const utcDays = Math.floor(value - 25569); const date = new Date(0); date.setUTCDate(date.getUTCDate() + utcDays); return date; } if (typeof value !== 'string') return null; let match; match = value.match(/^Date\((\d{4}),\s*(\d{1,2}),\s*(\d{1,2})/); if (match) return new Date(Date.UTC(+match[1], +match[2], +match[3])); match = value.match(/^(\d{4})-(\d{2})-(\d{2})/); if (match) return new Date(Date.UTC(+match[1], +match[2] - 1, +match[3])); match = value.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/); if (match) { let year = +match[3]; if (year < 100) year += 2000; return new Date(Date.UTC(year, +match[2] - 1, +match[1])); } const parsed = new Date(value); if (!isNaN(parsed.getTime())) { return new Date(Date.UTC(parsed.getFullYear(), parsed.getMonth(), parsed.getDate())); } return null; }
      const formatCurrency = value => typeof value === 'number' && !isNaN(value) ? value.toLocaleString('pt-BR', CURRENCY_FORMAT) : '–';
      const formatCurrencyShort = value => { if (typeof value !== 'number' || isNaN(value)) return '–'; if (value === 0) return 'R$0'; if (Math.abs(value) < 1000) return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0}); if (Math.abs(value) < 1000000) return (value / 1000).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 1 }) + 'k'; return (value / 1000000).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 1 }) + 'M'; }
      function getNumericValue(cellValue) { if (typeof cellValue === 'number') return cellValue; if (typeof cellValue === 'string') { const cleanedString = cellValue.replace(/[R$\s.]/g, '').replace(',', '.'); const num = parseFloat(cleanedString); return isNaN(num) ? 0 : num; } return 0; }
      function getMondayOfWeek(d) { const date = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())); const day = date.getUTCDay(); const diff = date.getUTCDate() - day + (day === 0 ? -6 : 1); const monday = new Date(date.setUTCDate(diff)); monday.setUTCHours(0, 0, 0, 0); return monday; }
      const MONTH_NAMES_SHORT = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

      // --- Data Fetching Function ---
      async function fetchSheetData(baseUrl) { try { const response = await fetch(`${baseUrl}&_=${Date.now()}`); if (!response.ok) { throw new Error(`Erro HTTP ${response.status} ao buscar dados de ${baseUrl}`); } const text = await response.text(); if (!text.startsWith('/*O_o*/\ngoogle.visualization.Query.setResponse(')) { console.error("Texto recebido inesperado:", text); throw new Error('Formato de resposta inválido da API do Google Sheets.'); } return JSON.parse(text.substring(47, text.length - 2)); } catch (error) { console.error(`Falha ao buscar ou processar dados de ${baseUrl}:`, error); throw error; } }

      // --- Main Data Loading ---
      async function loadData() {
          if (isFetching) return; isFetching = true; if (!isLoaded) $loader.classList.remove('hidden');
          $manualRefreshBtn.disabled = true; $refreshIcon.classList.add('spinning'); $refreshBtnText.textContent = 'Atualizando...';
          $chartErrorMsg.classList.add('hidden'); $dueListErrorMsg?.classList.add('hidden'); $dueListChartError?.classList.add('hidden');
          let reportDataSuccess = false; let tableDataSuccess = false;
          try {
              const [jsonDataReports, jsonDataTable] = await Promise.all([ fetchSheetData(baseURLReports).catch(e => { console.error("Erro Fonte 1:", e); return null; }), fetchSheetData(baseURLTable).catch(e => { console.error("Erro Fonte 2:", e); return null; }) ]);
              if (jsonDataReports?.table?.cols && jsonDataReports.table.rows) { headersReports = jsonDataReports.table.cols.map(col => col.label || `Col${col.id}`); sheetRowsReports = jsonDataReports.table.rows.map(row => { const cells = Array(headersReports.length).fill(null); if (row?.c) { row.c.forEach((cell, index) => { if (index < headersReports.length) { cells[index] = cell?.v ?? null; } }); } return cells; }); prepareAndRenderForecastChart(); updateHeaderInfo(); reportDataSuccess = true; } else { console.error("Dados Fonte 1 incompletos."); headersReports = []; sheetRowsReports = []; if (forecastChartInstance) forecastChartInstance.destroy(); forecastChartInstance = null; $chartErrorMsg.textContent = 'Erro ao carregar dados p/ previsão.'; $chartErrorMsg.classList.remove('hidden'); $grandTotalHeader.textContent = 'Total Geral: Erro'; }
              if (jsonDataTable?.table?.cols && jsonDataTable.table.rows) { headersTable = jsonDataTable.table.cols.map(col => col.label || `Col${col.id}`); sheetRowsTable = jsonDataTable.table.rows.map(row => { const cells = Array(headersTable.length).fill(null); if (row?.c) { row.c.forEach((cell, index) => { if (index < headersTable.length) { cells[index] = cell?.v ?? null; } }); } return cells; }); tableDataSuccess = true; } else { console.error("Dados Fonte 2 incompletos."); headersTable = []; sheetRowsTable = []; }
              buildReportCards();
              if (tableDataSuccess && $viewToggleDueListBtn.classList.contains('active')) { renderDueListView(); } else if (!tableDataSuccess && $viewToggleDueListBtn.classList.contains('active')) { renderDueListError("Erro ao carregar dados p/ lista."); }
              if (reportDataSuccess || tableDataSuccess) { $lastUpdate.textContent = `Atualizado: ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit'})}`; isLoaded = true; }
          } catch (error) { console.error("Erro geral:", error); buildReportCards(); if (!reportDataSuccess) { $chartErrorMsg.textContent = 'Erro geral previsão.'; $chartErrorMsg.classList.remove('hidden'); $grandTotalHeader.textContent = 'Total Geral: Erro'; } if (!tableDataSuccess && $viewToggleDueListBtn.classList.contains('active')) { renderDueListError("Erro geral lista."); } }
          finally { isFetching = false; $loader.classList.add('hidden'); $manualRefreshBtn.disabled = false; $refreshIcon.classList.remove('spinning'); $refreshBtnText.textContent = 'Atualizar'; $dueListItems.querySelector('#due-list-loading-message')?.remove(); }
      }

      // --- Rendering Functions ---

      // buildReportCards() (No changes)
      function buildReportCards() { $reportCardsWrapper.innerHTML = ''; const findIndex = (regex, headers) => headers.findIndex(h => h && regex.test(h.toLowerCase())); const valorIndex = findIndex(valorRegex, headersReports); const vencIndex = findIndex(vencRegex, headersReports); const pagtoIndex = findIndex(pagtoRegex, headersReports); const statusIndex = findIndex(statusRegex, headersReports); let hasSource1Error = false; if (valorIndex === -1 && headersReports.length > 0) { console.error("Erro: Coluna de Valor não encontrada (Fonte 1)."); hasSource1Error = true; } else if (headersReports.length > 0) { if (vencIndex === -1) console.warn('Coluna de Vencimento não encontrada (Fonte 1).'); if (pagtoIndex === -1) console.warn('Coluna de Pagamento não encontrada (Fonte 1).'); if (statusIndex === -1) console.warn('Coluna de Status não encontrada (Fonte 1).');} let totalGeral = 0, totalPago = 0, totalPendente = 0, totalVencido = 0; let countTotal = 0, countPago = 0, countPendente = 0, countVencido = 0; const today = new Date(); today.setUTCHours(0, 0, 0, 0); if (valorIndex !== -1) { sheetRowsReports.forEach(row => { const valor = getNumericValue(row[valorIndex]); if (isNaN(valor)) return; totalGeral += valor; countTotal++; const dataPagto = pagtoIndex !== -1 ? parseDateValue(row[pagtoIndex]) : null; const dataVenc = vencIndex !== -1 ? parseDateValue(row[vencIndex]) : null; const statusRaw = statusIndex !== -1 ? (row[statusIndex] || '').toString().toLowerCase().trim() : ''; let isPago = false, isPendente = false, isVencido = false; if (dataPagto && !isNaN(dataPagto.getTime())) { isPago = true; } else if (statusIndex !== -1 && statusPago.some(s => statusRaw.includes(s))) { isPago = true; } else if (statusIndex !== -1 && statusVencido.some(s => statusRaw.includes(s))) { isVencido = true; } else if (statusIndex !== -1 && statusPendente.some(s => statusRaw.includes(s))) { isPendente = true; } else if (dataVenc && !isNaN(dataVenc.getTime())) { isVencido = dataVenc < today; isPendente = !isVencido; } else { isPendente = true; } if (isPago) { totalPago += valor; countPago++; } else if (isVencido) { totalVencido += valor; countVencido++; } else { totalPendente += valor; countPendente++; } }); } else if (headersReports.length > 0){ countTotal = sheetRowsReports.length; } let totalDueListSheet2 = 0; let countDueListSheet2 = 0; let hasSource2Error = false; const dueListValorIndex = findIndex(valorRegex, headersTable); const dueListVencIndex = findIndex(vencRegex, headersTable); if (dueListValorIndex !== -1 && dueListVencIndex !== -1 && sheetRowsTable && sheetRowsTable.length > 0) { sheetRowsTable.forEach(row => { const vencValueRaw = row[dueListVencIndex]; const vencDate = parseDateValue(vencValueRaw); if (vencDate && !isNaN(vencDate.getTime())) { const valor = getNumericValue(row[dueListValorIndex]); if (!isNaN(valor)) { totalDueListSheet2 += valor; countDueListSheet2++; } } }); } else { if (!sheetRowsTable || sheetRowsTable.length === 0) { console.log("Fonte 2 vazia."); } else if (dueListValorIndex === -1 || dueListVencIndex === -1) { console.warn("Coluna Valor/Vencimento não encontrada (Fonte 2)."); hasSource2Error = true; }} const currentDateFormatted = formatDateBR(new Date()); const reportData = [ { type: 'due-total-highlight', title: "Total Vencimentos", value: totalDueListSheet2, detail: `${countDueListSheet2} lançamentos • Ref: ${currentDateFormatted}`, valueClass: '', iconId: 'icon-list-bullet' }, { type: 'total', title: "Valor Total Geral", value: totalGeral, detail: `${countTotal} lançamento(s)`, valueClass: '', iconId: 'icon-currency-dollar' }, { type: 'paid', title: "Total Pago", value: totalPago, detail: `${countPago} lançamento(s)`, valueClass: 'paid', iconId: 'icon-check-circle' }, { type: 'pending', title: "Total Pendente", value: totalPendente, detail: `${countPendente} lançamento(s)`, valueClass: 'pending', iconId: 'icon-clock' }, { type: 'overdue', title: "Total Vencido", value: totalVencido, detail: `${countVencido} lançamento(s)`, valueClass: 'overdue', iconId: 'icon-exclamation-triangle' }, { type: 'paid', title: "Lançamentos Pagos", value: countPago, detail: `de ${countTotal} no total`, valueClass: 'count paid', iconId: 'icon-check-circle' }, { type: 'pending', title: "Lançamentos Pendentes", value: countPendente, detail: `de ${countTotal} no total`, valueClass: 'count pending', iconId: 'icon-clock' }, { type: 'overdue', title: "Lançamentos Vencidos", value: countVencido, detail: `de ${countTotal} no total`, valueClass: 'count overdue', iconId: 'icon-exclamation-triangle' }, ]; reportData.forEach(data => { if (hasSource1Error && ['total', 'paid', 'pending', 'overdue'].includes(data.type) && !data.valueClass.includes('count') && data.type !== 'due-total-highlight') { return; } if (hasSource1Error && data.valueClass.includes('count') && data.type !== 'due-total-highlight') { return; } if (hasSource2Error && data.type === 'due-total-highlight') { return; } const card = document.createElement('div'); card.className = 'report-card'; if (data.type === 'due-total-highlight') { card.classList.add('highlighted-card'); } const formattedValue = data.valueClass.includes('count') ? data.value.toLocaleString('pt-BR') : formatCurrency(data.value); const iconSVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg'); iconSVG.classList.add('icon', data.type); const iconUse = document.createElementNS('http://www.w3.org/2000/svg', 'use'); iconUse.setAttributeNS('http://www.w3.org/1999/xlink', 'href', `#${data.iconId}`); iconSVG.appendChild(iconUse); card.appendChild(iconSVG); const contentDiv = document.createElement('div'); contentDiv.innerHTML = `<div><h3 class="title">${data.title}</h3><p class="value ${data.valueClass}">${formattedValue}</p></div><p class="detail">${data.detail}</p>`; card.appendChild(contentDiv); $reportCardsWrapper.appendChild(card); }); if ($reportCardsWrapper.children.length === 0) { let errorMsg = "Não foi possível carregar dados."; if(hasSource1Error && hasSource2Error) errorMsg = "Erro Fontes 1 e 2."; else if (hasSource1Error) errorMsg = "Erro Fonte 1."; else if (hasSource2Error) errorMsg = "Erro Fonte 2."; $reportCardsWrapper.innerHTML = `<p class="text-center text-red-500 col-span-full font-medium p-4">${errorMsg}</p>`; } }

      // --- UPDATED: Forecast Chart Preparation (Current Month Only) ---
      function prepareAndRenderForecastChart() {
          $chartErrorMsg.classList.add('hidden');
          const findIndex = (regex, headers) => headers.findIndex(h => h && regex.test(h.toLowerCase()));
          const valorIndex = findIndex(valorRegex, headersReports); const vencIndex = findIndex(vencRegex, headersReports); const pagtoIndex = findIndex(pagtoRegex, headersReports); const statusIndex = findIndex(statusRegex, headersReports);

          if (valorIndex === -1 || vencIndex === -1) { $chartErrorMsg.textContent = 'Coluna Valor/Vencimento não encontrada (Fonte 1) p/ previsão.'; $chartErrorMsg.classList.remove('hidden'); if (forecastChartInstance) { forecastChartInstance.destroy(); forecastChartInstance = null; } const ctx = $chartCanvas.getContext('2d'); if(ctx) ctx.clearRect(0, 0, $chartCanvas.width, $chartCanvas.height); return; }

          const forecastTotals = {}; // Key: 'YYYY-MM-DD' (Monday), Value: total Mon-Fri
          const now = new Date();
          const currentYear = now.getUTCFullYear();
          const currentMonth = now.getUTCMonth(); // 0-11

          sheetRowsReports.forEach(row => {
              // 1. Check if Paid
              const dataPagto = pagtoIndex !== -1 ? parseDateValue(row[pagtoIndex]) : null; const statusRaw = statusIndex !== -1 ? (row[statusIndex] || '').toString().toLowerCase().trim() : '';
              let isPago = false; if (dataPagto && !isNaN(dataPagto.getTime())) { isPago = true; } else if (statusIndex !== -1 && statusPago.some(s => statusRaw.includes(s))) { isPago = true; } if (isPago) return;

              // 2. Get & Validate Due Date
              const dataVencOriginal = parseDateValue(row[vencIndex]); if (!dataVencOriginal || isNaN(dataVencOriginal.getTime())) return;

              // 3. Adjust Weekend Due Dates
              let dataVencAjustada = new Date(dataVencOriginal); const dayOfWeekOriginal = dataVencAjustada.getUTCDay();
              if (dayOfWeekOriginal === 6) { dataVencAjustada.setUTCDate(dataVencAjustada.getUTCDate() + 2); } else if (dayOfWeekOriginal === 0) { dataVencAjustada.setUTCDate(dataVencAjustada.getUTCDate() + 1); }
              dataVencAjustada.setUTCHours(0, 0, 0, 0);

              // 4. Check if Adjusted Date is in the CURRENT MONTH
              if (dataVencAjustada.getUTCFullYear() === currentYear && dataVencAjustada.getUTCMonth() === currentMonth) {
                   // 5. Check if Adjusted date is Mon-Fri
                   const dayOfWeekAdjusted = dataVencAjustada.getUTCDay();
                   if (dayOfWeekAdjusted >= 1 && dayOfWeekAdjusted <= 5) {
                       // 6. Find Monday & Aggregate
                       const weekMonday = getMondayOfWeek(dataVencAjustada); const weekKey = formatDateISO(weekMonday);
                       const valor = getNumericValue(row[valorIndex]);
                       if (!isNaN(valor)) { if (!forecastTotals[weekKey]) { forecastTotals[weekKey] = 0; } forecastTotals[weekKey] += valor; }
                   }
               }
          });

          // 7. Prepare Data for Chart (Only weeks with data relevant to current month)
          const chartLabels = []; const chartData = []; const weekDates = {};
          const sortedMondays = Object.keys(forecastTotals).sort(); // Sort the Mondays we found totals for

          // If no Mondays found for the current month, display empty chart or message
           if (sortedMondays.length === 0) {
                $chartErrorMsg.textContent = `Nenhuma previsão encontrada para ${MONTH_NAMES_SHORT[currentMonth]}/${currentYear} (Seg-Sex).`;
                $chartErrorMsg.classList.remove('hidden');
                if (forecastChartInstance) { forecastChartInstance.destroy(); forecastChartInstance = null; }
                const ctx = $chartCanvas.getContext('2d'); if(ctx) ctx.clearRect(0, 0, $chartCanvas.width, $chartCanvas.height);
                return; // Stop here
            }


          sortedMondays.forEach((weekKey, index) => {
              const mondayDate = parseDateValue(weekKey); // Convert 'YYYY-MM-DD' back to Date
              const fridayDate = new Date(mondayDate); fridayDate.setUTCDate(fridayDate.getUTCDate() + 4);

              chartLabels.push(`Sem ${padZero(mondayDate.getUTCDate())}/${padZero(mondayDate.getUTCMonth() + 1)}`);
              chartData.push(forecastTotals[weekKey] || 0);
              weekDates[index] = { start: formatDateBR(mondayDate), end: formatDateBR(fridayDate), month: mondayDate.getUTCMonth(), year: mondayDate.getUTCFullYear() };
          });


          // 8. Render Chart (Using single color scheme)
           const barColor = tailwind.config.theme.extend.colors.primary[400]+'B3'; // 70% opacity Blue
           const borderColor = tailwind.config.theme.extend.colors.primary[600];

          renderForecastChart(chartLabels, chartData, weekDates, [barColor], [borderColor]); // Pass colors as arrays
      }

      // --- UPDATED: Forecast Chart Rendering (Simplified color handling) ---
      function renderForecastChart(labels, data, weekDates, backgroundColors, borderColors) {
          const ctx = $chartCanvas?.getContext('2d'); if (!ctx) return;
          if (forecastChartInstance) { forecastChartInstance.destroy(); }

          // Use the passed colors, provide defaults if needed (expecting single color arrays now)
          const bgColor = backgroundColors?.[0] || tailwind.config.theme.extend.colors.primary[400]+'B3';
          const bdColor = borderColors?.[0] || tailwind.config.theme.extend.colors.primary[600];

          forecastChartInstance = new Chart(ctx, {
              type: 'bar',
              data: { labels: labels, datasets: [{ label: 'Previsão Seg-Sex', data: data, backgroundColor: bgColor, borderColor: bdColor, borderWidth: 1, hoverBackgroundColor: bgColor.replace('B3', 'E6'), hoverBorderColor: bdColor, borderRadius: 4, borderSkipped: false, barPercentage: 0.7, /* Adjusted for potentially fewer bars */ categoryPercentage: 0.8 }] },
              options: {
                  responsive: true, maintainAspectRatio: false,
                  layout: { padding: { top: 25 } },
                  scales: {
                      y: { beginAtZero: true, ticks: { color: tailwind.config.theme.extend.colors.slate[600], font: { size: 10 }, callback: function(value) { return formatCurrencyShort(value); } }, grid: { color: tailwind.config.theme.extend.colors.slate[200], drawTicks: false }, border: { display: false } },
                      x: { ticks: { color: tailwind.config.theme.extend.colors.slate[600], font: { size: 9 } }, grid: { display: false }, border: { display: false } }
                  },
                  plugins: {
                      legend: { display: false },
                      tooltip: {
                          enabled: true, backgroundColor: tailwind.config.theme.extend.colors.slate[800]+'F0', titleColor: tailwind.config.theme.extend.colors.slate[100], bodyColor: tailwind.config.theme.extend.colors.slate[100], borderColor: tailwind.config.theme.extend.colors.slate[500], borderWidth: 1, padding: 10, cornerRadius: 4, displayColors: false, titleAlign: 'center', bodyAlign: 'center',
                          callbacks: {
                              title: function(tooltipItems) {
                                  const index = tooltipItems[0]?.dataIndex;
                                  if (index !== undefined && weekDates[index]) {
                                      const monthYear = `${MONTH_NAMES_SHORT[weekDates[index].month]}/${weekDates[index].year}`;
                                      return [monthYear, `Sem: ${weekDates[index].start} a ${weekDates[index].end}`];
                                  }
                                  return tooltipItems[0]?.label || '';
                              },
                              label: function(context) { if (context.parsed.y !== null) { return formatCurrency(context.parsed.y); } return ''; }
                          }
                      },
                      datalabels: { display: context => context.dataset.data[context.dataIndex] > 0, anchor: 'end', align: 'top', offset: 4, color: tailwind.config.theme.extend.colors.slate[700], font: { size: 8, weight: '500' }, formatter: (value, context) => { return formatCurrencyShort(value); } }
                  },
                  interaction: { mode: 'index', intersect: false },
              }
          });
      }

      // renderDueListView() (No changes needed)
      function renderDueListView() { $dueListItems.innerHTML = ''; $dueListErrorMsg.classList.add('hidden'); $dueListItems.querySelector('#due-list-loading-message')?.remove(); $dueListChartError?.classList.add('hidden'); $dueListCurrentDate.textContent = `Data de Hoje: ${formatDateBR(new Date())}`; $dueListTotalAll.textContent = `Total Geral (c/ Vencimento): ${formatCurrency(0)}`; if (!headersTable || headersTable.length === 0 || !sheetRowsTable) { renderDueListError("Dados da Lista de Vencimentos não carregados."); $dueListChartWrapper?.classList.add('hidden'); return; } const findIndex = (regex, headers) => headers.findIndex(h => h && regex.test(h.toLowerCase())); const vencIndex = findIndex(vencRegex, headersTable); const valorIndex = findIndex(valorRegex, headersTable); const descIndex = findIndex(dueListDescRegex, headersTable); if (vencIndex === -1 || valorIndex === -1) { renderDueListError("Erro: Colunas Vencimento/Valor não encontradas (Fonte 2)."); $dueListChartWrapper?.classList.add('hidden'); if (dueListChartInstance) { dueListChartInstance.destroy(); dueListChartInstance = null; } return; } if (descIndex === -1) { console.warn("Coluna Descrição não encontrada (Fonte 2)."); } let totalAllDueValue = 0; const allDueItems = []; sheetRowsTable.forEach((row, rowIndex) => { const vencValueRaw = row[vencIndex]; const vencDate = parseDateValue(vencValueRaw); if (vencDate && !isNaN(vencDate.getTime())) { const valor = getNumericValue(row[valorIndex]); if (isNaN(valor)) return; const description = descIndex !== -1 ? (row[descIndex] || 'Item s/ desc.') : `Item ${rowIndex + 1}`; allDueItems.push({ description: description, value: valor, dueDate: vencDate }); totalAllDueValue += valor; } else if (vencValueRaw && typeof vencValueRaw === 'string' && vencValueRaw.trim() !== '') { console.warn(`Não foi possível parsear data na linha ${rowIndex + 1} (Fonte 2):`, vencValueRaw); } }); allDueItems.sort((a, b) => a.dueDate.getTime() - b.dueDate.getTime()); $dueListTotalAll.textContent = `Total Geral (c/ Vencimento): ${formatCurrency(totalAllDueValue)}`; if (allDueItems.length === 0) { $dueListItems.innerHTML = '<p class="no-items-message">Nenhum lançamento com data de vencimento válido encontrado.</p>'; $dueListChartWrapper?.classList.add('hidden'); if (dueListChartInstance) { dueListChartInstance.destroy(); dueListChartInstance = null; } } else { $dueListItems.querySelector('#due-list-loading-message')?.remove(); $dueListErrorMsg.classList.add('hidden'); const ul = document.createElement('ul'); allDueItems.forEach(item => { const li = document.createElement('li'); const formattedDueDate = formatDateBR(item.dueDate); li.innerHTML = `<div class="item-info"><span class="item-description" title="${item.description}">${item.description}</span><span class="item-due-date">Venc: ${formattedDueDate}</span></div><span class="item-value">${formatCurrency(item.value)}</span>`; ul.appendChild(li); }); $dueListItems.appendChild(ul); prepareAndRenderDueListChart(allDueItems); } }

      // prepareAndRenderDueListChart() (No changes needed)
      function prepareAndRenderDueListChart(items) { if (!items || items.length === 0) { $dueListChartWrapper?.classList.add('hidden'); if (dueListChartInstance) { dueListChartInstance.destroy(); dueListChartInstance = null; } return; } try { const monthlyTotals = {}; items.forEach(item => { if (!item.dueDate || isNaN(item.dueDate.getTime())) return; const year = item.dueDate.getUTCFullYear(); const month = item.dueDate.getUTCMonth(); const monthYearKey = `${year}-${padZero(month)}`; if (!monthlyTotals[monthYearKey]) { monthlyTotals[monthYearKey] = 0; } monthlyTotals[monthYearKey] += item.value; }); const sortedKeys = Object.keys(monthlyTotals).sort(); const chartLabels = sortedKeys.map(key => { const [year, month] = key.split('-'); const tempDate = new Date(Date.UTC(parseInt(year), parseInt(month), 1)); return formatMonthYearLabel(tempDate); }); const chartData = sortedKeys.map(key => monthlyTotals[key]); renderDueListChart(chartLabels, chartData); $dueListChartWrapper?.classList.remove('hidden'); $dueListChartError?.classList.add('hidden'); } catch (error) { console.error("Erro ao preparar dados para o gráfico mensal:", error); $dueListChartWrapper?.classList.add('hidden'); $dueListChartError.textContent = 'Erro ao processar dados do gráfico mensal.'; $dueListChartError?.classList.remove('hidden'); if (dueListChartInstance) { dueListChartInstance.destroy(); dueListChartInstance = null; } } }

      // renderDueListChart() (No changes needed)
      function renderDueListChart(labels, data) { const ctx = $dueListChartCanvas?.getContext('2d'); if (!ctx) return; if (dueListChartInstance) { dueListChartInstance.destroy(); } const chartColors = { backgroundColor: 'rgba(77, 171, 247, 0.6)', borderColor: 'rgba(51, 154, 240, 1)', hoverBackgroundColor: 'rgba(77, 171, 247, 0.8)', hoverBorderColor: tailwind.config.theme.extend.colors.primary[500], textColor: tailwind.config.theme.extend.colors.slate[700], gridColor: 'rgba(203, 213, 225, 0.5)', tooltipBg: 'rgba(51, 65, 85, 0.95)', tooltipTitleColor: '#e2e8f0', tooltipBodyColor: '#e2e8f0' }; dueListChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Total Vencimento', data: data, backgroundColor: chartColors.backgroundColor, borderColor: chartColors.borderColor, borderWidth: 1, hoverBackgroundColor: chartColors.hoverBackgroundColor, hoverBorderColor: chartColors.hoverBorderColor, borderRadius: 4, borderSkipped: false, barPercentage: 0.6, categoryPercentage: 0.7 }] }, options: { responsive: true, maintainAspectRatio: false, layout: { padding: { top: 25 } }, scales: { y: { beginAtZero: true, ticks: { color: chartColors.textColor, font: { size: 10 }, callback: function(value) { return formatCurrencyShort(value); } }, grid: { color: chartColors.gridColor, drawTicks: false }, border: { display: false } }, x: { ticks: { color: chartColors.textColor, font: { size: 9 } }, grid: { display: false }, border: { display: false } } }, plugins: { legend: { display: false }, tooltip: { enabled: true, backgroundColor: chartColors.tooltipBg, titleColor: chartColors.tooltipTitleColor, bodyColor: chartColors.tooltipBodyColor, borderColor: chartColors.borderColor, borderWidth: 1, padding: 8, cornerRadius: 4, displayColors: false, callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += formatCurrency(context.parsed.y); } return label; } } }, datalabels: { display: context => context.dataset.data[context.dataIndex] > 0, anchor: 'end', align: 'top', offset: 4, color: chartColors.textColor, font: { size: 8, weight: '500' }, formatter: (value, context) => { return formatCurrencyShort(value); } } } , interaction: { mode: 'index', intersect: false }, } }); }

      // renderDueListError() (No changes needed)
       function renderDueListError(message) { const ul = $dueListItems.querySelector('ul'); if(ul) ul.remove(); $dueListItems.querySelector('#due-list-loading-message')?.remove(); $dueListErrorMsg.textContent = message; $dueListErrorMsg.classList.remove('hidden'); $dueListTotalAll.textContent = 'Erro ao calcular total'; $dueListChartWrapper?.classList.add('hidden'); if (dueListChartInstance) { dueListChartInstance.destroy(); dueListChartInstance = null; } }

      // updateHeaderInfo() (No changes needed)
      function updateHeaderInfo() { const findIndex = (regex, headers) => headers.findIndex(h => h && regex.test(h.toLowerCase())); const valorIndex = findIndex(valorRegex, headersReports); if (valorIndex === -1 || !sheetRowsReports || headersReports.length === 0) { $grandTotalHeader.textContent = 'Total Geral: Erro'; return; } if (sheetRowsReports.length > 0) { const grandTotal = sheetRowsReports.reduce((sum, row) => sum + getNumericValue(row[valorIndex]), 0); $grandTotalHeader.textContent = `Total Geral: ${formatCurrency(grandTotal)}`; } else { $grandTotalHeader.textContent = 'Total Geral: R$ 0,00'; } }

      // --- View Switching Logic ---
      function switchView(viewToShow) { $reportCardsWrapper.classList.add('hidden'); $chartContainer.classList.add('hidden'); $dueListContainer.classList.add('hidden'); $viewToggleReportsBtn.classList.remove('active'); $viewToggleChartBtn.classList.remove('active'); $viewToggleDueListBtn.classList.remove('active'); if (viewToShow === 'reports') { $reportCardsWrapper.classList.remove('hidden'); $viewToggleReportsBtn.classList.add('active'); if(isLoaded) buildReportCards(); } else if (viewToShow === 'chart') { $chartContainer.classList.remove('hidden'); $viewToggleChartBtn.classList.add('active'); if (isLoaded) prepareAndRenderForecastChart(); requestAnimationFrame(() => { forecastChartInstance?.resize(); }); } else if (viewToShow === 'dueList') { $dueListContainer.classList.remove('hidden'); $viewToggleDueListBtn.classList.add('active'); if (isLoaded && headersTable.length > 0) { renderDueListView(); } else if(isLoaded) { renderDueListError("Dados para a lista de vencimentos não disponíveis."); } requestAnimationFrame(() => { dueListChartInstance?.resize(); }); } }

      // --- Event Listeners ---
      $manualRefreshBtn.onclick = loadData; $viewToggleReportsBtn.onclick = () => switchView('reports'); $viewToggleChartBtn.onclick = () => switchView('chart'); $viewToggleDueListBtn.onclick = () => switchView('dueList');

      // --- Initialization ---
      switchView('reports'); loadData(); setInterval(loadData, REFRESH_INTERVAL);

    </script>
    </body>
</html>
